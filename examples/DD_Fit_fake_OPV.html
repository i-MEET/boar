<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BOAR with SIMsalabim &mdash; boar 1.0.10 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=eafc0fe6" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css?v=61a4c737" />
      <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css?v=f4aeca0c" />
      <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css?v=2082cf3c" />
      <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/rtd_sphinx_search.min.css" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=377e76b0"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../_static/copybutton.js?v=f281be69"></script>
        <script src="../_static/js/rtd_search_config.js"></script>
        <script src="../_static/js/rtd_sphinx_search.min.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="BOAR with SIMsalabim Organic Photovoltaic (OPV) example" href="DD_Fit_real_OPV.html" />
    <link rel="prev" title="Change Log" href="../change_log.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            boar
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting started:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html#additional-necessary-installs-for-the-agents">Additional necessary installs for the agents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html#disclaimer">Disclaimer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references.html">Scientific publications based on the BOAR project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../change_log.html">Change Log</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Model fitting examples:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">BOAR with SIMsalabim</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Define-the-free-parameters-to-be-optimized">Define the free parameters to be optimized</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Check-the-structure-of-the-device-for-SIMsalabim">Check the structure of the device for SIMsalabim</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Prepare-fake-data-for-fitting">Prepare fake data for fitting</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Start-the-optimization">Start the optimization</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="DD_Fit_real_OPV.html">BOAR with SIMsalabim Organic Photovoltaic (OPV) example</a></li>
<li class="toctree-l1"><a class="reference internal" href="TAS_fit_BT_model_fake.html">BOAR for TAS fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="MO_TrPL_TrMC.html">Multi-Objective Fitting of TrPL and TrMC Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gallery_fitting.html">Notebooks gallery</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Optimization and DoE examples:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="BOAR_Exp.html">Design of Experiments to optimize perovskite solar cells efficiency</a></li>
<li class="toctree-l1"><a class="reference internal" href="BOAR_Exp_MO.html">Multi-objective optimization for perovskite material composition</a></li>
<li class="toctree-l1"><a class="reference internal" href="TM_AVT_Jsc_MO_custom_func.html">Custom evaluate function for Multi-Objective Optimization - Transfer Matrix example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gallery_Opti_DoE.html">Notebooks gallery</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">BOAR API:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">boar</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">boar</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">BOAR with SIMsalabim</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/i-MEET/boar/blob/main/docs/source/examples/DD_Fit_fake_OPV.ipynb" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="BOAR-with-SIMsalabim">
<h1>BOAR with SIMsalabim<a class="headerlink" href="#BOAR-with-SIMsalabim" title="Link to this heading"></a></h1>
<p>Version 1.0.0 (c) Vincent M. Le Corre, Larry Lueer, i-MEET 2021-2023</p>
<div class="line-block">
<div class="line">This notebook is made to use BOAR in combination with drift-diffusion modeling to fit of ‘fake’ JV curves.</div>
<div class="line">To perform the drift-diffusion simulation in the background we use the open-source program <a class="reference external" href="https://github.com/kostergroup/SIMsalabim">SIMsalabim</a>, for more information about SIMsalabim please check the <a class="reference external" href="https://github.com/kostergroup/SIMsalabim">GitHub repository</a></div>
<div class="line">Make sure you have SIMsalabim installed before running this Notebook.</div>
<div class="line">Here we are fitting some ‘fake’ data that are generated by the drift-diffusion model.</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Activate matplotlib widgets</span>
<span class="c1"># %matplotlib inline</span>
<span class="c1"># comment the next line if you are on the jupyterhub server</span>
<span class="c1"># %matplotlib widget</span>
<span class="c1"># %matplotlib notebook</span>

<span class="c1"># Import libraries</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span><span class="nn">os</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">default_rng</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span> <span class="c1"># comment this out to see warnings</span>

<span class="c1"># Import boar package</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;../&#39;</span><span class="p">))</span> <span class="c1"># add directory containing boar package to path</span>
<span class="kn">from</span> <span class="nn">boar</span> <span class="kn">import</span> <span class="o">*</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define path to SIMsalabim</span>
<span class="n">curr_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
<span class="n">parent_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">curr_dir</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">))</span> <span class="c1"># path to the parent directory</span>
<span class="n">path2simu</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">,</span> <span class="s1">&#39;SIMsalabim&#39;</span><span class="p">,</span><span class="s1">&#39;SimSS&#39;</span><span class="p">)</span> <span class="c1"># path to the SIMsalabim directory</span>
<span class="c1"># Directory where the results are stored</span>
<span class="n">res_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">curr_dir</span><span class="p">,</span><span class="s1">&#39;temp&#39;</span><span class="p">)</span> <span class="c1"># absolute path to the results directory (note that this will be delete in the last cell of this notebook)</span>
<span class="n">dev_par_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">,</span><span class="s1">&#39;Example_Data&#39;</span><span class="p">,</span><span class="s1">&#39;Data_test&#39;</span><span class="p">,</span><span class="s1">&#39;device_parameters_fake_OPV.txt&#39;</span><span class="p">)</span> <span class="c1"># absolute path to the device parameter file (here we use a fake OPV device for illustration purposes)</span>
</pre></div>
</div>
</div>
<section id="Define-the-free-parameters-to-be-optimized">
<h2>Define the free parameters to be optimized<a class="headerlink" href="#Define-the-free-parameters-to-be-optimized" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># define Fitparameters</span>
<span class="n">True_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;kdirect&#39;</span><span class="p">:</span><span class="mf">5e-18</span><span class="p">,</span><span class="s1">&#39;mun_0&#39;</span><span class="p">:</span><span class="mf">2e-8</span><span class="p">,</span><span class="s1">&#39;mup_0&#39;</span><span class="p">:</span><span class="mf">8e-8</span><span class="p">,</span><span class="s1">&#39;Nc&#39;</span><span class="p">:</span><span class="mf">5e26</span><span class="p">,</span><span class="s1">&#39;Gehp&#39;</span><span class="p">:</span><span class="mf">1.28e28</span><span class="p">,</span><span class="s1">&#39;W_L&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span><span class="c1">#,&#39;Rseries&#39;:3e-4,&#39;Bulk_tr&#39;:1e20,&#39;Gehp&#39;:1.28e28}</span>
<span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">kdirect</span> <span class="o">=</span> <span class="n">Fitparam</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;kdirect&#39;</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">True_params</span><span class="p">[</span><span class="s1">&#39;kdirect&#39;</span><span class="p">]</span> <span class="p">,</span> <span class="n">relRange</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">lims</span><span class="o">=</span><span class="p">[</span><span class="mf">1e-18</span><span class="p">,</span><span class="mf">1e-16</span><span class="p">],</span><span class="n">range_type</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span><span class="n">optim_type</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span><span class="n">display_name</span><span class="o">=</span><span class="s1">&#39;k$_</span><span class="si">{2}</span><span class="s1">$&#39;</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="s1">&#39;m$^</span><span class="si">{3}</span><span class="s1">$ s$^{-1}$&#39;</span><span class="p">)</span>
<span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kdirect</span><span class="p">)</span>

<span class="n">mun_0</span> <span class="o">=</span> <span class="n">Fitparam</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;mun_0&#39;</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">True_params</span><span class="p">[</span><span class="s1">&#39;mun_0&#39;</span><span class="p">]</span> <span class="p">,</span> <span class="n">relRange</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">lims</span><span class="o">=</span><span class="p">[</span><span class="mf">1e-8</span><span class="p">,</span><span class="mf">1e-7</span><span class="p">],</span><span class="n">range_type</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span><span class="n">optim_type</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span><span class="n">display_name</span><span class="o">=</span><span class="s1">&#39;$\mu_n$&#39;</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="s1">&#39;m$^</span><span class="si">{2}</span><span class="s1">$ V$^{-1}$ s$^{-1}$&#39;</span><span class="p">)</span>
<span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mun_0</span><span class="p">)</span>

<span class="n">mup_0</span> <span class="o">=</span> <span class="n">Fitparam</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;mup_0&#39;</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">True_params</span><span class="p">[</span><span class="s1">&#39;mup_0&#39;</span><span class="p">]</span> <span class="p">,</span> <span class="n">relRange</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">lims</span><span class="o">=</span><span class="p">[</span><span class="mf">1e-8</span><span class="p">,</span><span class="mf">1e-7</span><span class="p">],</span><span class="n">range_type</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span><span class="n">optim_type</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span><span class="n">display_name</span><span class="o">=</span><span class="s1">&#39;$\mu_p$&#39;</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="s1">&#39;m$^</span><span class="si">{2}</span><span class="s1">$ V$^{-1}$ s$^{-1}$&#39;</span><span class="p">)</span>
<span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mup_0</span><span class="p">)</span>

<span class="n">params_true</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
</section>
<section id="Check-the-structure-of-the-device-for-SIMsalabim">
<h2>Check the structure of the device for SIMsalabim<a class="headerlink" href="#Check-the-structure-of-the-device-for-SIMsalabim" title="Link to this heading"></a></h2>
<p>Here we check the structure of the device for SIMsalabim and you can adjust the parameters if needed.</p>
<p>For example, if you want to change the thickness of the active layer (AL) you can do this by changing the value of the variable <code class="docutils literal notranslate"><span class="pre">L</span></code> in the cell below. To do so you need to update the value of the variable ParFileDic[‘L’] and set MakeUpdate to True.</p>
<div class="line-block">
<div class="line">By convention LTL is the ETL and RTL is the HTL.</div>
<div class="line">Note that L is the <strong>total</strong> thickness of the ETL, HTL and active layer, so if you want to change the thickness of the active layer you need to subtract the thickness of the ETL and HTL from the total thickness. Such that:</div>
</div>
<p><span class="math notranslate nohighlight">\(L_{AL} = L - L_{LTL} - L_{RTL}\)</span></p>
<p>To check the name of the parameters in SIMsalabim please refer to the <a class="reference external" href="https://github.com/kostergroup/SIMsalabim">SIMsalabim documentation</a>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Vizualize the stack defined for the simulation</span>
<span class="n">check_SIMsalabim_input</span> <span class="o">=</span> <span class="kc">True</span>
<span class="c1"># from boar.SIMsalabim_utils.MakeDevParFile import *</span>
<span class="c1"># from boar.SIMsalabim_utils.GetInputPar import *</span>

<span class="k">if</span> <span class="n">check_SIMsalabim_input</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">boar.SIMsalabim_utils.PlotInputPar</span> <span class="kn">import</span> <span class="o">*</span>
    <span class="c1"># Load Device parameters file and update parameters</span>
    <span class="n">ParFileDic</span> <span class="o">=</span> <span class="n">ReadParameterFile</span><span class="p">(</span><span class="n">dev_par_file</span><span class="p">)</span> <span class="c1"># read the parameters from the file</span>

    <span class="c1"># Change parameters in the dictionary</span>
    <span class="n">ParFileDic</span><span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="mf">100e-9</span>

    <span class="n">MakeUpdate</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># set to True to update the parameters in the file</span>
    <span class="k">if</span> <span class="n">MakeUpdate</span><span class="p">:</span>
        <span class="n">UpdateDevParFile</span><span class="p">(</span><span class="n">ParFileDic</span><span class="p">,</span> <span class="n">path2simu</span><span class="p">)</span> <span class="c1"># update the parameters in the file</span>

    <span class="c1"># Visualize the parameters</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
    <span class="n">plot_input_nrj_diag</span><span class="p">(</span><span class="n">ParFileDic</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">plot_input_mob</span><span class="p">(</span><span class="n">ParFileDic</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">plot_input_dens</span><span class="p">(</span><span class="n">ParFileDic</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">plot_input_SRH_lifetime</span><span class="p">(</span><span class="n">ParFileDic</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span><span class="n">y_unit</span><span class="o">=</span><span class="s1">&#39;ns&#39;</span><span class="p">,</span><span class="n">y2_unit</span><span class="o">=</span><span class="s1">&#39;cm&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_DD_Fit_fake_OPV_7_0.png" src="../_images/examples_DD_Fit_fake_OPV_7_0.png" />
</div>
</div>
</section>
<section id="Prepare-fake-data-for-fitting">
<h2>Prepare fake data for fitting<a class="headerlink" href="#Prepare-fake-data-for-fitting" title="Link to this heading"></a></h2>
<p>In the next block we create some fake data with some random noise and plot it.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># # create some fake data</span>
<span class="n">Nc</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># number of fake datasets</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span> <span class="c1"># voltage</span>
<span class="n">Gfrac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Gfrac, i.e. light intensity</span>

<span class="n">X_dimensions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Vext&#39;</span><span class="p">,</span><span class="s1">&#39;Gfrac&#39;</span><span class="p">]</span> <span class="c1"># dimensions of the X array</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">Gfrac</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">V</span> <span class="p">]</span> <span class="p">)</span> <span class="c1"># X array</span>
<span class="n">Xplot</span> <span class="o">=</span> <span class="n">Gfrac</span> <span class="c1"># X array for plotting</span>

<span class="c1"># Generate the fake data to fit</span>
<span class="n">degradation_run</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">True_paramsList</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># define the degradation of kdirect</span>
<span class="n">kvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">geomspace</span><span class="p">(</span><span class="mf">5e-18</span><span class="p">,</span><span class="mf">5e-17</span><span class="p">,</span><span class="n">Nc</span><span class="p">)</span> <span class="c1"># simulate degradation of kdirect</span>

<span class="n">dda</span> <span class="o">=</span> <span class="n">Drift_diffusion_agent</span><span class="p">(</span><span class="n">path2simu</span><span class="o">=</span><span class="n">path2simu</span><span class="p">)</span> <span class="c1"># instantiate the agent</span>

<span class="n">ys</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">True_vals</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">True_FOMs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">kval</span> <span class="ow">in</span> <span class="n">kvals</span><span class="p">:</span>
    <span class="n">kdirect</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">kval</span>
    <span class="n">True_paramsList</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;kdirect&#39;</span><span class="p">:</span><span class="n">kval</span><span class="p">})</span>
    <span class="n">True_params</span><span class="p">[</span><span class="s1">&#39;kdirect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kval</span>
    <span class="c1"># store the true values for plotting later</span>
    <span class="n">True_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">True_params</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

    <span class="n">y</span> <span class="o">=</span> <span class="n">dda</span><span class="o">.</span><span class="n">DriftDiffusion_relative</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">params</span><span class="p">,</span><span class="n">X_dimensions</span><span class="o">=</span><span class="n">X_dimensions</span><span class="p">,</span> <span class="n">max_jobs</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">dev_par_fname</span><span class="o">=</span><span class="n">dev_par_file</span><span class="p">)</span> <span class="c1"># simulate the data</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">default_rng</span><span class="p">()</span><span class="c1">#</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.9</span>
    <span class="c1">#noise = noise * X[:,1] # try this: higher T - higher noise</span>
    <span class="n">y</span><span class="o">+=</span><span class="n">noise</span> <span class="c1"># add some noise</span>
    <span class="n">ys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">y</span><span class="p">,</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Voltage [V]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Current Density [A m$^{-2}$]&#39;</span><span class="p">)</span>
<span class="c1"># save params list to be modified later to store true values</span>
<span class="n">params_true</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
<br/><br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_DD_Fit_fake_OPV_9_0.png" src="../_images/examples_DD_Fit_fake_OPV_9_0.png" />
</div>
</div>
</section>
<section id="Start-the-optimization">
<h2>Start the optimization<a class="headerlink" href="#Start-the-optimization" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit the datasets one by one</span>
<span class="n">pf</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># list to store the fit results</span>
<span class="n">mo</span> <span class="o">=</span> <span class="n">MultiObjectiveOptimizer</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span><span class="n">res_dir</span><span class="o">=</span><span class="n">res_dir</span><span class="p">)</span> <span class="c1"># instantiate the optimizer</span>

<span class="n">n_jobs</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">n_jobs_init</span> <span class="o">=</span> <span class="mi">25</span>
<span class="n">n_yscale</span><span class="o">=</span><span class="mi">2</span>
<span class="n">n_initial_points</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">n_BO</span> <span class="o">=</span> <span class="mi">60</span>
<span class="n">n_BO_warmstart</span> <span class="o">=</span> <span class="mi">60</span>

<span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ys</span><span class="p">):</span>
    <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;model&#39;</span><span class="p">:</span><span class="n">partial</span><span class="p">(</span><span class="n">dda</span><span class="o">.</span><span class="n">DriftDiffusion_relative</span><span class="p">,</span><span class="n">X_dimensions</span><span class="o">=</span><span class="n">X_dimensions</span><span class="p">,</span><span class="n">max_jobs</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">dev_par_fname</span><span class="o">=</span><span class="n">dev_par_file</span><span class="p">),</span><span class="s1">&#39;target_name&#39;</span><span class="p">:</span><span class="s1">&#39;JV&#39;</span><span class="p">,</span><span class="s1">&#39;data&#39;</span><span class="p">:{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span><span class="n">X</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">:</span><span class="n">y</span><span class="p">,</span>
                <span class="s1">&#39;X_dimensions&#39;</span><span class="p">:[</span><span class="s1">&#39;Vext&#39;</span><span class="p">,</span><span class="s1">&#39;Gfrac&#39;</span><span class="p">],</span><span class="s1">&#39;X_units&#39;</span><span class="p">:[</span><span class="s1">&#39;V&#39;</span><span class="p">,</span><span class="s1">&#39;sun&#39;</span><span class="p">],</span><span class="s1">&#39;y_dimension&#39;</span><span class="p">:</span><span class="s1">&#39;Current density&#39;</span><span class="p">,</span><span class="s1">&#39;y_unit&#39;</span><span class="p">:</span><span class="sa">r</span><span class="s1">&#39;$A/m²$&#39;</span><span class="p">},</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;target_weight&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>
    <span class="n">mo</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="n">target</span><span class="p">]</span>
    <span class="n">mo</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
    <span class="n">mo</span><span class="o">.</span><span class="n">warmstart</span> <span class="o">=</span> <span class="s1">&#39;collect_init&#39;</span> <span class="k">if</span> <span class="n">ii</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;recall&#39;</span>
    <span class="c1"># mo.warmstart = &#39;None&#39;</span>
    <span class="n">mo</span><span class="o">.</span><span class="n">SaveOldXY2file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res_dir</span><span class="p">,</span><span class="s1">&#39;old_XY.json&#39;</span><span class="p">)</span> <span class="c1"># path to the file where old points are saved</span>
    <span class="n">mo</span><span class="o">.</span><span class="n">Path2OldXY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res_dir</span><span class="p">,</span><span class="s1">&#39;old_XY.json&#39;</span><span class="p">)</span> <span class="c1"># path to the file where old points are saved</span>

    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;check_improvement&#39;</span><span class="p">:</span><span class="s1">&#39;relax&#39;</span><span class="p">,</span><span class="s1">&#39;max_loop_no_improvement&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span><span class="s1">&#39;xtol&#39;</span><span class="p">:</span><span class="mf">1e-3</span><span class="p">,</span><span class="s1">&#39;ftol&#39;</span><span class="p">:</span><span class="mf">1e-3</span><span class="p">}</span><span class="c1">#,&#39;initial_point_generator&#39;:&#39;LHS&#39;}</span>
    <span class="n">kwargs_posterior</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Nres&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span><span class="s1">&#39;gaussfilt&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="s1">&#39;logscale&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s1">&#39;vmin&#39;</span><span class="p">:</span><span class="mf">1e-100</span><span class="p">,</span><span class="s1">&#39;zoom&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;min_prob&#39;</span><span class="p">:</span><span class="mf">1e-40</span><span class="p">,</span><span class="s1">&#39;clear_axis&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s1">&#39;True_values&#39;</span><span class="p">:</span><span class="n">True_vals</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span><span class="s1">&#39;show_points&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s1">&#39;savefig&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s1">&#39;figname&#39;</span><span class="p">:</span><span class="s1">&#39;param_posterior&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ii</span><span class="p">),</span><span class="s1">&#39;full_grid&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s1">&#39;randomize&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">}</span>
    <span class="n">kwargs_plot_obj</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;zscale&#39;</span><span class="p">:</span><span class="s1">&#39;linear&#39;</span><span class="p">}</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">optimize_sko_parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span><span class="n">n_yscale</span><span class="o">=</span><span class="n">n_yscale</span><span class="p">,</span> <span class="n">n_BO</span><span class="o">=</span><span class="n">n_BO</span><span class="p">,</span> <span class="n">n_initial_points</span> <span class="o">=</span> <span class="n">n_initial_points</span><span class="p">,</span><span class="n">n_BO_warmstart</span><span class="o">=</span><span class="n">n_BO_warmstart</span><span class="p">,</span><span class="n">n_jobs_init</span><span class="o">=</span><span class="n">n_jobs_init</span><span class="p">,</span><span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;soft_l1&#39;</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">base_estimator</span> <span class="o">=</span> <span class="s1">&#39;GP&#39;</span><span class="p">,</span><span class="n">show_objective_func</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">show_posterior</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">kwargs_posterior</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="p">,</span><span class="n">kwargs_plot_obj</span><span class="o">=</span><span class="n">kwargs_plot_obj</span><span class="p">,)</span>
    <span class="n">pf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">params</span><span class="p">))</span> <span class="c1"># collects optimized fitparameters</span>
    <span class="n">rrr</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span> <span class="c1"># the results dict of the last optimizer.tell()</span>


    <span class="c1">#get true parameters and make a params object</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params_true</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">True_paramsList</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span>
            <span class="n">param</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">True_paramsList</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

    <span class="c1"># plot the fit results</span>
    <span class="n">fit_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">kwargs_plot_res</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x_scaling&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;xaxis_label&#39;</span><span class="p">:</span><span class="s1">&#39;Voltage [V]&#39;</span><span class="p">,</span><span class="s1">&#39;xscale_type&#39;</span><span class="p">:</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span><span class="s1">&#39;y_scaling&#39;</span><span class="p">:</span><span class="mi">1</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span><span class="s1">&#39;yaxis_label&#39;</span><span class="p">:</span><span class="s1">&#39;Current density [mA cm$^2$]&#39;</span><span class="p">,</span><span class="s1">&#39;yscale_type&#39;</span><span class="p">:</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span><span class="s1">&#39;norm_data&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s1">&#39;delog&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s1">&#39;figsize&#39;</span><span class="p">:(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span><span class="s1">&#39;savefig&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s1">&#39;figname&#39;</span><span class="p">:</span><span class="s1">&#39;JV_fits_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ii</span><span class="p">),</span><span class="s1">&#39;figdir&#39;</span><span class="p">:</span><span class="s1">&#39;temp&#39;</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">num</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">targets</span><span class="p">):</span>
        <span class="n">kwargs_plot_res</span><span class="p">[</span><span class="s1">&#39;figname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res_dir</span><span class="p">,</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;target_name&#39;</span><span class="p">]</span><span class="o">+</span><span class="sa">f</span><span class="s1">&#39;_fit_</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">dda</span><span class="o">.</span><span class="n">plot_fit_res</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">mo</span><span class="o">.</span><span class="n">params</span><span class="p">,</span><span class="s1">&#39;Vext&#39;</span><span class="p">,</span><span class="n">xlim</span><span class="o">=</span><span class="p">[],</span><span class="n">ylim</span><span class="o">=</span><span class="p">[],</span><span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs_plot_res</span><span class="p">)</span>

        <span class="n">X</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;X&#39;</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
        <span class="n">X_dimensions</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;X_dimensions&#39;</span><span class="p">]</span>
        <span class="n">yfit</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">](</span><span class="n">X</span><span class="p">,</span><span class="n">mo</span><span class="o">.</span><span class="n">params</span><span class="p">,</span><span class="n">X_dimensions</span><span class="o">=</span><span class="n">X_dimensions</span><span class="p">)</span> <span class="c1"># get the best fits</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span> <span class="n">yfit</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">yfit</span><span class="p">),</span><span class="mi">1</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fit_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># prepare the data for saving</span>
    <span class="n">param_dict</span> <span class="o">=</span> <span class="n">dda</span><span class="o">.</span><span class="n">get_param_dict</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">params</span><span class="p">)</span> <span class="c1"># get fitparameters (and fixed ones) as dict</span>
    <span class="n">pout</span> <span class="o">=</span> <span class="p">[[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s1">.3E</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">pp</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">param_dict</span><span class="p">]</span> <span class="c1"># convert to list of lists</span>

    <span class="n">save_output</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">save_output</span><span class="p">:</span>
        <span class="c1"># produce output excel file with data, fitparameters and FOMs</span>
        <span class="n">fn_xlsx</span> <span class="o">=</span> <span class="s1">&#39;fits_results.xlsx&#39;</span>
        <span class="n">namecols</span> <span class="o">=</span> <span class="n">X_dimensions</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Jexp&#39;</span><span class="p">,</span><span class="s1">&#39;Jfit&#39;</span><span class="p">]</span>
        <span class="c1"># delete old file if it exists</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res_dir</span><span class="p">,</span><span class="n">fn_xlsx</span><span class="p">)):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res_dir</span><span class="p">,</span><span class="n">fn_xlsx</span><span class="p">))</span>

        <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res_dir</span><span class="p">,</span><span class="n">fn_xlsx</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">targets</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;target_name&#39;</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">tname</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;target_name&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tname</span> <span class="o">=</span> <span class="s1">&#39;data&#39;</span>
                <span class="n">namecols</span> <span class="o">=</span> <span class="n">X_dimensions</span> <span class="o">+</span> <span class="p">[</span><span class="n">tname</span><span class="o">+</span><span class="s1">&#39;_exp&#39;</span><span class="p">,</span><span class="n">tname</span><span class="o">+</span><span class="s1">&#39;_fit&#39;</span><span class="p">]</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">fit_results</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">columns</span><span class="o">=</span><span class="n">namecols</span><span class="p">)</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">sheet_name</span> <span class="o">=</span> <span class="n">tname</span><span class="o">+</span><span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pout</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">param_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">sheet_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;params&#39;</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "5dce270481ab45a88a8cf29698943640", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Starting with initial points
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "aeea92ccef2643e69e030910b990dbf4", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Initial points done in 11.37 s
Starting with BO
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "87c318f74d9f4a0f852dd6a85dbddc69", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
BO done in 146.52 s
Ground truth minimum at: [-17.3032731357855, -7.700143892096901, -7.091992000697518] with function value: 0.13506055772527503
Minimum of surrogate function: [-17.303273330240792, -7.700143956914993, -7.0919918671538245] with function value 0.13368151919531712
Sampling for posterior distribution done in  0.09167170524597168 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_DD_Fit_fake_OPV_11_6.png" src="../_images/examples_DD_Fit_fake_OPV_11_6.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_DD_Fit_fake_OPV_11_7.png" src="../_images/examples_DD_Fit_fake_OPV_11_7.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot the 2D posterior</span>
<span class="n">mo</span><span class="o">.</span><span class="n">marginal_posterior_2D</span><span class="p">(</span><span class="s1">&#39;mun_0&#39;</span><span class="p">,</span><span class="s1">&#39;mup_0&#39;</span><span class="p">,</span><span class="n">points</span><span class="o">=</span><span class="n">mo</span><span class="o">.</span><span class="n">points</span><span class="p">,</span><span class="n">logscale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">Nres</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">Ninteg</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mf">1e-40</span><span class="p">,</span><span class="n">True_values</span><span class="o">=</span><span class="n">True_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_DD_Fit_fake_OPV_12_0.png" src="../_images/examples_DD_Fit_fake_OPV_12_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mo</span><span class="o">.</span><span class="n">marginal_posterior_1D</span><span class="p">(</span><span class="s1">&#39;mun_0&#39;</span><span class="p">,</span><span class="n">logscale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">Nres</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">Ninteg</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mf">1e-40</span><span class="p">,</span><span class="n">True_values</span><span class="o">=</span><span class="n">True_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_DD_Fit_fake_OPV_13_0.png" src="../_images/examples_DD_Fit_fake_OPV_13_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(1.994601346585351e-08,
 (1.994601346585351e-08, 1.994601346585351e-08),
 [-18.0, -8.0, -8.0],
 [-16.0, -7.0, -7.0])
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot the parameters evolution</span>
<span class="n">param_plot</span> <span class="o">=</span> <span class="n">dda</span><span class="o">.</span><span class="n">plot_params</span><span class="p">(</span><span class="n">pf</span><span class="p">,</span><span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;savefig&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s1">&#39;figname&#39;</span><span class="p">:</span><span class="s1">&#39;plot_param&#39;</span><span class="p">,</span><span class="s1">&#39;figdir&#39;</span><span class="p">:</span><span class="s1">&#39;temp&#39;</span><span class="p">,</span><span class="s1">&#39;nrows&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;ncols&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="s1">&#39;figsize&#39;</span><span class="p">:(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">)})</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_DD_Fit_fake_OPV_14_0.png" src="../_images/examples_DD_Fit_fake_OPV_14_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Clean output files from simulation folders</span>
<span class="kn">from</span> <span class="nn">boar.SIMsalabim_utils.CleanFolder</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">Do_Cleaning</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Careful, this will delete all files in the folder</span>
<span class="k">if</span> <span class="n">Do_Cleaning</span><span class="p">:</span>
    <span class="n">clean_up_output</span><span class="p">(</span><span class="s1">&#39;tj&#39;</span><span class="p">,</span><span class="n">path2simu</span><span class="p">)</span>
    <span class="n">clean_up_output</span><span class="p">(</span><span class="s1">&#39;tVG&#39;</span><span class="p">,</span><span class="n">path2simu</span><span class="p">)</span>
    <span class="n">clean_up_output</span><span class="p">(</span><span class="s1">&#39;JV&#39;</span><span class="p">,</span><span class="n">path2simu</span><span class="p">)</span>
    <span class="n">clean_up_output</span><span class="p">(</span><span class="s1">&#39;Var&#39;</span><span class="p">,</span><span class="n">path2simu</span><span class="p">)</span>
    <span class="n">clean_up_output</span><span class="p">(</span><span class="s1">&#39;scPars&#39;</span><span class="p">,</span><span class="n">path2simu</span><span class="p">)</span>
    <span class="n">clean_up_output</span><span class="p">(</span><span class="s1">&#39;Str4Parallel&#39;</span><span class="p">,</span><span class="n">path2simu</span><span class="p">)</span>
    <span class="n">clean_up_output</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">,</span><span class="n">path2simu</span><span class="p">)</span>
    <span class="c1"># os.remove(mo.path2oldxy) # remove the old_xy.json file if it exists</span>
    <span class="c1"># delete warmstart folder if it exists</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span><span class="s1">&#39;warmstart/&#39;</span><span class="p">)):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span><span class="s1">&#39;warmstart/&#39;</span><span class="p">))</span>
    <span class="c1"># delete temp folder if it exists</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">res_dir</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">res_dir</span><span class="p">)</span>
<br/><br/></pre></div>
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../change_log.html" class="btn btn-neutral float-left" title="Change Log" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="DD_Fit_real_OPV.html" class="btn btn-neutral float-right" title="BOAR with SIMsalabim Organic Photovoltaic (OPV) example" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Vincent M. Le Corre, Larry Lüer.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>