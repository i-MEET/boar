<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>boar.core.optimization_botorch &mdash; boar 1.0.10 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=eafc0fe6" />
      <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css?v=61a4c737" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-binder.css?v=f4aeca0c" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/rtd_sphinx_search.min.css" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=377e76b0"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../../../_static/copybutton.js?v=f281be69"></script>
        <script src="../../../_static/js/rtd_search_config.js"></script>
        <script src="../../../_static/js/rtd_sphinx_search.min.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            boar
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting started:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html#additional-necessary-installs-for-the-agents">Additional necessary installs for the agents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html#disclaimer">Disclaimer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../references.html">Scientific publications based on the BOAR project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../change_log.html">Change Log</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Model fitting examples:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/DD_Fit_fake_OPV.html">BOAR with SIMsalabim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/DD_Fit_real_OPV.html">BOAR with SIMsalabim Organic Photovoltaic (OPV) example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/TAS_fit_BT_model_fake.html">BOAR for TAS fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/MO_TrPL_TrMC.html">Multi-Objective Fitting of TrPL and TrMC Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gallery_fitting.html">Notebooks gallery</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Optimization and DoE examples:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/BOAR_Exp.html">Design of Experiments to optimize perovskite solar cells efficiency</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/BOAR_Exp_MO.html">Multi-objective optimization for perovskite material composition</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/TM_AVT_Jsc_MO_custom_func.html">Custom evaluate function for Multi-Objective Optimization - Transfer Matrix example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gallery_Opti_DoE.html">Notebooks gallery</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">BOAR API:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">boar</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">boar</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">boar.core.optimization_botorch</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for boar.core.optimization_botorch</h1><div class="highlight"><pre>
<span></span><span class="c1">######################################################################</span>
<span class="c1">################ MultiObjectiveOptimizer class #######################</span>
<span class="c1">######################################################################</span>
<span class="c1"># Authors: </span>
<span class="c1"># Larry Lueer (https://github.com/larryluer)</span>
<span class="c1"># Vincent M. Le Corre (https://github.com/VMLC-PV)</span>
<span class="c1"># (c) i-MEET, University of Erlangen-Nuremberg, 2021-2022-2023 </span>

<span class="c1"># Import libraries</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span><span class="nn">json</span><span class="o">,</span><span class="nn">copy</span><span class="o">,</span><span class="nn">warnings</span><span class="o">,</span><span class="nn">matplotlib</span><span class="o">,</span><span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tnrange</span><span class="p">,</span> <span class="n">tqdm_notebook</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span> <span class="k">as</span> <span class="n">sp_minimize</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">logsumexp</span>
<span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="kn">import</span> <span class="n">GridSpec</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">LogNorm</span>
<span class="kn">from</span> <span class="nn">matplotlib.cm</span> <span class="kn">import</span> <span class="n">ScalarMappable</span>
<span class="c1"># sns.set_theme(style=&quot;ticks&quot;)</span>
<span class="c1"># import ray</span>
<span class="c1"># Import BOtorch and Ax libraries</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">ax</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">ax.service.ax_client</span> <span class="kn">import</span> <span class="n">AxClient</span>
<span class="kn">from</span> <span class="nn">ax.service.utils.instantiation</span> <span class="kn">import</span> <span class="n">ObjectiveProperties</span>
<span class="kn">from</span> <span class="nn">ax</span> <span class="kn">import</span> <span class="n">Data</span><span class="p">,</span> <span class="n">Experiment</span><span class="p">,</span> <span class="n">ParameterType</span><span class="p">,</span> <span class="n">RangeParameter</span><span class="p">,</span> <span class="n">SearchSpace</span>
<span class="kn">from</span> <span class="nn">ax.modelbridge.generation_strategy</span> <span class="kn">import</span> <span class="n">GenerationStep</span><span class="p">,</span> <span class="n">GenerationStrategy</span>
<span class="kn">from</span> <span class="nn">ax.modelbridge.registry</span> <span class="kn">import</span> <span class="n">Models</span>
<span class="kn">from</span> <span class="nn">ax.core.metric</span> <span class="kn">import</span> <span class="n">Metric</span>
<span class="kn">from</span> <span class="nn">ax.metrics.noisy_function</span> <span class="kn">import</span> <span class="n">NoisyFunctionMetric</span>
<span class="kn">from</span> <span class="nn">ax.service.utils.report_utils</span> <span class="kn">import</span> <span class="n">exp_to_df</span>
<span class="kn">from</span> <span class="nn">ax.core.observation</span> <span class="kn">import</span> <span class="n">ObservationFeatures</span>
<span class="c1"># from ax.runners.synthetic import SyntheticRunner</span>
<span class="c1"># from ax.modelbridge.factory import get_MOO_EHVI, get_MOO_PAREGO, get_MOO_NEHVI # Factory methods for creating multi-objective optimization modesl.</span>

<span class="c1"># Analysis utilities, including a method to evaluate hypervolumes</span>
<span class="kn">from</span> <span class="nn">ax.modelbridge.modelbridge_utils</span> <span class="kn">import</span> <span class="n">observed_hypervolume</span>
<span class="kn">from</span> <span class="nn">ax.modelbridge.torch</span> <span class="kn">import</span> <span class="n">infer_objective_thresholds</span>

<span class="c1"># For global stopping strategies</span>
<span class="kn">from</span> <span class="nn">ax.global_stopping.strategies.base</span> <span class="kn">import</span> <span class="n">BaseGlobalStoppingStrategy</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="nn">ax.core.experiment</span> <span class="kn">import</span> <span class="n">Experiment</span>
<span class="kn">from</span> <span class="nn">ax.core.base_trial</span> <span class="kn">import</span> <span class="n">TrialStatus</span>
<span class="kn">from</span> <span class="nn">ax.global_stopping.strategies.improvement</span> <span class="kn">import</span> <span class="n">constraint_satisfaction</span>



<span class="c1"># Import boar libraries</span>
<span class="kn">from</span> <span class="nn">boar.core.optimizer</span> <span class="kn">import</span> <span class="n">BoarOptimizer</span> <span class="c1"># import the base class</span>


<div class="viewcode-block" id="MooBOtorch">
<a class="viewcode-back" href="../../../boar.core.html#boar.core.optimization_botorch.MooBOtorch">[docs]</a>
<span class="k">class</span> <span class="nc">MooBOtorch</span><span class="p">(</span><span class="n">BoarOptimizer</span><span class="p">):</span>
    <span class="c1"># a class for multi-objective optimization</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">params</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">parameter_constraints</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">warmstart</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Path2OldXY</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">SaveOldXY2file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">res_dir</span> <span class="o">=</span> <span class="s1">&#39;temp&#39;</span><span class="p">,</span> <span class="n">evaluate_custom</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">parallel</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialization routine</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        targets : list of dict, optional</span>
<span class="sd">            List of Dictionaries with the following keys:  </span>

<span class="sd">                &#39;model&#39;: a pointer to a function y = f(X) where X has m dimensions  </span>
<span class="sd">                &#39;data&#39;: dictionary with keys  </span>
<span class="sd">                &#39;X&#39;:ndarray with shape (n,m) where n is the number of evaluations for X  </span>
<span class="sd">                &#39;y&#39;:ndarray with shape (n,)  </span>
<span class="sd">                &#39;X_dimensions&#39;: list of string: the names of the dimensions in X  </span>
<span class="sd">                &#39;X_units&#39;: list of string: the units of the dimensions in X  </span>
<span class="sd">                &#39;y_dimension&#39;: string: the name of the dimension y  </span>
<span class="sd">                &#39;y_unit&#39;: string: the unit of the dimension y  </span>
<span class="sd">                &#39;params&#39;: list of Fitparam() objects, by default None  </span>
<span class="sd">        warmstart : str, optional</span>
<span class="sd">                &#39;None&#39;, &#39;collect&#39;, &#39;collect_init&#39;, &#39;collect_BO&#39;, &#39;recall&#39; or &#39;collect&amp;recall&#39;, by default None  </span>

<span class="sd">                    if &#39;None&#39; does not store results  </span>
<span class="sd">                    if &#39;collect&#39; stores all results  </span>
<span class="sd">                    if &#39;collect_init&#39; stores results from the initial sampling only. NOTE: In reality it collects the n_jobs\*(n_initial_points + n_BO)/n_initial_points first point, so you may get some of the first few BO points depending on n_jobs  </span>
<span class="sd">                    if collect_BO&#39; stores results from the Bayesian Optimization only  </span>
<span class="sd">                    if &#39;recall&#39; recalls results  </span>
<span class="sd">                    if &#39;collect&amp;recall&#39; stores and recalls results  </span>
<span class="sd">        Path2OldXY : str, optional</span>
<span class="sd">            full path to the json file containing the self.old_xy results to be loaded, by default None</span>
<span class="sd">        SaveOldXY2file : str, optional</span>
<span class="sd">            full path to the json file where the new self.old_xy results will be saved if it is None then we do not save the data, by default None</span>
<span class="sd">        res_dir : str, optional</span>
<span class="sd">            directory where the results will be saved, by default &#39;temp&#39;</span>
<span class="sd">        evaluate_custom : function, optional</span>
<span class="sd">            use a custom evaluation function instead of the default one, this is useful when the same model is used for different targets, by default None</span>
<span class="sd">        parallel : bool, optional</span>
<span class="sd">            use parallelization, if False n_jobs can still be &gt; 1 but the evaluation will be done sequentially, by default True</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            print some information, by default False</span>

<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="k">if</span> <span class="n">targets</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span>
        
        <span class="k">if</span> <span class="n">params</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        
        <span class="k">if</span> <span class="n">parameter_constraints</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameter_constraints</span> <span class="o">=</span> <span class="n">parameter_constraints</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameter_constraints</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">warmstart</span> <span class="o">=</span> <span class="n">warmstart</span> <span class="c1"># want to re-use expensive calculations from a previous run?</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">warmstart</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warmstart</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">old_xy</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ydyn&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">:[],</span><span class="s1">&#39;y&#39;</span><span class="p">:[]}</span> <span class="c1"># dict to hold the calculations from a previous run if warmstart==True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Path2OldXY</span> <span class="o">=</span> <span class="n">Path2OldXY</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SaveOldXY2file</span> <span class="o">=</span> <span class="n">SaveOldXY2file</span> <span class="c1"># path to file where we want to save the old_xy data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">res_dir</span> <span class="o">=</span> <span class="n">res_dir</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">res_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">res_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_custom</span> <span class="o">=</span> <span class="n">evaluate_custom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="o">=</span> <span class="n">parallel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_torch</span> <span class="o">=</span> <span class="kc">True</span>

    
    
<div class="viewcode-block" id="MooBOtorch.ConvertParams">
<a class="viewcode-back" href="../../../boar.core.html#boar.core.optimization_botorch.MooBOtorch.ConvertParams">[docs]</a>
    <span class="k">def</span> <span class="nf">ConvertParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert the params to the format required by the Ax/Botorch library</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params : list of Fitparam() objects</span>
<span class="sd">            list of Fitparam() objects</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of dict</span>
<span class="sd">            list of dictionaries with the following keys:\\</span>
<span class="sd">                &#39;name&#39;: string: the name of the parameter\\</span>
<span class="sd">                &#39;type&#39;: string: &#39;range&#39; or &#39;fixed&#39;\\</span>
<span class="sd">                &#39;bounds&#39;: list of float: the lower and upper bounds of the parameter\\</span>
<span class="sd">                </span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="n">Axparams</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">relRange</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">val_type</span> <span class="o">==</span> <span class="s1">&#39;float&#39;</span><span class="p">:</span>
                    <span class="n">log_scale</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">optim_type</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">rescale</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">p0m</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="c1"># just feed log scaled lims to Ax and don&#39;t let it rescale</span>
                                <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">lims</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
                                <span class="n">log_scale</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">par</span><span class="o">.</span><span class="n">p0m</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">par</span><span class="o">.</span><span class="n">p0m</span><span class="p">)]</span>
                                <span class="n">log_scale</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">p0m</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">par</span><span class="o">.</span><span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">par</span><span class="o">.</span><span class="n">lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                                <span class="n">log_scale</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">par</span><span class="o">.</span><span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">par</span><span class="o">.</span><span class="n">p0m</span><span class="p">,</span> <span class="n">par</span><span class="o">.</span><span class="n">lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">par</span><span class="o">.</span><span class="n">p0m</span><span class="p">]</span>
                                <span class="n">log_scale</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">par</span><span class="o">.</span><span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">par</span><span class="o">.</span><span class="n">p0m</span><span class="p">,</span> <span class="n">par</span><span class="o">.</span><span class="n">lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">par</span><span class="o">.</span><span class="n">p0m</span><span class="p">]</span> <span class="c1"># remove the order of magnitude </span>

                    <span class="n">Axparams</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;range&#39;</span><span class="p">,</span> <span class="s1">&#39;bounds&#39;</span><span class="p">:</span><span class="n">bounds</span><span class="p">,</span> <span class="s1">&#39;value_type&#39;</span><span class="p">:</span><span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;log_scale&#39;</span><span class="p">:</span><span class="n">log_scale</span><span class="p">})</span>
                <span class="k">elif</span> <span class="n">par</span><span class="o">.</span><span class="n">val_type</span> <span class="o">==</span> <span class="s1">&#39;int&#39;</span><span class="p">:</span>
                    <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">par</span><span class="o">.</span><span class="n">p0m</span><span class="p">),</span><span class="nb">round</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">par</span><span class="o">.</span><span class="n">p0m</span><span class="p">)]</span>
                    <span class="n">Axparams</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;range&#39;</span><span class="p">,</span> <span class="s1">&#39;bounds&#39;</span><span class="p">:</span><span class="n">bounds</span><span class="p">,</span> <span class="s1">&#39;value_type&#39;</span><span class="p">:</span><span class="s1">&#39;int&#39;</span><span class="p">})</span>
                    
                <span class="k">elif</span> <span class="n">par</span><span class="o">.</span><span class="n">val_type</span> <span class="o">==</span> <span class="s1">&#39;str&#39;</span><span class="p">:</span>
                    <span class="n">bounds</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">lims</span>
                    <span class="n">Axparams</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;choice&#39;</span><span class="p">,</span> <span class="s1">&#39;values&#39;</span><span class="p">:</span><span class="n">bounds</span><span class="p">,</span> <span class="s1">&#39;value_type&#39;</span><span class="p">:</span><span class="s1">&#39;str&#39;</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;val_type must be either float, int or str&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Axparams</span></div>

    
    
<div class="viewcode-block" id="MooBOtorch.get_model">
<a class="viewcode-back" href="../../../boar.core.html#boar.core.optimization_botorch.MooBOtorch.get_model">[docs]</a>
    <span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">estimator</span><span class="o">=</span><span class="s1">&#39;GPEI&#39;</span><span class="p">,</span><span class="n">use_CUDA</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the model</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        estimator : str, optional</span>
<span class="sd">            Estimator to use. The default is &#39;GPEI&#39;.</span>
<span class="sd">        use_CUDA : bool, optional</span>
<span class="sd">            Use CUDA. The default is True.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the estimator is not implemented yet.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        model : class</span>
<span class="sd">            Model class.</span>
<span class="sd">        tkwargs : dict</span>
<span class="sd">            Dictionary of keyword arguments for the model.</span>
<span class="sd">        opt : str</span>
<span class="sd">            type of optimization either &#39;random&#39;, &#39;single&#39; or &#39;multi&#39;</span>


<span class="sd">        &quot;&quot;&quot;</span> 
        <span class="n">available_models</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Sobol&#39;</span><span class="p">,</span><span class="s1">&#39;GPEI&#39;</span><span class="p">,</span><span class="s1">&#39;GPKG&#39;</span><span class="p">,</span><span class="s1">&#39;GPMES&#39;</span><span class="p">,</span><span class="s1">&#39;Factorial&#39;</span><span class="p">,</span><span class="s1">&#39;FullyBayesian&#39;</span><span class="p">,</span><span class="s1">&#39;FullyBayesianMOO&#39;</span><span class="p">,</span><span class="s1">&#39;FullyBayesian_MTGP&#39;</span><span class="p">,</span><span class="s1">&#39;FullyBayesianMOO_MTGP&#39;</span><span class="p">,</span><span class="s1">&#39;Thompson&#39;</span><span class="p">,</span><span class="s1">&#39;BO&#39;</span><span class="p">,</span><span class="s1">&#39;BoTorch&#39;</span><span class="p">,</span><span class="s1">&#39;EB&#39;</span><span class="p">,</span><span class="s1">&#39;Uniform&#39;</span><span class="p">,</span><span class="s1">&#39;MOO&#39;</span><span class="p">,</span><span class="s1">&#39;MOO_Modular&#39;</span><span class="p">,</span><span class="s1">&#39;ST_MTGP&#39;</span><span class="p">,</span><span class="s1">&#39;ALEBO&#39;</span><span class="p">,</span><span class="s1">&#39;BO_MIXED&#39;</span><span class="p">,</span><span class="s1">&#39;ST_MTGP_NEHVI&#39;</span><span class="p">,</span><span class="s1">&#39;ALEBO_Initializer&#39;</span><span class="p">,</span><span class="s1">&#39;Contextual_SACBO&#39;</span><span class="p">]</span>
        <span class="c1"># not implemented yet</span>
        <span class="n">not_implemented</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ST_MTGP_NEHVI&#39;</span><span class="p">,</span><span class="s1">&#39;ALEBO_Initializer&#39;</span><span class="p">,</span><span class="s1">&#39;Contextual_SACBO&#39;</span><span class="p">,</span><span class="s1">&#39;ALEBO&#39;</span><span class="p">,</span><span class="s1">&#39;GPMES&#39;</span><span class="p">,</span><span class="s1">&#39;Thompson&#39;</span><span class="p">,</span><span class="s1">&#39;EB&#39;</span><span class="p">,</span><span class="s1">&#39;Factorial&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">estimator</span> <span class="ow">in</span> <span class="n">not_implemented</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The estimator </span><span class="si">{}</span><span class="s1"> is not implemented yet&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">estimator</span><span class="p">))</span>

        <span class="c1"># Check if CUDA is available</span>
        <span class="k">if</span> <span class="n">use_CUDA</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">tkwargs</span>  <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tkwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;torch_device&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">),</span><span class="s2">&quot;torch_dtype&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">double</span><span class="p">}</span>

        <span class="n">opt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Note that we compare the lower case of the estimator to make it more flexible for the user</span>
        <span class="k">if</span> <span class="n">estimator</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Sobol&#39;</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="c1"># better for initial exploration not for optimization</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">Models</span><span class="o">.</span><span class="n">SOBOL</span>
            <span class="n">tkwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;seed&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">}</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="s1">&#39;random&#39;</span>
        <span class="k">elif</span> <span class="n">estimator</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Uniform&#39;</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="c1"># better for initial exploration not for optimization</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">Models</span><span class="o">.</span><span class="n">UNIFORM</span>
            <span class="n">tkwargs</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># no need for tkwargs for this model</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="s1">&#39;random&#39;</span>
        <span class="c1"># elif estimator.lower() == &#39;Factorial&#39;.lower(): # better for initial exploration not for optimization</span>
        <span class="c1">#     model = Models.FACTORIAL</span>
        <span class="c1">#     tkwargs = {} # no need for tkwargs for this model</span>
        <span class="c1">#     opt = &#39;random&#39;</span>

        <span class="c1">### Single objective models</span>
        <span class="k">elif</span> <span class="n">estimator</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;GPEI&#39;</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">Models</span><span class="o">.</span><span class="n">GPEI</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="s1">&#39;single&#39;</span>
        <span class="k">elif</span> <span class="n">estimator</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;GPKG&#39;</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">Models</span><span class="o">.</span><span class="n">GPKG</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="s1">&#39;single&#39;</span>
        <span class="k">elif</span> <span class="n">estimator</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;FullyBayesian&#39;</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">Models</span><span class="o">.</span><span class="n">FULLYBAYESIAN</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="s1">&#39;single&#39;</span>
        <span class="k">elif</span> <span class="n">estimator</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;BO&#39;</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">Models</span><span class="o">.</span><span class="n">BOTORCH</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="s1">&#39;single&#39;</span>
        <span class="k">elif</span> <span class="n">estimator</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;BoTorch&#39;</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">Models</span><span class="o">.</span><span class="n">BOTORCH_MODULAR</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="s1">&#39;single&#39;</span>
        <span class="k">elif</span> <span class="n">estimator</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;BO_MIXED&#39;</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">Models</span><span class="o">.</span><span class="n">BO_MIXED</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="s1">&#39;single&#39;</span>
        
        <span class="c1">### Multi-objective models</span>
        <span class="k">elif</span> <span class="n">estimator</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;FullyBayesianMOO&#39;</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">Models</span><span class="o">.</span><span class="n">FULLYBAYESIANMOO</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="s1">&#39;multi&#39;</span>
        <span class="k">elif</span> <span class="n">estimator</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;FullyBayesianMOO_MTGP&#39;</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">Models</span><span class="o">.</span><span class="n">FULLYBAYESIANMOO_MTGP</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="s1">&#39;multi&#39;</span>
        <span class="k">elif</span> <span class="n">estimator</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;ST_MTGP_NEHVI&#39;</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">Models</span><span class="o">.</span><span class="n">ST_MTGP_NEHVI</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="s1">&#39;multi&#39;</span>
        <span class="k">elif</span> <span class="n">estimator</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;MOO&#39;</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">Models</span><span class="o">.</span><span class="n">MOO</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="s1">&#39;multi&#39;</span>
        <span class="k">elif</span> <span class="n">estimator</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;MOO_Modular&#39;</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">Models</span><span class="o">.</span><span class="n">MOO_MODULAR</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="s1">&#39;multi&#39;</span>
       
        <span class="c1">### Not yet implemented</span>
        <span class="c1"># elif estimator.lower() == &#39;GPMES&#39;.lower():</span>
        <span class="c1">#     model = Models.GPMES</span>
        <span class="c1"># elif estimator.lower() == &#39;Thompson&#39;.lower():</span>
        <span class="c1">#     model = Models.THOMPSON</span>
        <span class="c1">#     tkwargs = {}</span>
        <span class="c1">#  elif estimator.lower() == &#39;FullyBayesian_MTGP&#39;.lower():</span>
        <span class="c1">#     model = Models.FULLYBAYESIAN_MTGP</span>
        <span class="c1"># elif estimator.lower() == &#39;Factorial&#39;.lower(): ## probably just need a ChoiceParameter or FixedParameter in the search space need to test later</span>
        <span class="c1">#     model = Models.FACTORIAL</span>
        <span class="c1">#     tkwargs = {} # no need for tkwargs for this model</span>
        <span class="c1"># elif estimator.lower() == &#39;EB&#39;.lower():</span>
        <span class="c1">#     model = Models.EMPERICAL_BAYES_THOMPSON</span>
        <span class="c1"># elif estimator.lower() == &#39;ST_MTGP&#39;.lower():</span>
        <span class="c1">#     model = Models.ST_MTGP</span>
        <span class="c1"># elif estimator.lower() == &#39;ALEBO&#39;.lower():</span>
        <span class="c1">#     model = Models.ALEBO</span>
        <span class="c1"># elif estimator.lower() == &#39;ALEBO_Initializer&#39;.lower():</span>
        <span class="c1">#     model = Models.ALEBO_Initializer</span>
        <span class="c1"># elif estimator.lower() == &#39;Contextual_SACBO&#39;.lower():</span>
        <span class="c1">#     model = Models.Contextual_SACBO</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;estimator must be one of the following: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">available_models</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">tkwargs</span><span class="p">,</span> <span class="n">opt</span></div>


<div class="viewcode-block" id="MooBOtorch.makeobjectives">
<a class="viewcode-back" href="../../../boar.core.html#boar.core.optimization_botorch.MooBOtorch.makeobjectives">[docs]</a>
    <span class="k">def</span> <span class="nf">makeobjectives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">obj_type</span><span class="o">=</span><span class="s1">&#39;MSE&#39;</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span><span class="n">is_MOO</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert the targets to the format required by the Ax/Botorch library</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        targets : list of dict</span>
<span class="sd">            list of dictionaries with the following keys:  </span>

<span class="sd">                &#39;model&#39;: a pointer to a function y = f(X) where X has m dimensions  </span>
<span class="sd">                &#39;data&#39;: dictionary with keys  </span>
<span class="sd">                &#39;X&#39;:ndarray with shape (n,m) where n is the number of evaluations for X  </span>
<span class="sd">                &#39;y&#39;:ndarray with shape (n,)  </span>
<span class="sd">                &#39;X_dimensions&#39;: list of string: the names of the dimensions in X  </span>
<span class="sd">                &#39;X_units&#39;: list of string: the units of the dimensions in X  </span>
<span class="sd">                &#39;y_dimension&#39;: string: the name of the dimension y  </span>
<span class="sd">                &#39;y_unit&#39;: string: the unit of the dimension y  </span>
<span class="sd">                &#39;weight&#39;: float: the weight of the target  </span>
<span class="sd">                &#39;loss&#39;: string: the loss function to be used  </span>
<span class="sd">                &#39;threshold&#39;: float: the threshold for the loss function  </span>
<span class="sd">        obj_type : str, optional</span>
<span class="sd">            the type of objective function to be used, by default &#39;MSE&#39;</span>
<span class="sd">        loss : str, optional</span>
<span class="sd">            the loss function to be used, by default &#39;linear&#39;</span>
<span class="sd">        threshold : float, optional</span>
<span class="sd">            the threshold for the loss function, by default 1000</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of Metric() objects</span>
<span class="sd">            list of Metric() objects</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># if threshold is not a list, make it a list</span>
        <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># if threshold is None, then set it to None for all targets and Ax will infer the threshold</span>
            <span class="n">threshold</span> <span class="o">=</span>  <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">targets</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;threshold&#39;</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">threshold</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">]</span>
        
        <span class="c1"># save the threshold in the targets</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">targets</span><span class="p">):</span>
            <span class="n">t</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">threshold</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>


        <span class="c1"># check if the length of the threshold list is the same as the number of metrics</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Threshold must either be a float or a list with the same length as the number of targets&#39;</span><span class="p">)</span>

        <span class="n">AxObjectives</span><span class="p">,</span><span class="n">metrics_names</span> <span class="o">=</span> <span class="p">{},[]</span>
        
        <span class="k">if</span> <span class="n">is_MOO</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">targets</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;minimize&#39;</span> <span class="ow">in</span> <span class="n">target</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">minimize</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="s1">&#39;minimize&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">minimize</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span> <span class="c1"># check if minimize is a boolean</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;minimize for target &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; must be a boolean. Using default value of True.&#39;</span><span class="p">)</span>
                        <span class="n">minimize</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">minimize</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="s1">&#39;obj_type&#39;</span> <span class="ow">in</span> <span class="n">target</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">AxObjectives</span><span class="p">[</span><span class="n">target</span><span class="p">[</span><span class="s1">&#39;obj_type&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">target</span><span class="p">[</span><span class="s1">&#39;target_name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ObjectiveProperties</span><span class="p">(</span><span class="n">minimize</span><span class="o">=</span><span class="n">minimize</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span> <span class="n">threshold</span><span class="p">[</span><span class="n">_</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">AxObjectives</span><span class="p">[</span><span class="n">obj_type</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">target</span><span class="p">[</span><span class="s1">&#39;target_name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ObjectiveProperties</span><span class="p">(</span><span class="n">minimize</span><span class="o">=</span><span class="n">minimize</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span> <span class="n">threshold</span><span class="p">[</span><span class="n">_</span><span class="p">])</span> 

                <span class="n">metrics_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj_type</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">target</span><span class="p">[</span><span class="s1">&#39;target_name&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mini</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">targets</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;minimize&#39;</span> <span class="ow">in</span> <span class="n">target</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">mini</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target</span><span class="p">[</span><span class="s1">&#39;minimize&#39;</span><span class="p">])</span>
            <span class="c1"># check if all targets have the same minimize value</span>
            <span class="k">if</span> <span class="n">mini</span> <span class="o">==</span> <span class="p">[]:</span>
                <span class="n">minimize</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">mini</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">minimize</span> <span class="o">=</span> <span class="n">mini</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;All targets must have the same minimize value&#39;</span><span class="p">)</span>

            <span class="n">AxObjectives</span><span class="p">[</span><span class="n">obj_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">ObjectiveProperties</span><span class="p">(</span><span class="n">minimize</span><span class="o">=</span><span class="n">minimize</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span> <span class="n">threshold</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">metrics_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj_type</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">AxObjectives</span><span class="p">,</span><span class="n">metrics_names</span></div>

    
<div class="viewcode-block" id="MooBOtorch.evaluate">
<a class="viewcode-back" href="../../../boar.core.html#boar.core.optimization_botorch.MooBOtorch.evaluate">[docs]</a>
    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">px</span><span class="p">,</span><span class="n">obj_type</span><span class="p">,</span><span class="n">loss</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">is_MOO</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate the target at a given set of parameters</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        px : list</span>
<span class="sd">            list of parameters values</span>
<span class="sd">        obj_type : str</span>
<span class="sd">            type of objective function to be used, see self.obj_func_metric</span>
<span class="sd">        loss : str</span>
<span class="sd">            loss function to be used, see self.lossfunc</span>
<span class="sd">        threshold : float, optional</span>
<span class="sd">            threshold for the loss function, by default 1</span>
<span class="sd">        is_MOO : bool, optional</span>
<span class="sd">            whether to use multi-objective optimization or enforce single-objective optimization, by default False</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            the model output</span>
<span class="sd">        &quot;&quot;&quot;</span>    

        <span class="n">pnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">relRange</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">px_</span> <span class="o">=</span> <span class="p">[</span><span class="n">px</span><span class="p">[</span><span class="n">pnames</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pnames</span><span class="p">))]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">params_w</span><span class="p">(</span><span class="n">px_</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

        <span class="n">zs</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># list of losses</span>
        <span class="n">target_weights</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">is_MOO</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">):</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;X&#39;</span><span class="p">]</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;weight&#39;</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> 
                    <span class="n">weight</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">weight</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">yf</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">](</span><span class="n">X</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

                <span class="k">if</span> <span class="s1">&#39;loss&#39;</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="c1"># if loss is specified in targets, use it</span>
                    <span class="n">loss</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="s1">&#39;obj_type&#39;</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_func_metric</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">yf</span><span class="p">,</span><span class="n">obj_type</span><span class="o">=</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;obj_type&#39;</span><span class="p">])</span>
                    <span class="n">res</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;obj_type&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;target_name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lossfunc</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">loss</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_func_metric</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">yf</span><span class="p">,</span><span class="n">obj_type</span><span class="o">=</span><span class="n">obj_type</span><span class="p">)</span>
                    <span class="n">res</span><span class="p">[</span><span class="n">obj_type</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;target_name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lossfunc</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">loss</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># threshold is set to 1 as we don&#39;t need it for MOO and if it is a list it will not work</span>

            <span class="k">return</span> <span class="n">res</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">):</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;X&#39;</span><span class="p">]</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;weight&#39;</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> 
                    <span class="n">weight</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">weight</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">yf</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">](</span><span class="n">X</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

                <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_func_metric</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">yf</span><span class="p">,</span><span class="n">obj_type</span><span class="o">=</span><span class="n">obj_type</span><span class="p">)</span>

                <span class="k">if</span> <span class="s1">&#39;loss&#39;</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="c1"># if loss is specified in targets, use it</span>
                    <span class="n">loss</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="s1">&#39;threshold&#39;</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="c1"># if threshold is specified in targets, use it</span>
                    <span class="n">threshold</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="s1">&#39;target_weight&#39;</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;target_weight&#39;</span><span class="p">],</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;target_weight&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">)):</span> <span class="c1"># if target_weight is specified in targets, use it</span>
                    <span class="c1">#check if target_weight is a float</span>
                    <span class="c1"># if isinstance(t[&#39;target_weight&#39;], float) or isinstance(t[&#39;target_weight&#39;], int):</span>
                        <span class="n">target_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;target_weight&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">target_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;target_weight for target &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; must be a float or int. Using default value of 1.&#39;</span><span class="p">)</span>

                <span class="n">zs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lossfunc</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">loss</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">))</span>

            <span class="c1"># cost is the weigthed average of the losses</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">zs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">cost</span> <span class="o">=</span> <span class="n">zs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">zs</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">target_weights</span><span class="p">)</span>    

            <span class="k">return</span> <span class="p">{</span><span class="n">obj_type</span><span class="p">:</span><span class="n">cost</span><span class="p">}</span></div>

    
<div class="viewcode-block" id="MooBOtorch.evaluate_custom">
<a class="viewcode-back" href="../../../boar.core.html#boar.core.optimization_botorch.MooBOtorch.evaluate_custom">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">evaluate_custom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">px</span><span class="p">,</span><span class="n">obj_type</span><span class="p">,</span><span class="n">loss</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">is_MOO</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Create a custom evaluation function that can be used with the Ax/Botorch library and needs to be implemented by the user</span>
<span class="sd">        should return a dictionary with the following format:</span>
<span class="sd">        {&#39;metric_name&#39;:metric_value}</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        px : list</span>
<span class="sd">            list of parameters values</span>
<span class="sd">        obj_type : str</span>
<span class="sd">            type of objective function to be used, see self.obj_func_metric</span>
<span class="sd">        loss : str</span>
<span class="sd">            loss function to be used, see self.lossfunc</span>
<span class="sd">        threshold : float, optional</span>
<span class="sd">            threshold for the loss function, by default 1</span>
<span class="sd">        is_MOO : bool, optional</span>
<span class="sd">            whether to use multi-objective optimization or enforce single-objective optimization, by default False</span>
<span class="sd">        &quot;&quot;&quot;</span>     
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Please implement your own evaluate_custom function&#39;</span><span class="p">)</span>   </div>


    
<div class="viewcode-block" id="MooBOtorch.BoTorchOpti">
<a class="viewcode-back" href="../../../boar.core.html#boar.core.optimization_botorch.MooBOtorch.BoTorchOpti">[docs]</a>
    <span class="k">def</span> <span class="nf">BoTorchOpti</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n_jobs</span><span class="o">=</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="n">n_step_points</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="n">models</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Sobol&#39;</span><span class="p">,</span><span class="s1">&#39;GPEI&#39;</span><span class="p">],</span> <span class="n">obj_type</span><span class="o">=</span><span class="s1">&#39;MSE&#39;</span><span class="p">,</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">model_kwargs_list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">model_gen_kwargs_list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">use_CUDA</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">is_MOO</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">use_custom_func</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">suggest_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">global_stopping_strategy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">show_posterior</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">kwargs_posterior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Optimize the model using the Ax/Botorch library</span>
<span class="sd">        Uses the Expected Hypervolume Improvement (EHVI) algorithm</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_jobs : list, optional</span>
<span class="sd">            number of parallel jobs for each step, by default [4,4]</span>
<span class="sd">        n_step_points : list, optional</span>
<span class="sd">            number of points to sample for each step, by default [5, 10]</span>
<span class="sd">        models : list, optional</span>
<span class="sd">            list of models to use for each step, by default [&#39;Sobol&#39;,&#39;GPEI&#39;]</span>
<span class="sd">        obj_type : str, optional</span>
<span class="sd">            type of objective function to be used, by default &#39;MSE&#39;</span>
<span class="sd">        loss : str, optional</span>
<span class="sd">            loss function to be used, by default &#39;linear&#39;</span>
<span class="sd">        threshold : float, optional</span>
<span class="sd">            threshold for the loss function, by default 1</span>
<span class="sd">        model_kwargs_list : list, optional</span>
<span class="sd">            list of dictionaries of model kwargs to use for each step, by default None</span>
<span class="sd">            Can contains :</span>
<span class="sd">            &#39;surrogate&#39; : Surrogate model to use. </span>
<span class="sd">            &#39;botorch_acqf_class&#39; : BoTorch acquisition function class to use.</span>
<span class="sd">        model_gen_kwargs_list : list, optional</span>
<span class="sd">            list of dictionaries of model generation kwargs to use for each step, by default None</span>
<span class="sd">        use_CUDA : bool, optional</span>
<span class="sd">            whether to use CUDA or not, by default True</span>
<span class="sd">        is_MOO : bool, optional</span>
<span class="sd">            whether to use multi-objective optimization or enforce single-objective optimization, by default False</span>
<span class="sd">        use_custom_func : bool, optional</span>
<span class="sd">            use a custom evaluation function instead of the default one, this is useful when the same model is used for different targets, by default False</span>
<span class="sd">        suggest_only : bool, optional</span>
<span class="sd">            only suggest the next point and does not evaluate it, by default False</span>
<span class="sd">        global_stopping_strategy : class, optional</span>
<span class="sd">            global stopping strategy based on BaseGlobalStoppingStrategy, see https://ax.dev/tutorials/gss.html, by default None</span>
<span class="sd">        show_posterior : bool, optional</span>
<span class="sd">            calculate &amp; show posterior distribution, by default True</span>
<span class="sd">        kwargs_posterior : dict</span>
<span class="sd">            dictionary of keyword arguments for posterior function, by default None</span>
<span class="sd">            including: </span>

<span class="sd">                Nres : integer, optional</span>
<span class="sd">                    Sampling resolution. Number of data points per dimension, by default 30</span>
<span class="sd">                Ninteg : integer, optional</span>
<span class="sd">                    Number of points for the marginalization over the other parameters when full_grid = False, by default 100</span>
<span class="sd">                full_grid : boolean, optional</span>
<span class="sd">                    If True, use a full grid for the posterior, by default False</span>
<span class="sd">                randomize : boolean, optional</span>
<span class="sd">                    If True, calculate the posterior for all the dimension but draw the marginalization points randomly and do not use a corse grid, by default False</span>
<span class="sd">                logscale : boolean, optional</span>
<span class="sd">                    display in log scale?, by default True</span>
<span class="sd">                vmin : float, optional</span>
<span class="sd">                    lower cutoff (in terms of exp(vmin) if logscale==True), by default 1e-100</span>
<span class="sd">                zoom : int, optional</span>
<span class="sd">                    number of time to zoom in, only used if full_grid = True, by default 0</span>
<span class="sd">                min_prob : float, optional</span>
<span class="sd">                    minimum probability to consider when zooming in we will zoom on the parameter space with a probability higher than min_prob, by default 1e-40.</span>
<span class="sd">                clear_axis : boolean, optional</span>
<span class="sd">                    clear the axis before plotting the zoomed in data, by default False.</span>
<span class="sd">                True_values : dict, optional</span>
<span class="sd">                    dictionary of true values of the parameters, by default None</span>
<span class="sd">                show_points : boolean, optional</span>
<span class="sd">                    show the explored points in the parameter space during the optimization, by default False</span>
<span class="sd">                savefig : boolean, optional</span>
<span class="sd">                    save the figure, by default False</span>
<span class="sd">                savefig_name : str, optional</span>
<span class="sd">                    name of the file to save the figure, by default &#39;posterior.png&#39;</span>
<span class="sd">                savefig_dir : str, optional</span>
<span class="sd">                    directory to save the figure, by default self.res_dir</span>
<span class="sd">                figext : str, optional</span>
<span class="sd">                    extension of the figure, by default &#39;.png&#39;</span>
<span class="sd">                figsize : tuple, optional</span>
<span class="sd">                    size of the figure, by default (5\*nb_params,5\*nb_params)</span>
<span class="sd">                figdpi : int, optional</span>
<span class="sd">                    dpi of the figure, by default 300</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            whether to print the optimization steps or not, by default True</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        AxClient</span>
<span class="sd">            the AxClient object</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            if n_jobs, n_step_points and models are not lists of the same length</span>

<span class="sd">        &quot;&quot;&quot;</span>  
        <span class="c1"># loss and threshold are passed to self in case we need them for the posterior function  </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">params_r</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span> 
        
        <span class="n">num_trials</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">n_step_points</span><span class="p">)</span> <span class="c1"># total number of trials</span>

        <span class="c1"># check that n_jobs, n_step_points and models are lists of the same length</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">n_jobs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">n_step_points</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;n_jobs, n_step_points and models must be lists of the same length&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model_kwargs_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_kwargs_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;model_kwargs_list must be a list of the same length as models, please provide a dictionary of kwargs for each model even if empty&#39;</span><span class="p">)</span>

        <span class="c1"># check that no n_jobs is larger than os.cpu_count()-1, reset to os.cpu_count()-1 if so and raise warning</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">n_jobs</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">n_jobs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span><span class="p">:</span> 
                <span class="n">n_jobs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;n_jobs for step &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; is larger than os.cpu_count()-1. Resetting to &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">maxjobs</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">n_jobs</span><span class="p">)</span> <span class="c1"># maximum number of parallel jobs</span>

        <span class="c1"># make list of models and tkwargs for each step</span>
        <span class="n">steps</span><span class="p">,</span> <span class="n">optitype</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">n_jobs</span><span class="p">)):</span>
            <span class="n">dum_model</span><span class="p">,</span> <span class="n">dum_tkwargs</span><span class="p">,</span> <span class="n">opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">use_CUDA</span><span class="o">=</span><span class="n">use_CUDA</span><span class="p">)</span>
            <span class="n">optitype</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">model_kwargs_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># if model_kwargs_list is specified, update dum_tkwargs</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">model_kwargs_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">dum_tkwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_kwargs_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">model_gen_kwargs_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># if model_gen_kwargs_list is specified, update dum_tkwargs</span>
                <span class="n">dum_tkwargs_gen</span> <span class="o">=</span> <span class="n">model_gen_kwargs_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dum_tkwargs_gen</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">GenerationStep</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">dum_model</span><span class="p">,</span><span class="n">num_trials</span><span class="o">=</span><span class="n">n_step_points</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">min_trials_observed</span><span class="o">=</span><span class="n">n_step_points</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">max_parallelism</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">model_kwargs</span> <span class="o">=</span> <span class="n">dum_tkwargs</span><span class="p">,</span> <span class="n">model_gen_kwargs</span> <span class="o">=</span> <span class="n">dum_tkwargs_gen</span><span class="p">))</span>

        <span class="k">if</span> <span class="s1">&#39;single&#39;</span> <span class="ow">in</span> <span class="n">optitype</span> <span class="ow">and</span> <span class="s1">&#39;multi&#39;</span> <span class="ow">in</span> <span class="n">optitype</span><span class="p">:</span> <span class="c1"># if both single and multi-objective optimization are specified, raise error</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot mix single and multi-objective optimization&#39;</span><span class="p">)</span>
        <span class="c1"># Note that is you have more than one target but is_MOO is False, the targets will be averaged and the loss will be computed on the weighted average</span>

        <span class="n">generation_strategy</span> <span class="o">=</span> <span class="n">GenerationStrategy</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">,)</span> <span class="c1"># initialize the generation strategy</span>

        <span class="n">ax_client</span> <span class="o">=</span> <span class="n">AxClient</span><span class="p">(</span><span class="n">generation_strategy</span><span class="o">=</span><span class="n">generation_strategy</span><span class="p">,</span><span class="n">global_stopping_strategy</span><span class="o">=</span><span class="n">global_stopping_strategy</span><span class="p">,</span><span class="n">enforce_sequential_optimization</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">verbose_logging</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span> <span class="c1"># initialize the AxClient</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ConvertParams</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

        <span class="n">objectives</span><span class="p">,</span><span class="n">metrics_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makeobjectives</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">,</span> <span class="n">obj_type</span><span class="o">=</span><span class="n">obj_type</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span><span class="p">,</span><span class="n">is_MOO</span><span class="o">=</span><span class="n">is_MOO</span><span class="p">)</span> <span class="c1"># make the objectives</span>
        
        <span class="c1"># if self.parameter_constraints is not None:</span>


        <span class="n">ax_client</span><span class="o">.</span><span class="n">create_experiment</span><span class="p">(</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;BOAR_torch&#39;</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
            <span class="c1"># objective_name=&#39;MSE&#39;,</span>
            <span class="c1"># minimize=True,</span>
            <span class="n">objectives</span><span class="o">=</span><span class="n">objectives</span><span class="p">,</span>
            <span class="c1"># Sets max parallelism to 10 for all steps of the generation strategy.</span>
            <span class="n">choose_generation_strategy_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;num_trials&quot;</span><span class="p">:</span> <span class="n">num_trials</span><span class="p">,</span>
                <span class="s2">&quot;max_parallelism_override&quot;</span><span class="p">:</span> <span class="n">maxjobs</span><span class="p">,</span>
                <span class="s2">&quot;enforce_sequential_optimization&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,},</span>
            <span class="n">parameter_constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_constraints</span><span class="p">,</span>
        <span class="p">)</span>


        <span class="c1"># run the optimization</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">hv_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cum_n_step_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">n_step_points</span><span class="p">)</span>
        <span class="c1"># check if any n_jobs is larger than 1, if so use joblib to parallelize the evaluation of the custom function</span>

        
        <span class="c1"># if use_custom_func == True and any(np.asarray(n_jobs) &gt; 1):</span>
        <span class="c1">#     n_jobs = [1 for i in range(len(n_jobs))]</span>
        <span class="c1">#     warnings.warn(&#39;n_jobs must be 1 when using a custom evaluation function, setting n_jobs to 1&#39;)</span>
            <span class="c1"># use ray to parallelize the evaluation of the custom function, for some reason it does not work with joblib</span>
            <span class="c1"># ray.init(num_cpus=maxjobs)</span>
        
        <span class="k">if</span> <span class="s1">&#39;recall&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">warmstart</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># load the old data</span>
                <span class="n">path2file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Path2OldXY</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path2file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
                    <span class="n">old_xy_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">old_xy</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_xy_dict</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">):</span> <span class="c1"># save the old y values for each target</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">old_xy</span><span class="p">[</span><span class="s1">&#39;y_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span> <span class="o">=</span> <span class="n">old_xy_dict</span><span class="p">[</span><span class="s1">&#39;y_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">old_xy</span><span class="p">[</span><span class="s1">&#39;ydyn_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span> <span class="o">=</span> <span class="n">old_xy_dict</span><span class="p">[</span><span class="s1">&#39;ydyn_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span>
                
                <span class="c1"># add the old data to the Ax client</span>
                <span class="n">pnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">relRange</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">valtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">val_type</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">relRange</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">metrics_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj_type</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;target_name&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;obj_type&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;obj_type&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;target_name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">]</span>
                <span class="n">target_weights</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_xy</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])):</span>
                    <span class="n">dic</span><span class="p">,</span><span class="n">dic_metric</span> <span class="o">=</span> <span class="p">{},{}</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pnames</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="n">valtypes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;str&#39;</span><span class="p">:</span>
                            <span class="n">dic</span><span class="p">[</span><span class="n">pnames</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_xy</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
                        <span class="k">elif</span> <span class="n">valtypes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;int&#39;</span><span class="p">:</span>
                            <span class="n">dic</span><span class="p">[</span><span class="n">pnames</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_xy</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">dic</span><span class="p">[</span><span class="n">pnames</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_xy</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>

                    <span class="k">if</span> <span class="n">is_MOO</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">):</span>
                            <span class="n">dic_metric</span><span class="p">[</span><span class="n">metrics_names</span><span class="p">[</span><span class="n">num</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_xy</span><span class="p">[</span><span class="s1">&#39;y_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)][</span><span class="n">i</span><span class="p">],</span><span class="kc">None</span><span class="p">)</span>
                        <span class="n">parameters</span><span class="p">,</span> <span class="n">trial_index</span> <span class="o">=</span> <span class="n">ax_client</span><span class="o">.</span><span class="n">attach_trial</span><span class="p">(</span><span class="n">parameters</span><span class="o">=</span><span class="n">dic</span><span class="p">)</span>
                        <span class="n">ax_client</span><span class="o">.</span><span class="n">complete_trial</span><span class="p">(</span><span class="n">trial_index</span><span class="o">=</span><span class="n">trial_index</span><span class="p">,</span> <span class="n">raw_data</span><span class="o">=</span><span class="n">dic_metric</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">zs</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># list of losses</span>
                        <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">):</span>
                            <span class="n">zs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_xy</span><span class="p">[</span><span class="s1">&#39;y_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)][</span><span class="n">i</span><span class="p">])</span>
                            <span class="k">if</span> <span class="s1">&#39;target_weight&#39;</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;target_weight&#39;</span><span class="p">],</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;target_weight&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">)):</span> <span class="c1"># if target_weight is specified in targets, use it</span>
                                <span class="c1">#check if target_weight is a float</span>
                                <span class="c1"># if isinstance(t[&#39;target_weight&#39;], float) or isinstance(t[&#39;target_weight&#39;], int):</span>
                                    <span class="n">target_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;target_weight&#39;</span><span class="p">])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">target_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;target_weight for target &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; must be a float or int. Using default value of 1.&#39;</span><span class="p">)</span>

                        <span class="c1"># cost is the weigthed average of the losses</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">zs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">cost</span> <span class="o">=</span> <span class="n">zs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">zs</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">target_weights</span><span class="p">)</span>
                        <span class="n">parameters</span><span class="p">,</span> <span class="n">trial_index</span> <span class="o">=</span> <span class="n">ax_client</span><span class="o">.</span><span class="n">attach_trial</span><span class="p">(</span><span class="n">parameters</span><span class="o">=</span><span class="n">dic</span><span class="p">)</span>
                        <span class="n">ax_client</span><span class="o">.</span><span class="n">complete_trial</span><span class="p">(</span><span class="n">trial_index</span><span class="o">=</span><span class="n">trial_index</span><span class="p">,</span> <span class="n">raw_data</span><span class="o">=</span><span class="p">(</span><span class="n">cost</span><span class="p">,</span><span class="kc">None</span><span class="p">))</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not load the old_xy data so we keep going without it&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error message: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>



        <span class="k">while</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">num_trials</span><span class="p">:</span>
            <span class="n">curr_batch_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_jobs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">cum_n_step_points</span><span class="o">&gt;</span><span class="n">n</span><span class="p">)])</span> <span class="c1"># number of trials in the current batch</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="n">curr_batch_size</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="n">num_trials</span><span class="p">:</span> <span class="c1"># if the number of trials is larger than the total number of trials, reduce the batch size</span>
                <span class="n">curr_batch_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">curr_batch_size</span> <span class="o">-</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">num_trials</span><span class="p">))</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">num_trials</span>

            <span class="n">trial_mapping</span><span class="p">,</span> <span class="n">optimization_complete</span> <span class="o">=</span> <span class="n">ax_client</span><span class="o">.</span><span class="n">get_next_trials</span><span class="p">(</span><span class="n">curr_batch_size</span><span class="p">)</span>

            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">suggest_only</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">use_custom_func</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">curr_batch_size</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span><span class="p">:</span> <span class="c1"># do in serial</span>
                        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">px</span><span class="p">,</span><span class="n">obj_type</span><span class="p">,</span><span class="n">loss</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span><span class="n">is_MOO</span><span class="o">=</span><span class="n">is_MOO</span><span class="p">)</span> <span class="k">for</span> <span class="n">px</span> <span class="ow">in</span> <span class="n">trial_mapping</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
                    <span class="k">else</span><span class="p">:</span> <span class="c1"># do in parallel with joblib</span>
                        <span class="n">results</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">curr_batch_size</span><span class="p">)(</span><span class="n">delayed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">)(</span><span class="n">px</span><span class="p">,</span><span class="n">obj_type</span><span class="p">,</span><span class="n">loss</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span><span class="n">is_MOO</span><span class="o">=</span><span class="n">is_MOO</span><span class="p">)</span> <span class="k">for</span> <span class="n">px</span> <span class="ow">in</span> <span class="n">trial_mapping</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Using custom evaluation function, make sure that the function returns a dictionary with the following format: {metric_name:metric_value}&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">curr_batch_size</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span><span class="p">:</span>
                        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">evaluate_custom</span><span class="p">(</span><span class="n">px</span><span class="p">,</span><span class="n">obj_type</span><span class="p">,</span><span class="n">loss</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span><span class="n">is_MOO</span><span class="o">=</span><span class="n">is_MOO</span><span class="p">)</span> <span class="k">for</span> <span class="n">px</span> <span class="ow">in</span> <span class="n">trial_mapping</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
                    <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#     raise ValueError(&#39;Cannot use custom evaluation function with more than one job, please set n_jobs to 1&#39;)</span>
                        <span class="n">results</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">curr_batch_size</span><span class="p">)(</span><span class="n">delayed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evaluate_custom</span><span class="p">)(</span><span class="n">px</span><span class="p">,</span><span class="n">obj_type</span><span class="p">,</span><span class="n">loss</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span><span class="n">is_MOO</span><span class="o">=</span><span class="n">is_MOO</span><span class="p">)</span> <span class="k">for</span> <span class="n">px</span> <span class="ow">in</span> <span class="n">trial_mapping</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                    <span class="c1"># # user ray </span>
                    <span class="c1"># results = ray.get([self.evaluate_custom.remote(px,obj_type,loss,threshold=threshold,is_MOO=is_MOO) for px in trial_mapping.values()])</span>


                <span class="c1"># report the completion of trials to the Ax client</span>
                <span class="k">for</span> <span class="n">trial_index</span><span class="p">,</span> <span class="n">raw_data</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">trial_mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">results</span><span class="p">):</span>
                    <span class="n">ax_client</span><span class="o">.</span><span class="n">complete_trial</span><span class="p">(</span><span class="n">trial_index</span><span class="o">=</span><span class="n">trial_index</span><span class="p">,</span> <span class="n">raw_data</span><span class="o">=</span><span class="n">raw_data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># mark as failed</span>
                <span class="k">for</span> <span class="n">trial_index</span> <span class="ow">in</span> <span class="n">trial_mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">ax_client</span><span class="o">.</span><span class="n">abandon_trial</span><span class="p">(</span><span class="n">trial_index</span><span class="o">=</span><span class="n">trial_index</span><span class="p">)</span>

            <span class="c1"># get the hypervolume</span>
            <span class="k">if</span> <span class="n">is_MOO</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">hv</span> <span class="o">=</span> <span class="n">ax_client</span><span class="o">.</span><span class="n">get_hypervolume</span><span class="p">()</span>
                    <span class="n">hv_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hv</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">hv</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">hv_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hv</span><span class="p">)</span>
                    <span class="c1"># warnings.warn(&#39;Could not compute hypervolume, error message: &#39;+str(e))</span>

        <span class="c1"># Collect the old xy data for future use</span>
        <span class="k">if</span> <span class="s1">&#39;collect&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">warmstart</span><span class="p">:</span>
            <span class="n">dic</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_xy</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s1">&#39;collect_BO&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">warmstart</span><span class="p">:</span> <span class="c1"># if there is old data, save it3</span>
                <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_xy</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">):</span> <span class="c1"># save the old y values for each target</span>
                    <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;y_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_xy</span><span class="p">[</span><span class="s1">&#39;y_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span>
                    <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;ydyn_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_xy</span><span class="p">[</span><span class="s1">&#39;ydyn_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># if there is no old data, save the data from the BO</span>
                <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">):</span> <span class="c1"># save the old y values for each target</span>
                    <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;y_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;ydyn_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">triedX</span> <span class="o">=</span> <span class="n">ax_client</span><span class="o">.</span><span class="n">generation_strategy</span><span class="o">.</span><span class="n">trials_as_df</span>
            <span class="n">triedY</span> <span class="o">=</span> <span class="n">ax_client</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">fetch_data</span><span class="p">()</span><span class="o">.</span><span class="n">df</span>
            <span class="n">metric_names</span> <span class="o">=</span> <span class="n">triedY</span><span class="p">[</span><span class="s1">&#39;metric_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> <span class="c1"># get the metric names</span>

            <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">):</span> <span class="c1"># save the old y values for each target</span>
                <span class="n">xdum</span><span class="p">,</span> <span class="n">ydum</span><span class="p">,</span> <span class="n">ydyndum</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
                <span class="n">ydyndum</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">triedYdum</span> <span class="o">=</span> <span class="n">triedY</span><span class="p">[</span><span class="n">triedY</span><span class="p">[</span><span class="s1">&#39;metric_name&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">metric_names</span><span class="p">[</span><span class="n">num</span><span class="p">]]</span>
                <span class="k">for</span> <span class="n">trial_index</span> <span class="ow">in</span> <span class="n">triedX</span><span class="p">[</span><span class="s1">&#39;Trial Index&#39;</span><span class="p">]:</span>
                    <span class="n">dum</span> <span class="o">=</span> <span class="n">triedX</span><span class="p">[</span><span class="n">triedX</span><span class="p">[</span><span class="s1">&#39;Trial Index&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">trial_index</span><span class="p">][</span><span class="s1">&#39;Arm Parameterizations&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dum</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">xdum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dum</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
                    <span class="n">ydum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">triedYdum</span><span class="p">[</span><span class="n">triedYdum</span><span class="p">[</span><span class="s1">&#39;trial_index&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">trial_index</span><span class="p">][</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;y_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ydum</span><span class="p">)</span>
                <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;ydyn_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ydyndum</span>
            <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">xdum</span><span class="p">)</span>
            <span class="n">path2file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SaveOldXY2file</span> <span class="c1"># path to file</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path2file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dic</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
                

        <span class="c1"># get the best parameters</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_MOO</span><span class="p">:</span>

                <span class="n">best_parameters</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">ax_client</span><span class="o">.</span><span class="n">get_best_parameters</span><span class="p">(</span><span class="n">use_model_predictions</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hv_list</span> <span class="o">=</span> <span class="n">hv_list</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">pareto</span> <span class="o">=</span> <span class="n">ax_client</span><span class="o">.</span><span class="n">get_pareto_optimal_parameters</span><span class="p">(</span><span class="n">use_model_predictions</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pareto</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="n">best_parameters</span> <span class="o">=</span> <span class="n">pareto</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>

                    <span class="c1"># Make a list of the pareto points in the for [key, MSE_trMC, MSE_trPL] for easier handling</span>
                    <span class="n">pareto_list</span><span class="o">=</span><span class="p">[]</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pareto</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">pareto</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                        <span class="n">dum_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sublist</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
                            <span class="n">dum_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sublist</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="nb">list</span><span class="p">(</span><span class="n">sublist</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">j</span><span class="p">]])</span>
                        <span class="n">pareto_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dum_list</span><span class="p">)</span>

                    <span class="c1"># Sort the list based on the first and second elements of each sublist</span>
                    <span class="c1"># Calculate squared sum of indices for each element and find the one with the lowest sum</span>
                    <span class="n">min_index_sum</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
                    <span class="n">min_index_element</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">indexs</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pareto_list</span><span class="p">):</span>
                        <span class="n">dum_list</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sublist</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">dum_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">pareto_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">sublist</span><span class="p">))</span>
                        <span class="n">indexs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dum_list</span><span class="p">)</span>
                    <span class="c1"># Find the index of the element with the lowest sum of indices</span>
                    <span class="n">sum_indexs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">indexs</span><span class="p">)]</span>
                    <span class="n">min_index_element</span> <span class="o">=</span> <span class="n">sum_indexs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">sum_indexs</span><span class="p">))</span>
                    <span class="n">best_parameters</span> <span class="o">=</span> <span class="n">pareto</span><span class="p">[</span><span class="n">pareto_list</span><span class="p">[</span><span class="n">min_index_element</span><span class="p">][</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
                    
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No pareto optimal parameters found, try to increase the number of trials or the threshold or let Ax infer the threshold by setting it to None.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">e</span><span class="p">)</span>

            <span class="n">px</span> <span class="o">=</span> <span class="p">[</span><span class="n">best_parameters</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">relRange</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params_w</span><span class="p">(</span><span class="n">px</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_MOO</span> <span class="ow">and</span> <span class="n">show_posterior</span><span class="p">:</span>

                <span class="c1"># number of data points</span>
                <span class="n">Num_data_pts</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">num</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">):</span> <span class="c1"># get the number of data points</span>
                    <span class="n">Num_data_pts</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>


                <span class="n">triedX</span> <span class="o">=</span> <span class="n">ax_client</span><span class="o">.</span><span class="n">generation_strategy</span><span class="o">.</span><span class="n">trials_as_df</span>

                <span class="c1"># get previous trials</span>
                <span class="n">points</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">triedX</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="n">dum</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Arm Parameterizations&#39;</span><span class="p">]</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dum</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dum</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

                <span class="n">ax_client</span><span class="o">.</span><span class="n">fit_model</span><span class="p">()</span> <span class="c1"># fit the model</span>
                <span class="n">gpr</span> <span class="o">=</span> <span class="n">ax_client</span><span class="o">.</span><span class="n">generation_strategy</span><span class="o">.</span><span class="n">model</span> <span class="c1"># get the model</span>
                <span class="n">xmin</span><span class="p">,</span> <span class="n">funmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_minimum_BOAR</span><span class="p">(</span><span class="n">triedX</span><span class="p">,</span><span class="n">gpr</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Minimum of surrogate function:&#39;</span><span class="p">,</span><span class="n">xmin</span><span class="p">,</span><span class="s1">&#39;with function value&#39;</span><span class="p">,</span><span class="n">funmin</span><span class="p">)</span>
                <span class="c1"># Christopher M. Bishop:Pattern Recognition and Machine Learning, Springer Information Science &amp; statistics</span>
                <span class="c1"># Chapter 1.2.5 pg 29 eq- 1.63</span>
                <span class="k">if</span> <span class="n">funmin</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">beta</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">funmin</span> <span class="c1"># precision = 1/sigma**2 !!! rr.fun is MSE which is OK because consided below in LLH()!! </span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">beta</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">funmin</span><span class="p">)</span> <span class="c1"># precision = 1/sigma**2 !!! rr.fun is MSE which is OK because consided below in LLH()!!</span>
                    <span class="c1">#Add warning here</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;The surrogate function got negative. setting beta to the absolute value of the negative value&#39;</span><span class="p">)</span>

                <span class="c1"># save parameters to self for later use</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">Num_data_pts</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gpr</span> <span class="o">=</span> <span class="n">gpr</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fscale</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beta_scaled</span> <span class="o">=</span> <span class="n">beta</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="n">points</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kwargs_posterior</span> <span class="o">=</span> <span class="n">kwargs_posterior</span>

                <span class="c1"># get the posterior probabiliy distribution p(w|t)</span>
                <span class="k">if</span> <span class="n">show_posterior</span><span class="p">:</span>
                    
                    <span class="n">pf</span> <span class="o">=</span> <span class="p">[</span><span class="n">pp</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="k">if</span> <span class="n">pp</span><span class="o">.</span><span class="n">relRange</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">p0</span><span class="p">,</span> <span class="n">lb_main</span><span class="p">,</span> <span class="n">ub_main</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_r</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

                    <span class="n">xmin0</span><span class="p">,</span><span class="n">std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">posterior</span><span class="p">(</span><span class="n">pf</span><span class="p">,</span> <span class="n">lb_main</span><span class="p">,</span> <span class="n">ub_main</span><span class="p">,</span><span class="n">points</span><span class="o">=</span><span class="n">points</span><span class="p">,</span><span class="n">beta_scaled</span> <span class="o">=</span> <span class="n">beta</span><span class="p">,</span><span class="n">N</span><span class="o">=</span><span class="n">Num_data_pts</span><span class="p">,</span><span class="n">gpr</span> <span class="o">=</span> <span class="n">gpr</span><span class="p">,</span><span class="n">fscale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">kwargs_posterior</span><span class="o">=</span><span class="n">kwargs_posterior</span><span class="p">)</span>

                    <span class="c1"># Note: the posterior is calculated with from the surrogate function and not the ground truth function therefore it is not always accurate</span>
                    <span class="c1">#       especially when the surrogate function is not trained well. This is why the best fit parameters are taken from the best one sampled by the BO</span>
                    <span class="c1">#       and not from the posterior. The posterior is only used to get the error bars. This mean that sometimes the best fit parameters is not necessarily</span>
                    <span class="c1">#       the one with the highest posterior probability. In this case the 95% confidence interval that is outputted is stretched to include the best fit parameters.</span>
                    <span class="c1">#       This is not a problem because the posterior is not used to get the best fit parameters but only to get the error bars, this way guarantee that the best fit is </span>
                    <span class="c1">#       always within the outputted error bars.</span>
                    <span class="c1">#       The 95% interval is stored in std (so std is NOT the standard deviation of the posterior distribution)</span>
                
                    <span class="bp">self</span><span class="o">.</span><span class="n">params_w</span><span class="p">(</span><span class="n">px</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span><span class="n">std</span><span class="o">=</span><span class="n">std</span><span class="p">)</span> <span class="c1"># read out Fitparams &amp; respect settings</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">suggest_only</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Could not get the best parameters as suggest_only is set to True and no trial was completed, error message: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Error message: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ax_client</span></div>


    
    <span class="c1">###############################################################################</span>
    <span class="c1">############################## Plot utils #####################################</span>
    <span class="c1">###############################################################################</span>
<div class="viewcode-block" id="MooBOtorch.plot_all_objectives">
<a class="viewcode-back" href="../../../boar.core.html#boar.core.optimization_botorch.MooBOtorch.plot_all_objectives">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_all_objectives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax_client</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot all objectives </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ax_client : AxClient() object</span>
<span class="sd">            AxClient() object</span>
<span class="sd">        kwargs : dict, optional</span>
<span class="sd">            keyword arguments for the plot, by default {}</span>
<span class="sd">                savefig : boolean, optional</span>
<span class="sd">                    save the figure, by default False</span>
<span class="sd">                savefig_name : str, optional</span>
<span class="sd">                    name of the file to save the figure, by default &#39;&#39;objectives&#39;</span>
<span class="sd">                savefig_dir : str, optional</span>
<span class="sd">                    directory to save the figure, by default self.res_dir</span>
<span class="sd">                figext : str, optional</span>
<span class="sd">                    extension of the figure, by default &#39;.png&#39;</span>
<span class="sd">                figsize : tuple, optional</span>
<span class="sd">                    size of the figure, by default (5\*nb_params,5\*nb_params)</span>
<span class="sd">                figdpi : int, optional</span>
<span class="sd">                    dpi of the figure, by default 300</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span> 

        <span class="n">figsize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;figsize&#39;</span><span class="p">,(</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
        <span class="n">figdpi</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;figdpi&#39;</span><span class="p">,</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">figext</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;figext&#39;</span><span class="p">,</span><span class="s1">&#39;.png&#39;</span><span class="p">)</span>
        <span class="n">savefig</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;savefig&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">savefig_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;savefig_name&#39;</span><span class="p">,</span><span class="s1">&#39;objectives&#39;</span><span class="p">)</span>
        <span class="n">logscale</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logscale&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">cm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">exp_to_df</span><span class="p">(</span><span class="n">ax_client</span><span class="o">.</span><span class="n">experiment</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;trial_index&#39;</span><span class="p">])</span>
        <span class="n">metric_names</span> <span class="o">=</span> <span class="n">ax_client</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">fetch_data</span><span class="p">()</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;metric_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span>  <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
            <span class="n">train_obj</span>  <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">metric_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">batch_number</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">trial_index</span><span class="o">.</span><span class="n">values</span>
            <span class="n">sc</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">batch_number</span><span class="p">,</span> <span class="n">train_obj</span><span class="p">)</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Iteration&#39;</span><span class="p">)</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">metric_names</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">logscale</span><span class="p">:</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span>  <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

            <span class="n">train_obj</span>  <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">metric_names</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">metric_names</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">batch_number</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">trial_index</span><span class="o">.</span><span class="n">values</span>
            <span class="n">sc</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">train_obj</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">train_obj</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">batch_number</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">metric_names</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">metric_names</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">batch_number</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">batch_number</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="n">sm</span> <span class="o">=</span>  <span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="p">)</span>
            <span class="n">sm</span><span class="o">.</span><span class="n">set_array</span><span class="p">([])</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)</span>
            <span class="n">cbar_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">])</span>
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax</span><span class="p">)</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">logscale</span><span class="p">:</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span>  <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metric_names</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">metric_names</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
            <span class="n">comb</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">metric_names</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metric_names</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metric_names</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>

                    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">j</span><span class="p">:</span>
                        <span class="n">metricx</span> <span class="o">=</span> <span class="n">comb</span><span class="p">[</span><span class="n">count</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">metricy</span> <span class="o">=</span> <span class="n">comb</span><span class="p">[</span><span class="n">count</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">train_obj</span>  <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">metricx</span><span class="p">,</span><span class="n">metricy</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
                        <span class="n">batch_number</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">trial_index</span><span class="o">.</span><span class="n">values</span>
                        <span class="n">sc</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">train_obj</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">train_obj</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">batch_number</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

                        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">metricx</span><span class="p">)</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">metricy</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">logscale</span><span class="p">:</span>
                            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
                            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
                        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">j</span><span class="p">:</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">batch_number</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">batch_number</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="n">sm</span> <span class="o">=</span>  <span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="p">)</span>
            <span class="n">sm</span><span class="o">.</span><span class="n">set_array</span><span class="p">([])</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)</span>
            <span class="n">cbar_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">])</span>
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax</span><span class="p">)</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">savefig</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">res_dir</span><span class="p">,</span><span class="n">savefig_name</span><span class="o">+</span><span class="n">figext</span><span class="p">),</span><span class="n">dpi</span><span class="o">=</span><span class="n">figdpi</span><span class="p">)</span></div>


<div class="viewcode-block" id="MooBOtorch.plot_density">
<a class="viewcode-back" href="../../../boar.core.html#boar.core.optimization_botorch.MooBOtorch.plot_density">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_density</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax_client</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Plot the density of the of the points in the search space</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ax_client : AxClient() object</span>
<span class="sd">            AxClient() object</span>
<span class="sd">        kwargs : dict, optional</span>
<span class="sd">            keyword arguments for the plot, by default {}</span>
<span class="sd">                savefig : boolean, optional</span>
<span class="sd">                    save the figure, by default False</span>
<span class="sd">                savefig_name : str, optional</span>
<span class="sd">                    name of the file to save the figure, by default &#39;&#39;objectives&#39;</span>
<span class="sd">                savefig_dir : str, optional</span>
<span class="sd">                    directory to save the figure, by default self.res_dir</span>
<span class="sd">                figext : str, optional</span>
<span class="sd">                    extension of the figure, by default &#39;.png&#39;</span>
<span class="sd">                figsize : tuple, optional</span>
<span class="sd">                    size of the figure, by default (5\*nb_params,5\*nb_params)</span>
<span class="sd">                figdpi : int, optional</span>
<span class="sd">                    dpi of the figure, by default 300</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            axis_type must be either log or linear</span>

<span class="sd">        &quot;&quot;&quot;</span>      

        <span class="n">figsize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;figsize&#39;</span><span class="p">,(</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
        <span class="n">figdpi</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;figdpi&#39;</span><span class="p">,</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">figext</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;figext&#39;</span><span class="p">,</span><span class="s1">&#39;.png&#39;</span><span class="p">)</span>
        <span class="n">savefig</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;savefig&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">savefig_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;savefig_name&#39;</span><span class="p">,</span><span class="s1">&#39;points_density&#39;</span><span class="p">)</span>

        <span class="n">experiment</span> <span class="o">=</span> <span class="n">ax_client</span><span class="o">.</span><span class="n">experiment</span>

        <span class="n">pnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">relRange</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">val_type</span> <span class="o">!=</span> <span class="s1">&#39;str&#39;</span><span class="p">]</span> <span class="c1"># get the parameter names don&#39;t include the string parameters</span>
        <span class="n">pnames_display</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">display_name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">relRange</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">val_type</span> <span class="o">!=</span> <span class="s1">&#39;str&#39;</span><span class="p">]</span>
        <span class="n">lims_low</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">relRange</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">lims_high</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">relRange</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">p_axis_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">axis_type</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">relRange</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">exp_to_df</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;trial_index&quot;</span><span class="p">])</span>

        <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">pnames</span><span class="p">]</span>

        <span class="c1"># # udpate values in df2 if optim_type is log</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)):</span>
        <span class="c1"># for i in range(len(pnames)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">relRange</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">optim_type</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">df2</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">])</span> <span class="c1"># rescale to original value</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">df2</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">])</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">optim_type</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
                    <span class="n">df2</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span> <span class="c1"># rescale to original value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;axis_type must be either log or linear&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pnames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p_axis_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">lims_low</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">lims_high</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="n">pnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">stat</span><span class="o">=</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span><span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">axes</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">pnames_display</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Probability&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># make a figure with subplots for each parameter combination</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pnames</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">pnames</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pnames</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pnames</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">p_axis_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
                            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">lims_low</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">lims_high</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

                        <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="n">pnames</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">stat</span><span class="o">=</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span><span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pnames</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
                            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
                            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">pnames_display</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
                            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">tick_top</span><span class="p">()</span>
                            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
                            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
                            <span class="c1"># axes[i,j].yaxis.tick_right()</span>
                            <span class="c1"># axes[i,j].set_ylabel(&#39;Probability&#39;)</span>
                            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
                            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
                            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">pnames_display</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
                            <span class="c1"># remove the yticks</span>
                            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
                            <span class="c1"># axes[i,j].yaxis.tick_right()</span>
                            <span class="c1"># axes[i,j].set_ylabel(&#39;Probability&#39;)</span>
                            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>


                    <span class="k">elif</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">j</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">p_axis_type</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
                            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">p_axis_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
                            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
                        
                        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">lims_low</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">lims_high</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">lims_low</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">lims_high</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>


                        <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df2</span><span class="p">[</span><span class="n">pnames</span><span class="p">[</span><span class="n">j</span><span class="p">]],</span><span class="n">y</span><span class="o">=</span><span class="n">df2</span><span class="p">[</span><span class="n">pnames</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">shade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="n">pnames</span><span class="p">[</span><span class="n">j</span><span class="p">]],</span><span class="n">df2</span><span class="p">[</span><span class="n">pnames</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">pnames</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">pnames_display</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
                            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
                            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([],</span> <span class="n">minor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">pnames_display</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
                            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([],</span> <span class="n">minor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                            
                        
                        
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">savefig</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">res_dir</span><span class="p">,</span><span class="n">savefig_name</span><span class="o">+</span><span class="n">figext</span><span class="p">),</span><span class="n">dpi</span><span class="o">=</span><span class="n">figdpi</span><span class="p">)</span></div>


<div class="viewcode-block" id="MooBOtorch.plot_hypervolume">
<a class="viewcode-back" href="../../../boar.core.html#boar.core.optimization_botorch.MooBOtorch.plot_hypervolume">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_hypervolume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">hv_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the hypervolume trace</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        hv_list : list, optional</span>
<span class="sd">            list of hypervolumes, by default None</span>
<span class="sd">        kwargs : dict, optional</span>
<span class="sd">            keyword arguments for the plot, by default {}</span>
<span class="sd">                savefig : boolean, optional</span>
<span class="sd">                    save the figure, by default False</span>
<span class="sd">                savefig_name : str, optional</span>
<span class="sd">                    name of the file to save the figure, by default &#39;&#39;objectives&#39;</span>
<span class="sd">                savefig_dir : str, optional</span>
<span class="sd">                    directory to save the figure, by default self.res_dir</span>
<span class="sd">                figext : str, optional</span>
<span class="sd">                    extension of the figure, by default &#39;.png&#39;</span>
<span class="sd">                figsize : tuple, optional</span>
<span class="sd">                    size of the figure, by default (5\*nb_params,5\*nb_params)</span>
<span class="sd">                figdpi : int, optional</span>
<span class="sd">                    dpi of the figure, by default 300</span>
<span class="sd">                logscale : bool, optional</span>
<span class="sd">                    use logscale, by default False</span>
<span class="sd">        &quot;&quot;&quot;</span>        

        <span class="n">figsize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;figsize&#39;</span><span class="p">,(</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
        <span class="n">figdpi</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;figdpi&#39;</span><span class="p">,</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">figext</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;figext&#39;</span><span class="p">,</span><span class="s1">&#39;.png&#39;</span><span class="p">)</span>
        <span class="n">savefig</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;savefig&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">savefig_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;savefig_name&#39;</span><span class="p">,</span><span class="s1">&#39;hypervolume&#39;</span><span class="p">)</span>
        <span class="n">logscale</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logscale&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">hv_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hv_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hv_list</span>

        <span class="n">hv_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">hv_list</span><span class="p">)</span>
        <span class="n">maxHV</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
            <span class="n">maxHV</span> <span class="o">=</span> <span class="n">maxHV</span><span class="o">*</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">]</span>
            
        <span class="n">figsize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;figsize&#39;</span><span class="p">,(</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
        <span class="n">figdpi</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;figdpi&#39;</span><span class="p">,</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">figext</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;figext&#39;</span><span class="p">,</span><span class="s1">&#39;.png&#39;</span><span class="p">)</span>
        <span class="n">savefig</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;savefig&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">savefig_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;savefig_name&#39;</span><span class="p">,</span><span class="s1">&#39;hypervolume&#39;</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">maxHV</span><span class="o">-</span><span class="n">hv_list</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">logscale</span><span class="p">:</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

        <span class="n">axes</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Batch iterations&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Hypervolume difference&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


    <span class="c1">###############################################################################</span>
    <span class="c1">############################ Posterior utils ##################################</span>
    <span class="c1">###############################################################################</span>
    <span class="c1"># Note that this is only for single objective optimization</span>
    <span class="c1"># While this part could be put in the optimizer.py main file, it is put here to give freedom to the user not to install the torch and Ax packages and only install the scikit-optimize package. In the future, this could be moved to the optimizer.py file.</span>

<div class="viewcode-block" id="MooBOtorch.expected_minimum_BOAR">
<a class="viewcode-back" href="../../../boar.core.html#boar.core.optimization_botorch.MooBOtorch.expected_minimum_BOAR">[docs]</a>
    <span class="k">def</span> <span class="nf">expected_minimum_BOAR</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">triedX</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="n">n_random_starts</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the minimum over the predictions of the last surrogate model.</span>
<span class="sd">        </span>
<span class="sd">        Note: that this will be useful only from single objective optimization and if the goal is to minimize the surrogate function.</span>

<span class="sd">        This was adapted from the scikit-optimize package. The original code can be found here:</span>
<span class="sd">        [scikit-optimize](https://scikit-optimize.github.io/stable/index.html) in the file scikit-optimize/skopt/utils.py</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ax_client : AxClient</span>
<span class="sd">            AxClient object.</span>
<span class="sd">        n_random_starts : int, default=20</span>
<span class="sd">            Number of points to sample randomly before fitting the surrogate</span>
<span class="sd">            model. If n_random_starts=0, then the initial point is taken as the</span>
<span class="sd">            best point seen so far (usually the last point in the GP model).</span>
<span class="sd">        random_state : int, RandomState instance or None, optional (default=None)</span>
<span class="sd">            Set random state to something other than None for reproducible</span>
<span class="sd">            results.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        x : ndarray, shape (n_features,)</span>
<span class="sd">            The point which minimizes the surrogate function.</span>
<span class="sd">        fun : float</span>
<span class="sd">            The surrogate function value at the minimum.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">p0</span><span class="p">,</span> <span class="n">lb</span><span class="p">,</span> <span class="n">ub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_r</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

        <span class="c1"># get previous trials</span>
        <span class="n">rx</span><span class="p">,</span><span class="n">vals</span> <span class="o">=</span> <span class="p">[],[]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">triedX</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">dum</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Arm Parameterizations&#39;</span><span class="p">]</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dum</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">rx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dum</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dum</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>


        <span class="k">if</span> <span class="n">n_random_starts</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Sample some points at random</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_random_starts</span><span class="p">):</span>
                <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">dum</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">relRange</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">dum</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">lb</span><span class="p">[</span><span class="n">counter</span><span class="p">],</span><span class="n">ub</span><span class="p">[</span><span class="n">counter</span><span class="p">])</span>
                        <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">rx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dum</span><span class="p">)</span>
                <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dum</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
                        
        
        <span class="n">dumdic</span> <span class="o">=</span> <span class="n">rx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">vals</span><span class="p">):</span> <span class="c1"># function to minimize</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dumdic</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">dumdic</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

            <span class="n">observation_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">ObservationFeatures</span><span class="p">(</span><span class="n">dumdic</span><span class="p">)]</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">gpr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">observation_features</span><span class="p">)</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># get the mean</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="c1"># get the key</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># get the value</span>
            <span class="k">return</span> <span class="n">pred</span>

        <span class="n">best_x</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_fun</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

        <span class="n">bounds</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span><span class="n">ub</span><span class="p">))</span> <span class="c1"># bounds for the parameters</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)):</span> <span class="c1"># loop over the previous trials</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">sp_minimize</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">fun</span> <span class="o">&lt;</span> <span class="n">best_fun</span><span class="p">:</span>
                <span class="n">best_x</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">x</span>
                <span class="n">best_fun</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">fun</span>
        
        <span class="k">return</span> <span class="n">best_x</span><span class="p">,</span> <span class="n">best_fun</span></div>


    <span class="c1"># def LH_torch_(self,X,beta,N,gpr,fscale=None):</span>
    <span class="c1">#     &quot;&quot;&quot;Compute the positive log likelihood from the negative log likelihood</span>

    <span class="c1">#     Be careful here! The loss and threshold used here are the ones define as arguments of the optimize_sko_parallel and not the one defined in the targets so for the calculation of the MSE to be consistent we need all targets to have the same loss and threshold!</span>

    <span class="c1">#     Parameters:</span>
    <span class="c1">#     X : ndarray</span>
    <span class="c1">#         X Data array of size(n,m): n=number of data points, m=number of dimensions</span>
    <span class="c1">#     beta : float</span>
    <span class="c1">#         1 / minimum of scaled surrogate function</span>
    <span class="c1">#     N : integer</span>
    <span class="c1">#         number of data points</span>
    <span class="c1">#     gpr : regressor</span>
    <span class="c1">#         a trained regressor which has a .predict() method</span>
    <span class="c1">#     fscale : float</span>
    <span class="c1">#         scaling factor to keep the surrogate function between 0 and 100 (yields best results in BO but</span>
    <span class="c1">#         here we need the unscaled surrogate function, that is, MSE), Not used here but might be later, default=None</span>
    <span class="c1">#     Returns</span>
    <span class="c1">#     -------</span>
    <span class="c1">#     float</span>
    <span class="c1">#         the positive log likelihood</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     rx = []</span>

    <span class="c1">#     for x in X:</span>
    <span class="c1">#         dumdic = {}</span>
    <span class="c1">#         counter = 0</span>
    <span class="c1">#         for p in self.params:</span>
    <span class="c1">#             if p.relRange != 0:</span>
    <span class="c1">#                 dumdic[p.name] = x[counter]</span>
    <span class="c1">#                 counter += 1</span>
    <span class="c1">#         rx.append(dumdic)</span>


    <span class="c1">#     Y = []</span>
    <span class="c1">#     for x in rx: # iterate through all the points to get the prediction</span>
    <span class="c1">#         observation_features = [ObservationFeatures(x)]</span>
    <span class="c1">#         pred = gpr.predict(observation_features)</span>
    <span class="c1">#         pred = pred[0] # get the mean</span>
    <span class="c1">#         key = list(pred.keys()) # get the key</span>
    <span class="c1">#         pred = pred[key[0]][0] # get the value</span>

    <span class="c1">#         # inverse the loss function to recover the true MSE</span>
    <span class="c1">#         pred = self.invert_lossfunc(pred,self.loss,self.threshold)</span>

    <span class="c1">#         Y.append(pred)</span>
    <span class="c1">#     Y = np.asarray(Y)</span>
    <span class="c1">#     SSE = Y*N # the sum of squared errors</span>
    <span class="c1">#     LLH = -beta/2 * SSE + N/2*np.log(beta) - N/2*np.log(2*np.pi) # Bishop eq. 1.62</span>

    <span class="c1">#     return LLH </span>

<div class="viewcode-block" id="MooBOtorch.LH_torch">
<a class="viewcode-back" href="../../../boar.core.html#boar.core.optimization_botorch.MooBOtorch.LH_torch">[docs]</a>
    <span class="k">def</span> <span class="nf">LH_torch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">beta</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">gpr</span><span class="p">,</span><span class="n">fscale</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the positive log likelihood from the negative log likelihood  </span>
<span class="sd">        Be careful here! The loss and threshold used here are the ones define as arguments of the optimize_sko_parallel and not the one defined in the targets so for the calculation of the MSE to be consistent we need all targets to have the same loss and threshold!  </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : ndarray</span>
<span class="sd">            X Data array of size(n,m): n=number of data points, m=number of dimensions</span>
<span class="sd">        beta : float</span>
<span class="sd">            1 / minimum of scaled surrogate function</span>
<span class="sd">        N : integer</span>
<span class="sd">            number of data points</span>
<span class="sd">        gpr : regressor</span>
<span class="sd">            a trained regressor which has a .predict() method</span>
<span class="sd">        fscale : float</span>
<span class="sd">            scaling factor to keep the surrogate function between 0 and 100 (yields best results in BO but</span>
<span class="sd">            here we need the unscaled surrogate function, that is, MSE), Not used here but might be later, default=None</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            the positive log likelihood</span>
<span class="sd">        &quot;&quot;&quot;</span>      
        <span class="n">rx</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">X</span><span class="p">:</span>
            <span class="n">dumdic</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">relRange</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">dumdic</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">counter</span><span class="p">]</span>
                    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">rx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dumdic</span><span class="p">)</span>


        <span class="n">observation_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">ObservationFeatures</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rx</span><span class="p">]</span>

        <span class="n">pred</span> <span class="o">=</span> <span class="n">gpr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">observation_features</span><span class="p">)</span>

        <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">invert_lossfunc</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span>
        
        <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
        <span class="n">SSE</span> <span class="o">=</span> <span class="n">Y</span><span class="o">*</span><span class="n">N</span> <span class="c1"># the sum of squared errors</span>
        <span class="n">LLH</span> <span class="o">=</span> <span class="o">-</span><span class="n">beta</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="n">SSE</span> <span class="o">+</span> <span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span> <span class="o">-</span> <span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="c1"># Bishop eq. 1.62</span>

        <span class="k">return</span> <span class="n">LLH</span> </div>


    


    

<div class="viewcode-block" id="MooBOtorch.do_grid_posterior">
<a class="viewcode-back" href="../../../boar.core.html#boar.core.optimization_botorch.MooBOtorch.do_grid_posterior">[docs]</a>
    <span class="k">def</span> <span class="nf">do_grid_posterior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">step</span><span class="p">,</span><span class="n">fig</span><span class="p">,</span><span class="n">axes</span><span class="p">,</span><span class="n">gs</span><span class="p">,</span><span class="n">lb</span><span class="p">,</span><span class="n">ub</span><span class="p">,</span><span class="n">pf</span><span class="p">,</span><span class="n">beta_scaled</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="n">fscale</span><span class="p">,</span> <span class="n">Nres</span><span class="p">,</span> <span class="n">logscale</span><span class="p">,</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">min_prob</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span> <span class="n">clear_axis</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">True_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">points</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtain the posterior probability distribution p(w|y) by brute force gridding</span>
<span class="sd">        where w is the set of model parameters and y is the data</span>
<span class="sd">        For each fitparameter, return mean and standard deviation</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        step : int</span>
<span class="sd">            Number of zooming steps</span>
<span class="sd">        fig : matplotlib.figure.Figure</span>
<span class="sd">            Figure to plot on</span>
<span class="sd">        axes : list</span>
<span class="sd">            List of axes to plot on</span>
<span class="sd">        gs : matplotlib.gridspec.GridSpec</span>
<span class="sd">            Gridspec to plot on</span>
<span class="sd">        lb : list</span>
<span class="sd">            Lower bounds of the grid</span>
<span class="sd">        ub : list</span>
<span class="sd">            Upper bounds of the grid</span>
<span class="sd">        pf : list</span>
<span class="sd">            List of parameters</span>
<span class="sd">        N : integer</span>
<span class="sd">            number of datasets</span>
<span class="sd">        gpr : scikit-optimize estimator</span>
<span class="sd">            trained regressor</span>
<span class="sd">        fscale : float</span>
<span class="sd">            scaling factor </span>
<span class="sd">        Nres : integer</span>
<span class="sd">            Sampling resolution. Number of data points per dimension.</span>
<span class="sd">        logscale : boolean</span>
<span class="sd">            display in log scale?</span>
<span class="sd">        vmin : float</span>
<span class="sd">            lower cutoff (in terms of exp(vmin) if logscale==True)</span>
<span class="sd">        zoom : int, optional</span>
<span class="sd">            number of time to zoom in, by default 1.</span>
<span class="sd">        min_prob : float, optional</span>
<span class="sd">            minimum probability to consider when zooming in we will zoom on the parameter space with a probability higher than min_prob, by default 1e-40.</span>
<span class="sd">        clear_axis : boolean, optional</span>
<span class="sd">            clear the axis before plotting the zoomed in data, by default False.</span>
<span class="sd">        True_values : dict, optional</span>
<span class="sd">            dictionary of true values of the parameters, by default None</span>
<span class="sd">        points : array, optional</span>
<span class="sd">            array of explored points in the parameter space during the optimization, by default None</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        &quot;&quot;&quot;</span> 

        <span class="n">pnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pf</span> <span class="k">if</span> <span class="n">pp</span><span class="o">.</span><span class="n">relRange</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># pnames_display = [pp.display_name for pp in pf if pp.relRange!=0] # for plots axis labels</span>
        <span class="n">pnames_main</span> <span class="o">=</span> <span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pf</span><span class="p">]</span>
        <span class="n">pnames_display</span> <span class="o">=</span> <span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">full_name</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pf</span> <span class="k">if</span> <span class="n">pp</span><span class="o">.</span><span class="n">relRange</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">axis_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">axis_type</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pf</span> <span class="k">if</span> <span class="n">pp</span><span class="o">.</span><span class="n">relRange</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># to get the type of the axis for the plots</span>
        <span class="n">optim_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">optim_type</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pf</span> <span class="k">if</span> <span class="n">pp</span><span class="o">.</span><span class="n">relRange</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># to get the type of the axis for the plots</span>
        <span class="n">pval</span> <span class="o">=</span> <span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">val</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pf</span> <span class="k">if</span> <span class="n">pp</span><span class="o">.</span><span class="n">relRange</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">p0ms</span> <span class="o">=</span> <span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">p0m</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pf</span> <span class="k">if</span> <span class="n">pp</span><span class="o">.</span><span class="n">relRange</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">p0ms</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">ii</span> <span class="o">==</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">p0ms</span><span class="p">]</span> <span class="c1"># replace None with 1 in p0ms as we will multiply with it</span>
        <span class="n">rescales</span> <span class="o">=</span> <span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">rescale</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pf</span> <span class="k">if</span> <span class="n">pp</span><span class="o">.</span><span class="n">relRange</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># get varied fitparams</span>
        <span class="c1"># pf = [pp for pp in self.targets[-1][&#39;params&#39;] if pp.relRange!=0]</span>
        <span class="n">p0</span><span class="p">,</span> <span class="n">lb_main</span><span class="p">,</span> <span class="n">ub_main</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_r</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span>

        <span class="c1"># make sure that all the pnames are in the true values</span>
        <span class="n">plot_true_values</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">True_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pnames</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pp</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">True_values</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">plot_true_values</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: true values not provided for all parameters. True values will not be plotted&#39;</span><span class="p">)</span>
                    <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot_true_values</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: true values not provided. True values will not be plotted&#39;</span><span class="p">)</span>
            <span class="c1"># if verbose:</span>
            <span class="c1">#     print(&#39;WARNING: true values not provided. True values will not be plotted&#39;)</span>

        <span class="n">plot_points</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plot_points</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># if points.shape[1] != len(pnames):</span>
            <span class="c1">#     plot_points = False</span>
            <span class="c1">#     print(&#39;WARNING: points provided do not have the same dimension as the parameters. Points will not be plotted&#39;)</span>

        <span class="c1"># create grid</span>
        <span class="n">dims</span><span class="p">,</span><span class="n">dims_GP</span> <span class="o">=</span> <span class="p">[],[]</span>
        <span class="n">Nreso</span> <span class="o">=</span> <span class="n">Nres</span> 
        <span class="c1"># create grid and reconvert the parameters to the original scale</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">pff</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pf</span><span class="p">):</span> 
            <span class="k">if</span> <span class="n">pff</span><span class="o">.</span><span class="n">relRange</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">parax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lb</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span><span class="n">ub</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span><span class="n">Nreso</span><span class="p">)</span>
                <span class="c1"># add the best fit value if provided</span>
                <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">optim_type</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">rescale</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">best_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">pf</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">best_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">pf</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">val</span><span class="o">/</span><span class="n">pf</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">best_val</span> <span class="o">=</span> <span class="n">pf</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">val</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">best_val</span> <span class="o">=</span> <span class="n">pf</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">val</span><span class="o">/</span><span class="n">pf</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">best_val</span> <span class="o">=</span> <span class="n">pf</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">val</span><span class="o">/</span><span class="n">pf</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span>
                
                <span class="c1"># put best value in par_ax and sort</span>
                <span class="n">parax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parax</span><span class="p">,</span><span class="n">best_val</span><span class="p">))</span>


                <span class="k">if</span> <span class="n">pff</span><span class="o">.</span><span class="n">optim_type</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
                    <span class="n">dum_lb</span> <span class="o">=</span> <span class="n">lb</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="n">pff</span><span class="o">.</span><span class="n">p0m</span>
                    <span class="n">dum_ub</span> <span class="o">=</span> <span class="n">ub</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="n">pff</span><span class="o">.</span><span class="n">p0m</span>
                    <span class="c1"># dims.append(np.linspace(dum_lb,dum_ub,Nreso))</span>
                    <span class="n">dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parax</span><span class="o">*</span><span class="n">pff</span><span class="o">.</span><span class="n">p0m</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">pff</span><span class="o">.</span><span class="n">optim_type</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pff</span><span class="o">.</span><span class="n">rescale</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">pff</span><span class="o">.</span><span class="n">p0m</span> <span class="o">==</span> <span class="kc">None</span> <span class="p">:</span>
                            <span class="n">dum_lb</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">lb</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
                            <span class="n">dum_ub</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">ub</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
                            <span class="n">dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">parax</span><span class="p">))</span>
                        <span class="k">else</span> <span class="p">:</span>
                            <span class="n">dum_lb</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">lb</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">*</span><span class="n">pff</span><span class="o">.</span><span class="n">p0m</span>
                            <span class="n">dum_ub</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">ub</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">*</span><span class="n">pff</span><span class="o">.</span><span class="n">p0m</span>
                            <span class="n">dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">parax</span><span class="p">)</span><span class="o">*</span><span class="n">pff</span><span class="o">.</span><span class="n">p0m</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">pff</span><span class="o">.</span><span class="n">p0m</span> <span class="o">==</span> <span class="kc">None</span> <span class="p">:</span>
                            <span class="n">dum_lb</span> <span class="o">=</span> <span class="n">lb</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                            <span class="n">dum_ub</span> <span class="o">=</span> <span class="n">ub</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                            <span class="n">dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parax</span><span class="p">)</span>
                        <span class="k">else</span> <span class="p">:</span>
                            <span class="n">dum_lb</span> <span class="o">=</span> <span class="n">lb</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">pff</span><span class="o">.</span><span class="n">p0m</span>
                            <span class="n">dum_ub</span> <span class="o">=</span> <span class="n">ub</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">pff</span><span class="o">.</span><span class="n">p0m</span>
                            <span class="n">dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parax</span><span class="o">*</span><span class="n">pff</span><span class="o">.</span><span class="n">p0m</span><span class="p">)</span>
                    <span class="c1"># dims.append(np.geomspace(dum_lb,dum_ub,Nreso))</span>
                    
                <span class="k">else</span><span class="p">:</span> 
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ERROR. &#39;</span><span class="p">,</span><span class="n">pff</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="s1">&#39; optim_type needs to be &#39;&#39;linear&#39;&#39; or &#39;&#39;log&#39;&#39; not &#39;</span><span class="p">,</span><span class="n">pff</span><span class="o">.</span><span class="n">optim_type</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>

                <span class="c1"># dims_GP.append(np.linspace(lb[ii],ub[ii],Nreso))   #need as an input for the GP</span>
                <span class="n">dims_GP</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parax</span><span class="p">)</span>   <span class="c1">#need as an input for the GP</span>
            
 
        <span class="k">if</span> <span class="n">logscale</span><span class="p">:</span> <span class="c1"># if we are in logscale, we need to transform the grid</span>
            <span class="n">min_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">min_prob</span><span class="p">)</span>
            <span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">vmin</span><span class="p">)</span>

        <span class="c1"># get the main grid</span>
        <span class="n">p0</span><span class="p">,</span> <span class="n">lb_old</span><span class="p">,</span> <span class="n">ub_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_r</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="c1"># get the main parameter grid bounds</span>
        <span class="c1"># initialize figure</span>
        <span class="n">nb_params</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span>
        
        <span class="c1"># build complete matrix</span>
        <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">XC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">dims_GP</span><span class="p">)))</span>

        <span class="c1">## Make sure that len(Xc) &lt; 1e7 otherwise we risk to fill up the RAM</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">XC</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e6</span><span class="p">:</span>
            <span class="n">Xcc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">XC</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">XC</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">XC</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">ii</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">aa0prime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LH_torch</span><span class="p">(</span><span class="n">Xcc</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span><span class="n">beta_scaled</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">gpr</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">aa0prime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">aa0prime</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">LH_torch</span><span class="p">(</span><span class="n">Xcc</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span><span class="n">beta_scaledN</span><span class="p">,</span><span class="n">gpr</span><span class="p">)))</span>
            
            <span class="n">aa1</span> <span class="o">=</span> <span class="n">aa0prime</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">Nreso</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pf</span><span class="p">))])</span> <span class="c1"># bring it into array format</span>
            <span class="c1"># Note: the Nreso plus one comes from adding the best fit value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">aa0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LH_torch</span><span class="p">(</span><span class="n">XC</span><span class="p">,</span><span class="n">beta_scaled</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">gpr</span><span class="p">)</span><span class="c1"># predict them all at once</span>
            <span class="n">aa1</span> <span class="o">=</span> <span class="n">aa0</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">Nreso</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pf</span><span class="p">))])</span> <span class="c1"># bring it into array format</span>
            <span class="c1"># Note: the Nreso plus one comes from adding the best fit value</span>
        <span class="c1"># build the single 2D panels</span>
        
        <span class="k">for</span> <span class="n">comb</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nb_params</span><span class="p">),</span> <span class="mi">2</span><span class="p">)):</span>
            <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span> <span class="o">=</span> <span class="n">comb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">comb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> 

            <span class="n">margax</span> <span class="o">=</span> <span class="p">[</span><span class="n">dd</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_params</span><span class="p">)</span> <span class="k">if</span> <span class="n">dd</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">d1</span><span class="p">,</span><span class="n">d2</span><span class="p">]]</span> <span class="c1"># the axes over which to marginalize</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39; old way</span>
<span class="sd">            margax = [dd for dd in range(nb_params) if dd not in [d1,d2]] # the axes over which to marginalize</span>
<span class="sd">            LHS = logsumexp(aa1,axis = tuple(margax))</span>
<span class="sd">            # LHS-=np.max(LHS) # avoid underflow by setting the max to zero</span>
<span class="sd">            </span>
<span class="sd">            # if logscale:</span>
<span class="sd">            #     LHS[LHS&lt;vmin]=vmin</span>
<span class="sd">            #     vmin = vmin</span>
<span class="sd">            #     vmax = 0</span>
<span class="sd">            # else:</span>
<span class="sd">            #     LHS = np.exp(LHS) # do the exponential =&gt; now it&#39;s prop. to probability</span>
<span class="sd">            #     # LHS/=np.sum(LHS)</span>
<span class="sd">            #     vmin = 0</span>
<span class="sd">            #     # vmax = 1</span>
<span class="sd">            #     vmax = np.max(LHS)</span>

<span class="sd">            # test </span>
<span class="sd">            LHS = np.exp(LHS) # do the exponential =&gt; now it&#39;s prop. to probability</span>
<span class="sd">            total = np.sum(LHS)</span>
<span class="sd">            LHS/=total</span>

<span class="sd">            ######################</span>
<span class="sd">            # LHS = np.exp(aa1) # do the exponential =&gt; now it&#39;s prop. to probability</span>
<span class="sd">            # prob = np.sum(LHS,axis=tuple(margax))</span>
<span class="sd">            # prob = prob/np.sum(prob) # normalize to 1</span>
<span class="sd">            # LHS = prob</span>
<span class="sd">            ######################</span>
<span class="sd">            &#39;&#39;&#39;</span>

            <span class="c1"># Calculate the marginal posterior probability distribution p(w|y) for parameter ii by integrating over the other parameters</span>
            <span class="n">lhlog</span> <span class="o">=</span> <span class="n">logsumexp</span><span class="p">(</span><span class="n">aa1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">margax</span><span class="p">))</span> <span class="c1"># logsumexp is more accurate than np.log(np.sum(np.exp(lh),axis=1))</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lhlog</span><span class="o">-</span><span class="n">logsumexp</span><span class="p">(</span><span class="n">lhlog</span><span class="p">))</span> <span class="c1">#normalize the likelihood</span>
            <span class="n">LHS</span> <span class="o">=</span> <span class="n">p</span>
            
            <span class="k">if</span> <span class="n">logscale</span><span class="p">:</span>
                <span class="n">LHS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">LHS</span><span class="p">)</span>
                <span class="n">LHS</span><span class="p">[</span><span class="n">LHS</span><span class="o">&lt;</span><span class="n">vmin</span><span class="p">]</span><span class="o">=</span><span class="n">vmin</span>
                <span class="n">vmin</span> <span class="o">=</span> <span class="n">vmin</span>
                <span class="n">vmax</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vmin</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">vmax</span> <span class="o">=</span> <span class="mi">1</span>


            <span class="k">if</span> <span class="n">clear_axis</span><span class="p">:</span> <span class="c1"># clear the axes for the zoomed in version</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">d2</span><span class="p">][</span><span class="n">d1</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span> <span class="c1"># clear the previous plot</span>
            
            
            <span class="n">axes</span><span class="p">[</span><span class="n">d2</span><span class="p">][</span><span class="n">d1</span><span class="p">]</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="n">d1</span><span class="p">],</span><span class="n">dims</span><span class="p">[</span><span class="n">d2</span><span class="p">],</span><span class="n">LHS</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">d1</span><span class="p">][</span><span class="n">d2</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span> <span class="c1"># remove the upper triangle</span>
            
            
            <span class="c1"># plot the points</span>
            <span class="k">if</span> <span class="n">plot_points</span><span class="p">:</span>
                <span class="n">pred1_plot</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">d1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">points</span><span class="p">]</span>
                <span class="n">pred2_plot</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">d2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">points</span><span class="p">]</span>
                <span class="c1"># convert back to the right values  </span>
                <span class="k">if</span> <span class="n">optim_type</span><span class="p">[</span><span class="n">d1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">rescales</span><span class="p">[</span><span class="n">d1</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">pred1_plot</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pred1_plot</span><span class="p">))</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">d1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pred1_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pred1_plot</span><span class="p">)</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">d1</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">optim_type</span><span class="p">[</span><span class="n">d1</span><span class="p">]</span><span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
                    <span class="n">pred1_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pred1_plot</span><span class="p">)</span> <span class="o">*</span> <span class="n">p0ms</span><span class="p">[</span><span class="n">d1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ERROR. &#39;</span><span class="p">,</span><span class="n">pnames</span><span class="p">[</span><span class="n">d1</span><span class="p">],</span><span class="s1">&#39; optim_type needs to be &#39;&#39;linear&#39;&#39; or &#39;&#39;log&#39;&#39; not &#39;</span><span class="p">,</span><span class="n">pf</span><span class="p">[</span><span class="n">d1</span><span class="p">]</span><span class="o">.</span><span class="n">optim_type</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">optim_type</span><span class="p">[</span><span class="n">d2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">rescales</span><span class="p">[</span><span class="n">d2</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">pred2_plot</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pred2_plot</span><span class="p">))</span> <span class="o">*</span> <span class="n">p0ms</span><span class="p">[</span><span class="n">d2</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pred2_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pred2_plot</span><span class="p">)</span> <span class="o">*</span> <span class="n">p0ms</span><span class="p">[</span><span class="n">d2</span><span class="p">]</span>

                <span class="k">elif</span> <span class="n">optim_type</span><span class="p">[</span><span class="n">d2</span><span class="p">]</span><span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
                    <span class="n">pred2_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pred2_plot</span><span class="p">)</span> <span class="o">*</span> <span class="n">p0ms</span><span class="p">[</span><span class="n">d2</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ERROR. &#39;</span><span class="p">,</span><span class="n">pnames</span><span class="p">[</span><span class="n">d2</span><span class="p">],</span><span class="s1">&#39; optim_type needs to be &#39;&#39;linear&#39;&#39; or &#39;&#39;log&#39;&#39; not &#39;</span><span class="p">,</span><span class="n">pf</span><span class="p">[</span><span class="n">d2</span><span class="p">]</span><span class="o">.</span><span class="n">optim_type</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>

                <span class="n">axes</span><span class="p">[</span><span class="n">d2</span><span class="p">][</span><span class="n">d1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pred1_plot</span><span class="p">,</span><span class="n">pred2_plot</span><span class="p">,</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            
            <span class="c1"># plot the true values</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">plot_true_values</span><span class="p">:</span> 
                    <span class="n">axes</span><span class="p">[</span><span class="n">d2</span><span class="p">][</span><span class="n">d1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">True_values</span><span class="p">[</span><span class="n">pnames</span><span class="p">[</span><span class="n">d1</span><span class="p">]],</span><span class="n">True_values</span><span class="p">[</span><span class="n">pnames</span><span class="p">[</span><span class="n">d2</span><span class="p">]],</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;C3&#39;</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;WARNING. Could not plot the true values either &#39;</span><span class="o">+</span><span class="n">pnames</span><span class="p">[</span><span class="n">d1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; or &#39;</span><span class="o">+</span><span class="n">pnames</span><span class="p">[</span><span class="n">d2</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; are not in the True_values dictionary.&#39;</span><span class="p">)</span>
            <span class="c1"># plot the best fit values</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">d2</span><span class="p">][</span><span class="n">d1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pf</span><span class="p">[</span><span class="n">d1</span><span class="p">]</span><span class="o">.</span><span class="n">val</span><span class="p">,</span><span class="n">pf</span><span class="p">[</span><span class="n">d2</span><span class="p">]</span><span class="o">.</span><span class="n">val</span><span class="p">,</span><span class="s1">&#39;C2X&#39;</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

            <span class="c1"># Prepare the axis labels and ticks</span>
            <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">clear_axis</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">d1</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">d2</span><span class="p">][</span><span class="n">d1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">pnames_display</span><span class="p">[</span><span class="n">d2</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">axis_type</span><span class="p">[</span><span class="n">d2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span> <span class="c1"># set the ticks to be in log scale</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">d2</span><span class="p">][</span><span class="n">d1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">axis_type</span><span class="p">[</span><span class="n">d2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span> <span class="c1"># set the ticks to be in log scale</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">d2</span><span class="p">][</span><span class="n">d1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">d2</span><span class="p">][</span><span class="n">d1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span> <span class="c1"># remove the ticks</span>


                <span class="k">if</span> <span class="n">d2</span><span class="o">==</span><span class="n">nb_params</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">d2</span><span class="p">][</span><span class="n">d1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">pnames_display</span><span class="p">[</span><span class="n">d1</span><span class="p">])</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">d2</span><span class="p">][</span><span class="n">d1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">labelrotation</span> <span class="o">=</span> <span class="mi">45</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">axis_type</span><span class="p">[</span><span class="n">d1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span> <span class="c1"># set the ticks to be in log scale</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">d2</span><span class="p">][</span><span class="n">d1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">axis_type</span><span class="p">[</span><span class="n">d1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span> <span class="c1"># set the ticks to be in log scale</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">d2</span><span class="p">][</span><span class="n">d1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">d2</span><span class="p">][</span><span class="n">d1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span> <span class="c1"># remove the ticks</span>
                
                <span class="c1"># set the limits</span>
                <span class="k">if</span> <span class="n">optim_type</span><span class="p">[</span><span class="n">d1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">d2</span><span class="p">][</span><span class="n">d1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="n">lb</span><span class="p">[</span><span class="n">d1</span><span class="p">]</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">d1</span><span class="p">],</span><span class="n">ub</span><span class="p">[</span><span class="n">d1</span><span class="p">]</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">d1</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="n">optim_type</span><span class="p">[</span><span class="n">d1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">rescales</span><span class="p">[</span><span class="n">d1</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">d2</span><span class="p">][</span><span class="n">d1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">lb</span><span class="p">[</span><span class="n">d1</span><span class="p">])</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">d1</span><span class="p">],</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">ub</span><span class="p">[</span><span class="n">d1</span><span class="p">])</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">d1</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">d2</span><span class="p">][</span><span class="n">d1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="n">lb</span><span class="p">[</span><span class="n">d1</span><span class="p">]</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">d1</span><span class="p">],</span><span class="n">ub</span><span class="p">[</span><span class="n">d1</span><span class="p">]</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">d1</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ERROR. &#39;</span><span class="p">,</span><span class="n">pnames</span><span class="p">[</span><span class="n">d1</span><span class="p">],</span><span class="s1">&#39; optim_type needs to be &#39;&#39;linear&#39;&#39; or &#39;&#39;log&#39;&#39; not &#39;</span><span class="p">,</span><span class="n">optim_type</span><span class="p">[</span><span class="n">d1</span><span class="p">],</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">optim_type</span><span class="p">[</span><span class="n">d2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">d2</span><span class="p">][</span><span class="n">d1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="n">lb</span><span class="p">[</span><span class="n">d2</span><span class="p">]</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">d2</span><span class="p">],</span><span class="n">ub</span><span class="p">[</span><span class="n">d2</span><span class="p">]</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">d2</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="n">optim_type</span><span class="p">[</span><span class="n">d2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">rescales</span><span class="p">[</span><span class="n">d2</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">d2</span><span class="p">][</span><span class="n">d1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">lb</span><span class="p">[</span><span class="n">d2</span><span class="p">])</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">d2</span><span class="p">],</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">ub</span><span class="p">[</span><span class="n">d2</span><span class="p">])</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">d2</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">d2</span><span class="p">][</span><span class="n">d1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="n">lb</span><span class="p">[</span><span class="n">d2</span><span class="p">]</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">d2</span><span class="p">],</span><span class="n">ub</span><span class="p">[</span><span class="n">d2</span><span class="p">]</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">d2</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ERROR. &#39;</span><span class="p">,</span><span class="n">pnames</span><span class="p">[</span><span class="n">d2</span><span class="p">],</span><span class="s1">&#39; optim_type needs to be &#39;&#39;linear&#39;&#39; or &#39;&#39;log&#39;&#39; not &#39;</span><span class="p">,</span><span class="n">optim_type</span><span class="p">[</span><span class="n">d2</span><span class="p">],</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># keep main axis limits</span>
                <span class="c1"># set the limits</span>
                <span class="k">if</span> <span class="n">optim_type</span><span class="p">[</span><span class="n">d1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">d2</span><span class="p">][</span><span class="n">d1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="n">lb_main</span><span class="p">[</span><span class="n">d1</span><span class="p">]</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">d1</span><span class="p">],</span><span class="n">ub_main</span><span class="p">[</span><span class="n">d1</span><span class="p">]</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">d1</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="n">optim_type</span><span class="p">[</span><span class="n">d1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">rescales</span><span class="p">[</span><span class="n">d1</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">d2</span><span class="p">][</span><span class="n">d1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">lb_main</span><span class="p">[</span><span class="n">d1</span><span class="p">])</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">d1</span><span class="p">],</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">ub_main</span><span class="p">[</span><span class="n">d1</span><span class="p">])</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">d1</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">d2</span><span class="p">][</span><span class="n">d1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="n">lb_main</span><span class="p">[</span><span class="n">d1</span><span class="p">]</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">d1</span><span class="p">],</span><span class="n">ub_main</span><span class="p">[</span><span class="n">d1</span><span class="p">]</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">d1</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ERROR. &#39;</span><span class="p">,</span><span class="n">pnames</span><span class="p">[</span><span class="n">d1</span><span class="p">],</span><span class="s1">&#39; optim_type needs to be &#39;&#39;linear&#39;&#39; or &#39;&#39;log&#39;&#39; not &#39;</span><span class="p">,</span><span class="n">optim_type</span><span class="p">[</span><span class="n">d1</span><span class="p">],</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">optim_type</span><span class="p">[</span><span class="n">d2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">d2</span><span class="p">][</span><span class="n">d1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="n">lb_main</span><span class="p">[</span><span class="n">d2</span><span class="p">]</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">d2</span><span class="p">],</span><span class="n">ub_main</span><span class="p">[</span><span class="n">d2</span><span class="p">]</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">d2</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="n">optim_type</span><span class="p">[</span><span class="n">d2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">rescales</span><span class="p">[</span><span class="n">d2</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">d2</span><span class="p">][</span><span class="n">d1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">lb_main</span><span class="p">[</span><span class="n">d2</span><span class="p">])</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">d2</span><span class="p">],</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">ub_main</span><span class="p">[</span><span class="n">d2</span><span class="p">])</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">d2</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">d2</span><span class="p">][</span><span class="n">d1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="n">lb_main</span><span class="p">[</span><span class="n">d2</span><span class="p">]</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">d2</span><span class="p">],</span><span class="n">ub_main</span><span class="p">[</span><span class="n">d2</span><span class="p">]</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">d2</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ERROR. &#39;</span><span class="p">,</span><span class="n">pnames</span><span class="p">[</span><span class="n">d2</span><span class="p">],</span><span class="s1">&#39; optim_type needs to be &#39;&#39;linear&#39;&#39; or &#39;&#39;log&#39;&#39; not &#39;</span><span class="p">,</span><span class="n">optim_type</span><span class="p">[</span><span class="n">d2</span><span class="p">],</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>

        <span class="c1"># finally, build the 1D panels</span>
        <span class="c1"># in doing so, collect also the means and stds to write back to params</span>
        <span class="n">xx</span><span class="p">,</span><span class="n">stdx</span> <span class="o">=</span> <span class="p">[],[]</span>
        <span class="c1"># initialize the new bounds</span>
        
        <span class="n">lb_new</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">lb</span><span class="p">)</span>
        <span class="n">ub_new</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ub</span><span class="p">)</span>

        <span class="c1"># if step == 0:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ub</span><span class="p">,</span><span class="n">lb</span><span class="p">):</span> <span class="c1"># Make sure that bounds are put at the right order of magnitude </span>
            <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">optim_type</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
                <span class="n">ub_new</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*=</span> <span class="n">p0ms</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">lb_new</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*=</span> <span class="n">p0ms</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">optim_type</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">rescale</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">ub_new</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">ub_new</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">p0ms</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">lb_new</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">lb_new</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">p0ms</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ub_new</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">ub_new</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">p0ms</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">lb_new</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">lb_new</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">p0ms</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ERROR. &#39;</span><span class="p">,</span><span class="n">pf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="s1">&#39; optim_type needs to be &#39;&#39;linear&#39;&#39; or &#39;&#39;log&#39;&#39; not &#39;</span><span class="p">,</span><span class="n">pf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">optim_type</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">idx</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">std95</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">comb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_params</span><span class="p">):</span>
            <span class="n">margax</span> <span class="o">=</span> <span class="p">[</span><span class="n">dd</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_params</span><span class="p">)</span> <span class="k">if</span> <span class="n">dd</span> <span class="o">!=</span><span class="n">comb</span><span class="p">]</span> <span class="c1"># the axes over which to marginalize</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39; old way</span>
<span class="sd">            # LHS = logsumexp(aa1,axis = tuple(margax))</span>
<span class="sd">            # LHS-=np.max(LHS) # avoid underflow by setting the max to zero</span>
<span class="sd">            # LHS = np.exp(LHS) # do the exponential =&gt; now it&#39;s prop. to probability</span>
<span class="sd">            &#39;&#39;&#39;</span>

            <span class="n">lhlog</span> <span class="o">=</span> <span class="n">logsumexp</span><span class="p">(</span><span class="n">aa1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">margax</span><span class="p">))</span> <span class="c1"># logsumexp is more accurate than np.log(np.sum(np.exp(lh),axis=1))</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lhlog</span><span class="o">-</span><span class="n">logsumexp</span><span class="p">(</span><span class="n">lhlog</span><span class="p">))</span> <span class="c1">#normalize the likelihood</span>
            <span class="n">LHS</span> <span class="o">=</span> <span class="n">p</span>


            <span class="k">if</span> <span class="n">logscale</span><span class="p">:</span>
                <span class="n">LHS</span><span class="p">[</span><span class="n">LHS</span><span class="o">&lt;</span><span class="mi">10</span><span class="o">**</span><span class="n">vmin</span><span class="p">]</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="n">vmin</span>
                <span class="n">vmin</span> <span class="o">=</span> <span class="n">vmin</span>
                <span class="n">vmax</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vmin</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">vmax</span> <span class="o">=</span> <span class="mi">1</span>
            
            <span class="n">axes</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="n">comb</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span> <span class="c1"># clear the previous plot</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="n">comb</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="n">comb</span><span class="p">],</span><span class="n">LHS</span><span class="p">)</span>

            <span class="c1"># plot true values as a line</span>
            <span class="k">if</span> <span class="n">plot_true_values</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="n">comb</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">True_values</span><span class="p">[</span><span class="n">pnames</span><span class="p">[</span><span class="n">comb</span><span class="p">]],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;C3&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="n">comb</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">True_values</span><span class="p">[</span><span class="n">pnames</span><span class="p">[</span><span class="n">comb</span><span class="p">]],</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;C3*&#39;</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
                
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;WARNING. Could not plot true value for &#39;</span><span class="o">+</span><span class="n">pnames</span><span class="p">[</span><span class="n">comb</span><span class="p">])</span>


            <span class="k">if</span> <span class="n">logscale</span><span class="p">:</span>
                <span class="n">cut_prob</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">min_prob</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cut_prob</span> <span class="o">=</span> <span class="n">min_prob</span>
                
            <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="n">comb</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">LHS</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">cut_prob</span><span class="p">:</span>
                    <span class="n">lb_new</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span> <span class="o">=</span> <span class="n">dims</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>


            <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="n">comb</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">LHS</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="n">comb</span><span class="p">])</span><span class="o">-</span><span class="n">idx</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">cut_prob</span><span class="p">:</span>
                    <span class="n">ub_new</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span> <span class="o">=</span> <span class="n">dims</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="n">comb</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">idx</span><span class="p">]</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># prepare the axis labels and ticks       </span>
            <span class="c1"># if step == 0 or clear_axis:</span>
            <span class="k">if</span> <span class="n">comb</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">logscale</span><span class="p">:</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="n">comb</span><span class="p">]</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="n">comb</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;P(w|y)&#39;</span><span class="p">)</span> 
                    <span class="c1"># axes[comb][comb].set_ylim((10**vmin,2)) </span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="n">comb</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">10</span><span class="o">**</span><span class="n">vmin</span><span class="p">,</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">vmin</span><span class="o">/</span><span class="mi">2</span><span class="p">)),</span><span class="mi">1</span><span class="p">],</span> <span class="n">minor</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="n">comb</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;P(w|y)&#39;</span><span class="p">)</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="n">comb</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">minor</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> 
                    <span class="c1"># axes[comb][comb].set_ylim((0,2))</span>
                    <span class="c1"># axes[comb][comb].set_ylim((0,2))    </span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="n">comb</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="n">comb</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">labelright</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">logscale</span><span class="p">:</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="n">comb</span><span class="p">]</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
                    <span class="c1"># axes[comb][comb].set_ylim((10**vmin,2))</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="n">comb</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">10</span><span class="o">**</span><span class="n">vmin</span><span class="p">,</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">vmin</span><span class="o">/</span><span class="mi">2</span><span class="p">)),</span><span class="mi">1</span><span class="p">],</span> <span class="n">minor</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="n">comb</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">minor</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="c1"># axes[comb][comb].set_ylim((0,2))</span>

            <span class="k">if</span> <span class="n">axis_type</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span> <span class="c1"># set the ticks to be in log scale</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="n">comb</span><span class="p">]</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">comb</span><span class="o">==</span><span class="n">nb_params</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="n">comb</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">pnames_display</span><span class="p">[</span><span class="n">comb</span><span class="p">])</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="n">comb</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">labelrotation</span> <span class="o">=</span> <span class="mi">45</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
                
                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="n">comb</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span> <span class="c1"># remove the ticks</span>

            <span class="c1"># set same limits as in the 2D plots</span>
            <span class="k">if</span> <span class="n">clear_axis</span> <span class="ow">or</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">optim_type</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="n">comb</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="n">lb</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">comb</span><span class="p">],</span><span class="n">ub</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">comb</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="n">optim_type</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">rescales</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="n">comb</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">lb</span><span class="p">[</span><span class="n">comb</span><span class="p">])</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">comb</span><span class="p">],</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">ub</span><span class="p">[</span><span class="n">comb</span><span class="p">])</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">comb</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="n">comb</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="n">lb</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">comb</span><span class="p">],</span><span class="n">ub</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">comb</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ERROR. &#39;</span><span class="p">,</span><span class="n">pnames</span><span class="p">[</span><span class="n">comb</span><span class="p">],</span><span class="s1">&#39; optim_type needs to be &#39;&#39;linear&#39;&#39; or &#39;&#39;log&#39;&#39; not &#39;</span><span class="p">,</span><span class="n">optim_type</span><span class="p">[</span><span class="n">comb</span><span class="p">],</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                    
            <span class="k">else</span><span class="p">:</span> <span class="c1"># keep main axis limits</span>
                <span class="k">if</span> <span class="n">optim_type</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="n">comb</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="n">lb_main</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">comb</span><span class="p">],</span><span class="n">ub_main</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">comb</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="n">optim_type</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">rescales</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="n">comb</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">lb_main</span><span class="p">[</span><span class="n">comb</span><span class="p">])</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">comb</span><span class="p">],</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">ub_main</span><span class="p">[</span><span class="n">comb</span><span class="p">])</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">comb</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="n">comb</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="n">lb_main</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">comb</span><span class="p">],</span><span class="n">ub_main</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">comb</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ERROR. &#39;</span><span class="p">,</span><span class="n">pnames</span><span class="p">[</span><span class="n">comb</span><span class="p">],</span><span class="s1">&#39; optim_type needs to be &#39;&#39;linear&#39;&#39; or &#39;&#39;log&#39;&#39; not &#39;</span><span class="p">,</span><span class="n">optim_type</span><span class="p">[</span><span class="n">comb</span><span class="p">],</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>



            <span class="c1"># get moments of cumulative probability density</span>
            <span class="c1"># pd = LHS</span>
            <span class="c1"># # xpd = dims[comb] # do not delogarithmize as this would distort the pdf!</span>
            <span class="c1"># # print(dims[comb])</span>
            <span class="c1"># xpd = dims_GP[comb] # do not delogarithmize as this would distort the pdf!</span>
            <span class="c1"># # print(xpd)</span>
            <span class="c1"># if optim_type[comb] == &#39;linear&#39;:</span>
            <span class="c1">#     xpd/=pf[comb].p0m </span>
            
            <span class="c1"># m1 = np.sum(pd*(xpd)**1) / np.sum(pd) # the mean</span>
            <span class="c1"># m2 = np.sum(pd*(xpd-m1)**2) / np.sum(pd) # the variance</span>
            <span class="c1"># xx.append(m1)</span>
            <span class="c1"># stdx.append(np.sqrt(m2))</span>

            <span class="c1"># get 95 % confidence interval</span>
            <span class="c1"># find closest value to best fit value</span>
            <span class="c1">#</span>
            <span class="n">x_name</span> <span class="o">=</span> <span class="n">pnames</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span>
            <span class="n">idx_X_main</span> <span class="o">=</span> <span class="n">pnames_main</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">optim_type</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
                <span class="n">best_val</span> <span class="o">=</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">val</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">best_val</span> <span class="o">=</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">val</span>
            <span class="n">idx_best</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span><span class="o">-</span><span class="n">best_val</span><span class="p">))</span>

            <span class="n">par_ax</span> <span class="o">=</span> <span class="n">dims</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">LHS</span>
            <span class="n">ilow</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ihigh</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">par_ax</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">sum_prob</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">par_ax</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">sum_prob</span> <span class="o">+=</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">sum_prob</span> <span class="o">&gt;=</span> <span class="mf">0.025</span><span class="p">:</span>
                    <span class="n">ilow</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="k">break</span>
            <span class="n">sum_prob</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">par_ax</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">sum_prob</span> <span class="o">+=</span> <span class="n">p</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">par_ax</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">sum_prob</span> <span class="o">&gt;=</span> <span class="mf">0.025</span><span class="p">:</span>
                    <span class="n">ihigh</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">par_ax</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">ilow</span> <span class="o">&gt;</span> <span class="n">idx_best</span><span class="p">:</span>
                <span class="n">ilow</span> <span class="o">=</span> <span class="n">idx_best</span>
            <span class="k">if</span> <span class="n">ihigh</span> <span class="o">&lt;</span> <span class="n">idx_best</span><span class="p">:</span>
                <span class="n">ihigh</span> <span class="o">=</span> <span class="n">idx_best</span>
            
            <span class="c1"># 95% confidence interval centered on the best fit value</span>
            <span class="n">ihigh</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ihigh</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">par_ax</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ilow</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ilow</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">limlow</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">par_ax</span><span class="p">[</span><span class="n">ilow</span><span class="p">],</span><span class="n">best_val</span><span class="p">)</span>
            <span class="n">limhigh</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">par_ax</span><span class="p">[</span><span class="n">ihigh</span><span class="p">],</span><span class="n">best_val</span><span class="p">)</span>

            <span class="c1"># add the 95% confidence interval to the plot</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="n">comb</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">limlow</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="n">comb</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">limhigh</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">)</span>
            <span class="n">std95</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">limlow</span><span class="p">,</span><span class="n">limhigh</span><span class="p">))</span>
            <span class="c1"># Note: this is the 95% confidence interval unless the ground truth val is too far from the minimum of the surrogate model</span>
            <span class="c1"># in that case one of the limits of the confidence interval is the ground truth value</span>

            <span class="c1"># color the 95% confidence interval</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">par_ax</span> <span class="o">&gt;=</span> <span class="n">limlow</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">par_ax</span> <span class="o">&lt;=</span> <span class="n">limhigh</span><span class="p">)</span> <span class="c1"># Create mask for the shaded area</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="n">comb</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">par_ax</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span> <span class="c1"># Fill the area below the curve between the vertical lines</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="n">comb</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">val</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="c1"># add the best fit value to the plot</span>

            <span class="c1"># Set the axis limits and labels</span>
            <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">optim_type</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rescales</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">p0ms</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="n">comb</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">lb</span><span class="p">[</span><span class="n">comb</span><span class="p">]),</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">ub</span><span class="p">[</span><span class="n">comb</span><span class="p">])])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="n">comb</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">lb</span><span class="p">[</span><span class="n">comb</span><span class="p">])</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">comb</span><span class="p">],</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">ub</span><span class="p">[</span><span class="n">comb</span><span class="p">])</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">comb</span><span class="p">]])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">p0ms</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="n">comb</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">lb</span><span class="p">[</span><span class="n">comb</span><span class="p">],</span><span class="n">ub</span><span class="p">[</span><span class="n">comb</span><span class="p">]])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="n">comb</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">lb</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">comb</span><span class="p">],</span><span class="n">ub</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">comb</span><span class="p">]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="n">comb</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">lb</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">comb</span><span class="p">],</span><span class="n">ub</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span><span class="o">*</span><span class="n">p0ms</span><span class="p">[</span><span class="n">comb</span><span class="p">]])</span>


        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sampling for posterior distribution done in &#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">tic</span><span class="p">,</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>

        <span class="c1">## Make colorbar</span>
        <span class="c1"># Define the logarithmic space for the colorbar</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">logscale</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="n">vmax</span><span class="p">)</span>
            <span class="n">ticks</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="o">**</span><span class="n">vmin</span><span class="p">,</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">vmin</span><span class="o">/</span><span class="mi">2</span><span class="p">)),</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
            <span class="n">ticks</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Create a scalar mappable to map the values to colors</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
        <span class="n">sm</span><span class="o">.</span><span class="n">set_array</span><span class="p">([])</span>

        <span class="c1"># Create a colorbar</span>
        <span class="k">if</span> <span class="n">logscale</span><span class="p">:</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">LogFormatterMathtext</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">cax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>  <span class="c1"># left, bottom, width, height</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="n">ticks</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">fmt</span><span class="p">)</span>


        <span class="c1"># Set the colorbar label on the left side</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;P(w|y)&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>


        <span class="c1"># rearrange the lb_new and ub_new for the next iteration</span>
        <span class="k">for</span> <span class="n">comb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_params</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span><span class="o">.</span><span class="n">optim_type</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
                <span class="n">lb_new</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span> <span class="o">=</span> <span class="n">lb_new</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span><span class="o">/</span><span class="n">p0ms</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span>
                <span class="n">ub_new</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span> <span class="o">=</span> <span class="n">ub_new</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span><span class="o">/</span><span class="n">p0ms</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span>

            <span class="k">elif</span> <span class="n">pf</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span><span class="o">.</span><span class="n">optim_type</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
                <span class="n">lb_new</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">lb_new</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span><span class="o">/</span><span class="n">p0ms</span><span class="p">[</span><span class="n">comb</span><span class="p">])</span>
                <span class="n">ub_new</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ub_new</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span><span class="o">/</span><span class="n">p0ms</span><span class="p">[</span><span class="n">comb</span><span class="p">])</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ERROR. &#39;</span><span class="p">,</span><span class="n">pnames</span><span class="p">[</span><span class="n">comb</span><span class="p">],</span><span class="s1">&#39; optim_type needs to be &#39;&#39;linear&#39;&#39; or &#39;&#39;log&#39;&#39; not &#39;</span><span class="p">,</span><span class="n">optim_type</span><span class="p">[</span><span class="n">comb</span><span class="p">],</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>

        <span class="c1"># return xx,stdx, lb_new, ub_new</span>
        <span class="k">return</span> <span class="n">xx</span><span class="p">,</span><span class="n">std95</span><span class="p">,</span> <span class="n">lb_new</span><span class="p">,</span> <span class="n">ub_new</span></div>


<div class="viewcode-block" id="MooBOtorch.posterior">
<a class="viewcode-back" href="../../../boar.core.html#boar.core.optimization_botorch.MooBOtorch.posterior">[docs]</a>
    <span class="k">def</span> <span class="nf">posterior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">lb_main</span><span class="p">,</span> <span class="n">ub_main</span><span class="p">,</span> <span class="n">beta_scaled</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="n">fscale</span><span class="p">,</span><span class="n">kwargs_posterior</span><span class="p">,</span> <span class="n">points</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtain the posterior probability distribution p(w|y) by brute force gridding</span>
<span class="sd">        where w is the set of model parameters and y is the data</span>
<span class="sd">        For each fitparameter, return mean and standard deviation</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params : list of fitparameter objects</span>
<span class="sd">            list of fitparameters</span>
<span class="sd">        lb_main : list of floats</span>
<span class="sd">            lower bound for the fitparameters</span>
<span class="sd">        ub_main : list of floats</span>
<span class="sd">            upper bound for the fitparameters</span>
<span class="sd">        beta_scaled : float</span>
<span class="sd">            1/minimum of the scaled surrogate function</span>
<span class="sd">        N : integer</span>
<span class="sd">            number of datasets</span>
<span class="sd">        gpr : scikit-optimize estimator</span>
<span class="sd">            trained regressor</span>
<span class="sd">        fscale : float</span>
<span class="sd">            scaling factor</span>
<span class="sd">        kwargs_posterior : dict</span>
<span class="sd">            dictionary of keyword arguments for posterior function</span>
<span class="sd">            including: </span>
<span class="sd">            </span>
<span class="sd">                Nres : integer, optional</span>
<span class="sd">                    Sampling resolution. Number of data points per dimension, by default 30</span>
<span class="sd">                Ninteg : integer, optional</span>
<span class="sd">                    Number of points for the marginalization over the other parameters when full_grid = False, by default 100</span>
<span class="sd">                full_grid : boolean, optional</span>
<span class="sd">                    If True, use a full grid for the posterior, by default False</span>
<span class="sd">                randomize : boolean, optional</span>
<span class="sd">                    If True, calculate the posterior for all the dimension but draw the marginalization points randomly and do not use a corse grid, by default False</span>
<span class="sd">                logscale : boolean, optional</span>
<span class="sd">                    display in log scale?, by default True</span>
<span class="sd">                vmin : float, optional</span>
<span class="sd">                    lower cutoff (in terms of exp(vmin) if logscale==True), by default 1e-100</span>
<span class="sd">                zoom : int, optional</span>
<span class="sd">                    number of time to zoom in, only used if full_grid = True, by default 0</span>
<span class="sd">                min_prob : float, optional</span>
<span class="sd">                    minimum probability to consider when zooming in we will zoom on the parameter space with a probability higher than min_prob, by default 1e-40.</span>
<span class="sd">                clear_axis : boolean, optional</span>
<span class="sd">                    clear the axis before plotting the zoomed in data, by default False.</span>
<span class="sd">                True_values : dict, optional</span>
<span class="sd">                    dictionary of true values of the parameters, by default None</span>
<span class="sd">                show_points : boolean, optional</span>
<span class="sd">                    show the explored points in the parameter space during the optimization, by default False</span>
<span class="sd">                savefig : boolean, optional</span>
<span class="sd">                    save the figure, by default False</span>
<span class="sd">                savefig_name : str, optional</span>
<span class="sd">                    name of the file to save the figure, by default &#39;posterior.png&#39;</span>
<span class="sd">                savefig_dir : str, optional</span>
<span class="sd">                    directory to save the figure, by default self.res_dir</span>
<span class="sd">                figext : str, optional</span>
<span class="sd">                    extension of the figure, by default &#39;.png&#39;</span>
<span class="sd">                figsize : tuple, optional</span>
<span class="sd">                    size of the figure, by default (5\*nb_params,5\*nb_params)</span>
<span class="sd">                figdpi : int, optional</span>
<span class="sd">                    dpi of the figure, by default 300</span>
<span class="sd">        points : array, optional</span>
<span class="sd">            array of explored points in the parameter space during the optimization, by default None</span>
<span class="sd">        </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Contour plots for each pair of fit parameters</span>
<span class="sd">        list of float, list of float</span>
<span class="sd">           the mean and the square root of the second central moment </span>
<span class="sd">           (generalized standard deviation for arbitrary probability distribution)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># get varied fitparams</span>
        <span class="c1"># pf = [pp for pp in self.targets[-1][&#39;params&#39;] if pp.relRange!=0]</span>
        <span class="c1"># p0, lb_main, ub_main = self.params_r(self.targets[-1][&#39;params&#39;])</span>

        <span class="c1"># initialize figure</span>
        <span class="n">nb_params</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

        <span class="c1"># get kwargs</span>
        <span class="n">Nres</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Nres&#39;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">Ninteg</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Ninteg&#39;</span><span class="p">,</span><span class="mf">1e5</span><span class="p">)</span>
        <span class="n">full_grid</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;full_grid&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">randomize</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;randomize&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logscale</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logscale&#39;</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">vmin</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vmin&#39;</span><span class="p">,</span><span class="mf">1e-100</span><span class="p">)</span>
        <span class="n">zoom</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;zoom&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">min_prob</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min_prob&#39;</span><span class="p">,</span><span class="mf">1e-40</span><span class="p">)</span>
        <span class="n">clear_axis</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;clear_axis&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">True_values</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;True_values&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">show_points</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;show_points&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">savefig</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;savefig&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">figname</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;figname&#39;</span><span class="p">,</span><span class="s1">&#39;posterior&#39;</span><span class="p">)</span>
        <span class="n">figdir</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;figdir&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">res_dir</span><span class="p">)</span>
        <span class="n">figext</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;figext&#39;</span><span class="p">,</span><span class="s1">&#39;.png&#39;</span><span class="p">)</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;figsize&#39;</span><span class="p">,(</span><span class="mi">5</span><span class="o">*</span><span class="n">nb_params</span><span class="p">,</span><span class="mi">5</span><span class="o">*</span><span class="n">nb_params</span><span class="p">))</span>
        <span class="n">figdpi</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;figdpi&#39;</span><span class="p">,</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">show_fig</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;show_fig&#39;</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># save parameters to self for later use</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nres</span> <span class="o">=</span> <span class="n">Nres</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ninteg</span> <span class="o">=</span> <span class="n">Ninteg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logscale</span> <span class="o">=</span> <span class="n">logscale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vmin</span> <span class="o">=</span> <span class="n">vmin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_prob</span> <span class="o">=</span> <span class="n">min_prob</span>
       


        <span class="k">if</span> <span class="n">show_points</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">points</span> <span class="o">=</span> <span class="kc">None</span>
        

        <span class="k">if</span> <span class="n">full_grid</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">randomize</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>

            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">nb_params</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">nb_params</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
            <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="n">nb_params</span><span class="p">,</span> <span class="n">nb_params</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">zoom</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">zoom</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">old_lb</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">lb_main</span><span class="p">)</span>
                        <span class="n">old_ub</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ub_main</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">old_lb</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">new_lb</span><span class="p">)</span>
                        <span class="n">old_ub</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">new_ub</span><span class="p">)</span>
                    
                    <span class="n">xx</span><span class="p">,</span> <span class="n">stdx</span><span class="p">,</span> <span class="n">new_lb</span><span class="p">,</span> <span class="n">new_ub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_grid_posterior</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">fig</span><span class="p">,</span><span class="n">axes</span><span class="p">,</span><span class="n">gs</span><span class="p">,</span><span class="n">old_lb</span><span class="p">,</span><span class="n">old_ub</span><span class="p">,</span><span class="n">params</span><span class="p">,</span><span class="n">beta_scaled</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="n">fscale</span><span class="p">,</span> <span class="n">Nres</span><span class="p">,</span> <span class="n">logscale</span><span class="p">,</span> <span class="n">vmin</span><span class="p">,</span><span class="n">min_prob</span><span class="o">=</span><span class="n">min_prob</span><span class="p">,</span> <span class="n">clear_axis</span><span class="o">=</span><span class="n">clear_axis</span><span class="p">,</span> <span class="n">True_values</span><span class="o">=</span><span class="n">True_values</span><span class="p">,</span> <span class="n">points</span><span class="o">=</span><span class="n">points</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">new_lb</span> <span class="o">==</span> <span class="n">old_lb</span> <span class="ow">and</span> <span class="n">new_ub</span> <span class="o">==</span> <span class="n">old_ub</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Only </span><span class="si">{}</span><span class="s1"> zooms done&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No more zooming in, to zoom in further, change the min_prob&#39;</span><span class="p">)</span>
                        <span class="k">break</span>
                    
                    <span class="k">if</span> <span class="n">savefig</span><span class="p">:</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">figdir</span><span class="p">,</span><span class="n">figname</span><span class="o">+</span><span class="s1">&#39;_zoom_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="n">figext</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">figdpi</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> zooms done&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zoom</span><span class="p">))</span>
                    
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xx</span><span class="p">,</span> <span class="n">stdx</span><span class="p">,</span> <span class="n">lb</span><span class="p">,</span> <span class="n">ub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_grid_posterior</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">fig</span><span class="p">,</span><span class="n">axes</span><span class="p">,</span><span class="n">gs</span><span class="p">,</span><span class="n">lb_main</span><span class="p">,</span><span class="n">ub_main</span><span class="p">,</span><span class="n">params</span><span class="p">,</span><span class="n">beta_scaled</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="n">fscale</span><span class="p">,</span> <span class="n">Nres</span><span class="p">,</span> <span class="n">logscale</span><span class="p">,</span> <span class="n">vmin</span><span class="p">,</span><span class="n">min_prob</span><span class="o">=</span><span class="n">min_prob</span><span class="p">,</span> <span class="n">clear_axis</span><span class="o">=</span><span class="n">clear_axis</span><span class="p">,</span> <span class="n">True_values</span><span class="o">=</span><span class="n">True_values</span><span class="p">,</span> <span class="n">points</span><span class="o">=</span><span class="n">points</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">show_fig</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">savefig</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">figdir</span><span class="p">,</span><span class="n">figname</span><span class="o">+</span><span class="n">figext</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">full_grid</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">randomize</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            
            <span class="n">xx</span><span class="p">,</span> <span class="n">stdx</span><span class="p">,</span> <span class="n">lb</span><span class="p">,</span> <span class="n">ub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">randomize_grid_posterior</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">lb_main</span><span class="p">,</span> <span class="n">ub_main</span><span class="p">,</span> <span class="n">beta_scaled</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="n">fscale</span><span class="p">,</span><span class="n">kwargs_posterior</span><span class="p">,</span> <span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="p">,</span><span class="n">True_values</span><span class="o">=</span><span class="n">True_values</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># make len(self.params)/2 x len(self.params)/2 grid of subplots</span>
            <span class="n">free_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">relRange</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">num_plots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">free_params</span><span class="p">)</span>
            <span class="n">num_rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_plots</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># Calculate number of columns</span>
            <span class="n">num_cols</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">num_plots</span> <span class="o">+</span> <span class="n">num_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">num_rows</span><span class="p">)</span> <span class="c1"># Calculate number of rows</span>
            <span class="k">if</span> <span class="n">num_rows</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">num_rows</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">num_cols</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">num_cols</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">f</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">num_cols</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">xx</span><span class="p">,</span><span class="n">stdx</span> <span class="o">=</span> <span class="p">[],[]</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">relRange</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">idx</span> <span class="o">//</span> <span class="n">num_cols</span><span class="p">)</span>
                    <span class="n">col</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">idx</span> <span class="o">%</span> <span class="n">num_cols</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">num_rows</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
                    <span class="n">x_</span><span class="p">,</span> <span class="n">std_</span><span class="p">,</span> <span class="n">lb</span><span class="p">,</span> <span class="n">ub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">marginal_posterior_1D</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pf</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">True_values</span><span class="o">=</span><span class="n">True_values</span><span class="p">,</span><span class="n">points</span><span class="o">=</span><span class="n">points</span><span class="p">,</span><span class="n">logscale</span><span class="o">=</span><span class="n">logscale</span><span class="p">,</span><span class="n">lb</span> <span class="o">=</span> <span class="n">lb_main</span><span class="p">,</span> <span class="n">ub</span> <span class="o">=</span> <span class="n">ub_main</span><span class="p">,</span><span class="n">beta_scaled</span> <span class="o">=</span> <span class="n">beta_scaled</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">N</span><span class="p">,</span><span class="n">gpr</span><span class="o">=</span><span class="n">gpr</span><span class="p">,</span> <span class="n">fscale</span><span class="o">=</span><span class="n">fscale</span><span class="p">,</span> <span class="n">Nres</span><span class="o">=</span><span class="n">Nres</span><span class="p">,</span> <span class="n">Ninteg</span><span class="o">=</span><span class="n">Ninteg</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">min_prob</span><span class="o">=</span><span class="n">min_prob</span><span class="p">,</span> <span class="n">clear_axis</span><span class="o">=</span><span class="n">clear_axis</span><span class="p">)</span>
                    
                    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">xx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_</span><span class="p">)</span>
                    <span class="n">stdx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">std_</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">show_fig</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">savefig</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">figdir</span><span class="p">,</span><span class="n">figname</span><span class="o">+</span><span class="n">figext</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">xx</span><span class="p">,</span><span class="n">stdx</span></div>


<div class="viewcode-block" id="MooBOtorch.marginal_posterior_1D">
<a class="viewcode-back" href="../../../boar.core.html#boar.core.optimization_botorch.MooBOtorch.marginal_posterior_1D">[docs]</a>
    <span class="k">def</span> <span class="nf">marginal_posterior_1D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_name</span><span class="p">,</span> <span class="n">pf</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">lb</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ub</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fig</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">True_values</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">beta_scaled</span> <span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fscale</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Nres</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Ninteg</span> <span class="o">=</span> <span class="mf">1e5</span><span class="p">,</span> <span class="n">vmin</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">min_prob</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">points</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">logscale</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">show_plot</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">clear_axis</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">xlabel_pos</span> <span class="o">=</span> <span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">ylabel_pos</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot; calculate and plot the marginal posterior probability distribution p(w|y) for parameter x_name by integrating over the other parameters</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x_name : str</span>
<span class="sd">            name of the parameter for which the marginal posterior probability distribution is calculated</span>
<span class="sd">        lb : float, optional</span>
<span class="sd">            lower bound of the parameter x_name, if None we use the main boundaries, by default None</span>
<span class="sd">        ub : float, optional</span>
<span class="sd">            upper bound of the parameter x_name, if None we use the main boundaries, by default None</span>
<span class="sd">        fig : matplotlib figure, optional</span>
<span class="sd">            figure to plot the marginal posterior probability distribution, if None we create a new figure, by default None</span>
<span class="sd">        ax : matplotlib axis, optional</span>
<span class="sd">            axis to plot the marginal posterior probability distribution, if None we create a new axis, by default None</span>
<span class="sd">        True_values : dict, optional</span>
<span class="sd">            dictionary with the true values of the parameters, by default None</span>
<span class="sd">        gpr : sklearn regressor, optional</span>
<span class="sd">            regressor to calculate the likelihood, if None we use the self.gpr, by default None</span>
<span class="sd">        N : int, optional</span>
<span class="sd">            number of samples to calculate the likelihood, if None we use the self.N, by default None</span>
<span class="sd">        beta_scaled : float, optional</span>
<span class="sd">            scaling factor for the likelihood, if None we use the self.beta_scaled, by default None</span>
<span class="sd">        fscale : float, optional</span>
<span class="sd">            scaling factor for the likelihood, if None we use the self.fscale, by default None</span>
<span class="sd">        Nres : int, optional</span>
<span class="sd">            number of points to calculate the marginal posterior probability distribution, by default None</span>
<span class="sd">        Ninteg : int, optional</span>
<span class="sd">            number of points to marginalize the prob, by default 1e5</span>
<span class="sd">        vmin : float, optional</span>
<span class="sd">            minimum value of the marginal posterior probability distribution, only used if logscale = True as for linscale the min probability is 0, by default None</span>
<span class="sd">        min_prob : float, optional</span>
<span class="sd">            value used for the cut off probability when zooming in, note that for now this is not in used, by default None</span>
<span class="sd">        points : array, optional</span>
<span class="sd">            array with the points to plot the marginal posterior probability distribution, by default None</span>
<span class="sd">        logscale : bool, optional</span>
<span class="sd">            if True we plot the marginal posterior probability distribution in log scale, by default False</span>
<span class="sd">        show_plot : bool, optional</span>
<span class="sd">            if True we show the plot, by default True</span>
<span class="sd">        clear_axis : bool, optional</span>
<span class="sd">            if True we clear the axis, by default False</span>
<span class="sd">        xlabel_pos : str, optional</span>
<span class="sd">            position of the xlabel, by default &#39;bottom&#39;</span>
<span class="sd">        ylabel_pos : str, optional</span>
<span class="sd">            position of the ylabel, by default &#39;left&#39;</span>
<span class="sd">        **kwargs : dict, optional</span>
<span class="sd">            additional arguments to pass to the plot function, by default None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span> 
        <span class="c1"># Make sure we have all the parameters we need otherwise use the values in self    </span>
        <span class="k">if</span> <span class="n">pf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># check is self.pf is intialized</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;params&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">pf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;self.pf is not initialized and no pf is provided.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gpr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># check is self.gpr is intialized</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;gpr&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span> 
                <span class="n">gpr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;self.gpr is not initialized and no gpr is provided.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">N</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># check is self.N is intialized</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;N&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span> 
                <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;self.N is not initialized and no N is provided.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">beta_scaled</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># check is self.beta_scaled is intialized</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;beta_scaled&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">beta_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta_scaled</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;self.beta_scaled is not initialized and no beta_scaled is provided.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fscale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># check is self.fscale is intialized</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;fscale&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span> 
                <span class="n">fscale</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;self.fscale is not initialized and no fscale is provided. Set to default value of 1.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fscale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fscale</span>
        <span class="k">if</span> <span class="n">Nres</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># check is self.Nres is intialized</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;Ninteg&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">Nres</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> 
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;self.Nres is not initialized and no Nres is provided. Set to default value of 10.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Nres</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nres</span><span class="p">)</span> <span class="c1"># make sure it is an integer</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Nres</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Nres</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Ninteg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;Ninteg&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span> <span class="c1"># number of samples to draw from the grid to calculate the likelihood</span>
                <span class="n">Ninteg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1e3</span><span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;self.Ninteg is not initialized and no Ninteg is provided. Set to default value of 1e5.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Ninteg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ninteg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Ninteg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Ninteg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vmin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">logscale</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;vmin&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">vmin</span> <span class="o">=</span> <span class="mf">1e-10</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;self.vmin is not initialized and no vmin is provided. Set to default value of 1e-10.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vmin</span>

        <span class="n">pnames_main</span> <span class="o">=</span> <span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pf</span><span class="p">]</span>
        <span class="n">pnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pf</span> <span class="k">if</span> <span class="n">pp</span><span class="o">.</span><span class="n">relRange</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pnames_display</span> <span class="o">=</span> <span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">display_name</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pf</span> <span class="k">if</span> <span class="n">pp</span><span class="o">.</span><span class="n">relRange</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pnames_full</span> <span class="o">=</span> <span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">full_name</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pf</span> <span class="k">if</span> <span class="n">pp</span><span class="o">.</span><span class="n">relRange</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># get the bounds of the parameters</span>
        <span class="n">p0</span><span class="p">,</span> <span class="n">lb_main</span><span class="p">,</span> <span class="n">ub_main</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_r</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="c1"># get the main bounds of the parameters (i.e. with the zooming)</span>
        <span class="k">if</span> <span class="n">lb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lb</span> <span class="o">=</span> <span class="n">lb_main</span>
        <span class="k">if</span> <span class="n">ub</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ub</span> <span class="o">=</span> <span class="n">ub_main</span>

        
        <span class="c1"># get the index of the parameter to plot in pnames_main</span>
        <span class="n">idx_X_main</span> <span class="o">=</span> <span class="n">pnames_main</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x_name</span><span class="p">)</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="n">pnames</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x_name</span><span class="p">)</span>

        <span class="c1"># initialize the figure if not provided</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
            <span class="n">not_init</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">not_init</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># create a linspace for the parameter ii</span>
        <span class="n">par_ax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lb</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span><span class="n">ub</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span><span class="n">Nres</span><span class="p">)</span>
        <span class="c1"># add the best fit value if provided</span>
        <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">optim_type</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">rescale</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">best_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">best_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">val</span><span class="o">/</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">best_val</span> <span class="o">=</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">val</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">best_val</span> <span class="o">=</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">val</span><span class="o">/</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">best_val</span> <span class="o">=</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">val</span><span class="o">/</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span>

        <span class="c1"># put best value in par_ax and sort</span>
        <span class="n">par_ax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">par_ax</span><span class="p">,</span><span class="n">best_val</span><span class="p">))</span>
        <span class="n">idx_best</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">par_ax</span><span class="o">==</span><span class="n">best_val</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="c1">#get best_val position</span>

        <span class="c1"># create an empty array to store the likelihood</span>
        <span class="n">lh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">par_ax</span><span class="p">),</span><span class="n">Ninteg</span><span class="p">))</span>

        <span class="c1"># make a 2D vector where the value of parameter ii is fixed to the values in par_ax and a Ninteg random samples are drawn randomly from the grid to set the values of the other parameters</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">par_ax</span><span class="p">)):</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Ninteg</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">lb</span><span class="p">)))</span>
            <span class="n">X</span><span class="p">[:,</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">par_ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lb</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">jj</span><span class="o">!=</span><span class="n">ii</span><span class="p">:</span>
                    <span class="n">X</span><span class="p">[:,</span><span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">lb</span><span class="p">[</span><span class="n">jj</span><span class="p">],</span><span class="n">ub</span><span class="p">[</span><span class="n">jj</span><span class="p">],</span><span class="n">Ninteg</span><span class="p">)</span>
            <span class="n">lh</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LH_torch</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">beta_scaled</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">gpr</span><span class="p">)</span>

        <span class="c1"># Calculate the marginal posterior probability distribution p(w|y) for parameter ii by integrating over the other parameters</span>
        <span class="n">lhlog</span> <span class="o">=</span> <span class="n">logsumexp</span><span class="p">(</span><span class="n">lh</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># logsumexp is more accurate than np.log(np.sum(np.exp(lh),axis=1))</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lhlog</span><span class="o">-</span><span class="n">logsumexp</span><span class="p">(</span><span class="n">lhlog</span><span class="p">))</span> <span class="c1">#normalize the likelihood</span>

<span class="w">       </span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; old way (Not accurate so need logsumexp)</span>
<span class="sd">        lh[i,:] =  np.exp(self.LH(X,beta_scaled,N,gpr,fscale))</span>
<span class="sd">        calculate the marginal posterior probability distribution p(w|y) for parameter ii by integrating over the other parameters</span>
<span class="sd">        p = np.sum(lh,axis=1)</span>
<span class="sd">        p = p/np.sum(p)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1e-3</span><span class="p">:</span> <span class="c1"># this is in case all p are zeros </span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The marginal posterior probability distribution is all zeros. We set it to a uniform distribution.&quot;</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>

        <span class="c1"># prepare the axis</span>
        <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">optim_type</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">rescale</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">par_ax</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">par_ax</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">par_ax</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">par_ax</span><span class="p">)</span><span class="o">*</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">par_ax</span> <span class="o">=</span> <span class="n">par_ax</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">par_ax</span> <span class="o">=</span> <span class="n">par_ax</span> <span class="o">*</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">par_ax</span> <span class="o">=</span> <span class="n">par_ax</span> <span class="o">*</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span>

        <span class="c1"># plot the marginal posterior probability distribution p(w|y) for parameter ii</span>
        <span class="k">if</span> <span class="n">logscale</span><span class="p">:</span>
            <span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="o">&lt;</span><span class="n">vmin</span><span class="p">]</span> <span class="o">=</span> <span class="n">vmin</span>
            <span class="n">p</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">p</span><span class="p">)]</span> <span class="o">=</span> <span class="n">vmin</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># or or p is nan</span>
            <span class="n">p</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">p</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">par_ax</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">axis_type</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        
        <span class="n">ilow</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ihigh</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">par_ax</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">sum_prob</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">par_ax</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">sum_prob</span> <span class="o">+=</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">sum_prob</span> <span class="o">&gt;=</span> <span class="mf">0.025</span><span class="p">:</span>
                <span class="n">ilow</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>
        <span class="n">sum_prob</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">par_ax</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">sum_prob</span> <span class="o">+=</span> <span class="n">p</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">par_ax</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">sum_prob</span> <span class="o">&gt;=</span> <span class="mf">0.025</span><span class="p">:</span>
                <span class="n">ihigh</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">par_ax</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">ilow</span> <span class="o">&gt;</span> <span class="n">idx_best</span><span class="p">:</span>
            <span class="n">ilow</span> <span class="o">=</span> <span class="n">idx_best</span>
        <span class="k">if</span> <span class="n">ihigh</span> <span class="o">&lt;</span> <span class="n">idx_best</span><span class="p">:</span>
            <span class="n">ihigh</span> <span class="o">=</span> <span class="n">idx_best</span>


        <span class="c1"># 95% confidence interval centered on the best fit value</span>
        <span class="n">ihigh</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ihigh</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">par_ax</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ilow</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ilow</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># add the 95% confidence interval to the plot</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">par_ax</span><span class="p">[</span><span class="n">ilow</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">par_ax</span><span class="p">[</span><span class="n">ihigh</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">)</span>

        <span class="c1"># Note: this is the 95% confidence interval unless the ground truth val is too far from the minimum of the surrogate model</span>
        <span class="c1"># in that case one of the limits of the confidence interval is the ground truth value</span>

        <span class="c1"># color the 95% confidence interval</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">par_ax</span> <span class="o">&gt;=</span> <span class="n">par_ax</span><span class="p">[</span><span class="n">ilow</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">par_ax</span> <span class="o">&lt;=</span> <span class="n">par_ax</span><span class="p">[</span><span class="n">ihigh</span><span class="p">])</span> <span class="c1"># Create mask for the shaded area</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">par_ax</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span> <span class="c1"># Fill the area below the curve between the vertical lines</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">val</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="c1"># add the best fit value to the plot</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">True_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># plot the true value of parameter ii if provided</span>
            
                <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">True_values</span><span class="p">[</span><span class="n">pnames</span><span class="p">[</span><span class="n">ii</span><span class="p">]],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;C3&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">True_values</span><span class="p">[</span><span class="n">pnames</span><span class="p">[</span><span class="n">ii</span><span class="p">]],</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;C3*&#39;</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;WARNING. Could not plot true value for &#39;</span><span class="o">+</span><span class="n">pnames</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>


<span class="w">        </span><span class="sd">&#39;&#39;&#39; Old way of calculating the mean and standard deviation of the marginal posterior probability distribution p(w|y) for parameter ii (not used anymore)</span>
<span class="sd">        calculate the mean and standard deviation of the marginal posterior probability distribution p(w|y) for parameter ii</span>
<span class="sd">        m1 = np.sum(p*par_ax) / np.sum(p) # the mean</span>
<span class="sd">        m2 = np.sum(p*(par_ax-m1)**2) / np.sum(p) # the variapar_axTnce</span>
<span class="sd">        std = np.sqrt(m2) # the standard deviation</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Set the axis limits and labels</span>
        <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">optim_type</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">rescale</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">lb</span><span class="p">[</span><span class="n">ii</span><span class="p">]),</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">ub</span><span class="p">[</span><span class="n">ii</span><span class="p">])])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">lb</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">*</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span><span class="p">,</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">ub</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span><span class="o">*</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">lb</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span><span class="n">ub</span><span class="p">[</span><span class="n">ii</span><span class="p">]])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">lb</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span><span class="p">,</span><span class="n">ub</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">lb</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span><span class="p">,</span><span class="n">ub</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span><span class="p">])</span>


        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">labelrotation</span> <span class="o">=</span> <span class="mi">45</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">logscale</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">vmin</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mf">1.1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">xlabel_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">pnames_full</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span><span class="n">position</span> <span class="o">=</span> <span class="n">xlabel_pos</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">xlabel_pos</span> <span class="o">==</span> <span class="s1">&#39;top&#39;</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">labeltop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">labelbottom</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">labeltop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span> <span class="c1"># remove the x label ticks  </span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span> <span class="c1"># remove the x label ticks</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">labeltop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ylabel_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;P(&#39;</span><span class="o">+</span><span class="n">pnames_display</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;|y)&#39;</span><span class="p">,</span><span class="n">position</span> <span class="o">=</span> <span class="n">ylabel_pos</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ylabel_pos</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">labelright</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">labelleft</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">labelright</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span> <span class="c1"># remove the x label ticks  </span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span> <span class="c1"># remove the x label ticks</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">labelright</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>

        
        <span class="k">if</span> <span class="n">not_init</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># max probability</span>
        <span class="n">idx_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="n">par_ax</span><span class="p">[</span><span class="n">idx_max</span><span class="p">]</span>
        <span class="n">std</span> <span class="o">=</span> <span class="p">(</span><span class="n">par_ax</span><span class="p">[</span><span class="n">ilow</span><span class="p">],</span><span class="n">par_ax</span><span class="p">[</span><span class="n">ihigh</span><span class="p">])</span> <span class="c1"># 95% confidence interval</span>

        <span class="c1"># Prepare new bounds for next zoom (not needed for now but maybe in the future)</span>
        <span class="n">lb_new</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">lb</span><span class="p">)</span>
        <span class="n">ub_new</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ub</span><span class="p">)</span>



        <span class="k">return</span> <span class="n">xmin</span><span class="p">,</span><span class="n">std</span><span class="p">,</span><span class="n">lb_new</span><span class="p">,</span><span class="n">ub_new</span></div>


<div class="viewcode-block" id="MooBOtorch.marginal_posterior_2D">
<a class="viewcode-back" href="../../../boar.core.html#boar.core.optimization_botorch.MooBOtorch.marginal_posterior_2D">[docs]</a>
    <span class="k">def</span> <span class="nf">marginal_posterior_2D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_name</span><span class="p">,</span> <span class="n">y_name</span><span class="p">,</span> <span class="n">pf</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">lb</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ub</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fig</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">True_values</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">gpr</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">beta_scaled</span> <span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fscale</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Nres</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Ninteg</span> <span class="o">=</span> <span class="mf">1e5</span><span class="p">,</span> <span class="n">vmin</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">min_prob</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">points</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">logscale</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">show_plot</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">clear_axis</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">xlabel_pos</span> <span class="o">=</span> <span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">ylabel_pos</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot; calculate and plot the marginal posterior probability distribution p(w|y) for parameter x_name by integrating over the other parameters</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x_name : str</span>
<span class="sd">            name of the parameter for which the marginal posterior probability distribution is calculated on the x-axis</span>
<span class="sd">        y_name : str</span>
<span class="sd">            name of the parameter for which the marginal posterior probability distribution is calculated on the y-axis</span>
<span class="sd">        lb : float, optional</span>
<span class="sd">            lower bound of the parameter x_name, if None we use the main boundaries, by default None</span>
<span class="sd">        ub : float, optional</span>
<span class="sd">            upper bound of the parameter x_name, if None we use the main boundaries, by default None</span>
<span class="sd">        fig : matplotlib figure, optional</span>
<span class="sd">            figure to plot the marginal posterior probability distribution, if None we create a new figure, by default None</span>
<span class="sd">        ax : matplotlib axis, optional</span>
<span class="sd">            axis to plot the marginal posterior probability distribution, if None we create a new axis, by default None</span>
<span class="sd">        True_values : dict, optional</span>
<span class="sd">            dictionary with the true values of the parameters, by default None</span>
<span class="sd">        gpr : sklearn regressor, optional</span>
<span class="sd">            regressor to calculate the likelihood, if None we use the self.gpr, by default None</span>
<span class="sd">        N : int, optional</span>
<span class="sd">            number of samples to calculate the likelihood, if None we use the self.N, by default None</span>
<span class="sd">        beta_scaled : float, optional</span>
<span class="sd">            scaling factor for the likelihood, if None we use the self.beta_scaled, by default None</span>
<span class="sd">        fscale : float, optional</span>
<span class="sd">            scaling factor for the likelihood, if None we use the self.fscale, by default None</span>
<span class="sd">        Nres : int, optional</span>
<span class="sd">            number of points to calculate the marginal posterior probability distribution, by default None</span>
<span class="sd">        Ninteg : int, optional</span>
<span class="sd">            number of points to marginalize the prob, by default 1e5</span>
<span class="sd">        vmin : float, optional</span>
<span class="sd">            minimum value of the marginal posterior probability distribution, only used if logscale = True as for linscale the min probability is 0, by default None</span>
<span class="sd">        min_prob : float, optional</span>
<span class="sd">            value used for the cut off probability when zooming in, note that for now this is not in used, by default None</span>
<span class="sd">        points : array, optional</span>
<span class="sd">            array with the points to plot the marginal posterior probability distribution, by default None</span>
<span class="sd">        logscale : bool, optional</span>
<span class="sd">            if True we plot the marginal posterior probability distribution in log scale, by default False</span>
<span class="sd">        show_plot : bool, optional</span>
<span class="sd">            if True we show the plot, by default True</span>
<span class="sd">        clear_axis : bool, optional</span>
<span class="sd">            if True we clear the axis, by default False</span>
<span class="sd">        xlabel_pos : str, optional</span>
<span class="sd">            position of the xlabel, by default &#39;bottom&#39;</span>
<span class="sd">        ylabel_pos : str, optional</span>
<span class="sd">            position of the ylabel, by default &#39;left&#39;</span>
<span class="sd">        **kwargs : dict, optional</span>
<span class="sd">            additional arguments to pass to the plot function, by default None</span>
<span class="sd">                show_points : bool, optional</span>
<span class="sd">                    if True we show the points, by default True</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span> 

        <span class="n">show_points</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;show_points&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Make sure we have all the parameters we need otherwise use the values in self    </span>
        <span class="k">if</span> <span class="n">pf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># check is self.pf is intialized</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;params&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">pf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;self.pf is not initialized and no pf is provided.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gpr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># check is self.gpr is intialized</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;gpr&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span> 
                <span class="n">gpr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;self.gpr is not initialized and no gpr is provided.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">N</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># check is self.N is intialized</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;N&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span> 
                <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;self.N is not initialized and no N is provided.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">beta_scaled</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># check is self.beta_scaled is intialized</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;beta_scaled&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">beta_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta_scaled</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;self.beta_scaled is not initialized and no beta_scaled is provided.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fscale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># check is self.fscale is intialized</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;fscale&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span> 
                <span class="n">fscale</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;self.fscale is not initialized and no fscale is provided. Set to default value of 1.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fscale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fscale</span>
        <span class="k">if</span> <span class="n">Nres</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># check is self.Nres is intialized</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;Ninteg&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">Nres</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> 
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;self.Nres is not initialized and no Nres is provided. Set to default value of 10.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Nres</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nres</span><span class="p">)</span> <span class="c1"># make sure it is an integer</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Nres</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Nres</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Ninteg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;Ninteg&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span> <span class="c1"># number of samples to draw from the grid to calculate the likelihood</span>
                <span class="n">Ninteg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1e3</span><span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;self.Ninteg is not initialized and no Ninteg is provided. Set to default value of 1e5.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Ninteg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ninteg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Ninteg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Ninteg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vmin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">logscale</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;vmin&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">vmin</span> <span class="o">=</span> <span class="mf">1e-10</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;self.vmin is not initialized and no vmin is provided. Set to default value of 1e-10.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vmin</span>

        <span class="c1"># if show_points is True and points is None:</span>
        <span class="c1">#     points = self.points</span>

        
        
        <span class="n">pnames_main</span> <span class="o">=</span> <span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pf</span><span class="p">]</span>
        <span class="n">pnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pf</span> <span class="k">if</span> <span class="n">pp</span><span class="o">.</span><span class="n">relRange</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pnames_display</span> <span class="o">=</span> <span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">display_name</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pf</span> <span class="k">if</span> <span class="n">pp</span><span class="o">.</span><span class="n">relRange</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pnames_full</span> <span class="o">=</span> <span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">full_name</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pf</span> <span class="k">if</span> <span class="n">pp</span><span class="o">.</span><span class="n">relRange</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># get the bounds of the parameters</span>
        <span class="n">p0</span><span class="p">,</span> <span class="n">lb_main</span><span class="p">,</span> <span class="n">ub_main</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_r</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="c1"># get the main bounds of the parameters (i.e. with the zooming)</span>
        <span class="k">if</span> <span class="n">lb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lb</span> <span class="o">=</span> <span class="n">lb_main</span>
        <span class="k">if</span> <span class="n">ub</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ub</span> <span class="o">=</span> <span class="n">ub_main</span>

        
        <span class="c1"># get the index of the parameter to plot in pnames_main</span>
        <span class="n">idx_X_main</span> <span class="o">=</span> <span class="n">pnames_main</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x_name</span><span class="p">)</span>
        <span class="n">iiX</span> <span class="o">=</span> <span class="n">pnames</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x_name</span><span class="p">)</span>
        <span class="n">idx_Y_main</span> <span class="o">=</span> <span class="n">pnames_main</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">y_name</span><span class="p">)</span>
        <span class="n">iiY</span> <span class="o">=</span> <span class="n">pnames</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">y_name</span><span class="p">)</span>

        <span class="c1"># initialize the figure if not provided</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
            <span class="n">not_init</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">fig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># get figure number</span>
            <span class="n">fig_num</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">number</span>
            <span class="c1">#activate figure</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fig_num</span><span class="p">)</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
            <span class="n">not_init</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">not_init</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># create a linspace for the parameter ii</span>
        <span class="n">par_ax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lb</span><span class="p">[</span><span class="n">iiX</span><span class="p">],</span><span class="n">ub</span><span class="p">[</span><span class="n">iiX</span><span class="p">],</span><span class="n">Nres</span><span class="p">)</span>
        <span class="n">par_ay</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lb</span><span class="p">[</span><span class="n">iiY</span><span class="p">],</span><span class="n">ub</span><span class="p">[</span><span class="n">iiY</span><span class="p">],</span><span class="n">Nres</span><span class="p">)</span>

        <span class="c1"># add the best fit value if provided</span>
        <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">optim_type</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">rescale</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">best_val_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">best_val_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">val</span><span class="o">/</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">best_val_x</span> <span class="o">=</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">val</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">best_val_x</span> <span class="o">=</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">val</span><span class="o">/</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">best_val_x</span> <span class="o">=</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">val</span><span class="o">/</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span>
        
        <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">optim_type</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">rescale</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">best_val_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">best_val_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">val</span><span class="o">/</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">best_val_y</span> <span class="o">=</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">val</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">best_val_y</span> <span class="o">=</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">val</span><span class="o">/</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">best_val_y</span> <span class="o">=</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">val</span><span class="o">/</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span>


        <span class="c1"># put best value in par_ax and sort</span>
        <span class="n">par_ax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">par_ax</span><span class="p">,</span><span class="n">best_val_x</span><span class="p">))</span>
        <span class="n">idx_best</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">par_ax</span><span class="o">==</span><span class="n">best_val_x</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="c1">#get best_val position</span>
        <span class="n">par_ay</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">par_ay</span><span class="p">,</span><span class="n">best_val_y</span><span class="p">))</span>
        <span class="n">idy_best</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">par_ay</span><span class="o">==</span><span class="n">best_val_y</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="c1">#get best_val position</span>

        <span class="c1"># create an empty array to store the likelihood</span>
        <span class="n">lh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">par_ax</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">par_ay</span><span class="p">),</span><span class="n">Ninteg</span><span class="p">))</span>


        <span class="c1"># make a 2D vector where the value of parameter ii is fixed to the values in par_ax and a Ninteg random samples are drawn randomly from the grid to set the values of the other parameters</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">par_ax</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">par_ay</span><span class="p">)):</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Ninteg</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">lb</span><span class="p">)))</span>
                <span class="n">X</span><span class="p">[:,</span><span class="n">iiX</span><span class="p">]</span> <span class="o">=</span> <span class="n">par_ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">X</span><span class="p">[:,</span><span class="n">iiY</span><span class="p">]</span> <span class="o">=</span> <span class="n">par_ay</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lb</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">k</span><span class="o">!=</span><span class="n">iiX</span> <span class="ow">and</span> <span class="n">k</span><span class="o">!=</span><span class="n">iiY</span><span class="p">:</span>
                        <span class="n">X</span><span class="p">[:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">lb</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">ub</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">Ninteg</span><span class="p">)</span>
                <span class="n">lh</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LH_torch</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">beta_scaled</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">gpr</span><span class="p">)</span>
        
        <span class="c1"># calculate the marginal posterior probability distribution p(w|y) for parameter ii by integrating over the other parameters</span>
        <span class="n">lhlog</span> <span class="o">=</span> <span class="n">logsumexp</span><span class="p">(</span><span class="n">lh</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># logsumexp is more accurate than np.log(np.sum(np.exp(lh),axis=1))</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lhlog</span><span class="o">-</span><span class="n">logsumexp</span><span class="p">(</span><span class="n">lhlog</span><span class="p">))</span> <span class="c1">#normalize the likelihood</span>


        <span class="c1"># prepare the axis</span>
        <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">optim_type</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">rescale</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">par_ax</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">par_ax</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">par_ax</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">par_ax</span><span class="p">)</span><span class="o">*</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">par_ax</span> <span class="o">=</span> <span class="n">par_ax</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">par_ax</span> <span class="o">=</span> <span class="n">par_ax</span> <span class="o">*</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">par_ax</span> <span class="o">=</span> <span class="n">par_ax</span> <span class="o">*</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span>

        <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">optim_type</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">rescale</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">par_ay</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">par_ay</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">par_ay</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">par_ay</span><span class="p">)</span><span class="o">*</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">par_ay</span> <span class="o">=</span> <span class="n">par_ay</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">par_ay</span> <span class="o">=</span> <span class="n">par_ay</span> <span class="o">*</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">par_ay</span> <span class="o">=</span> <span class="n">par_ay</span> <span class="o">*</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span>

        <span class="c1"># plot the marginal posterior probability distribution p(w|y) for parameter ii</span>
        <span class="k">if</span> <span class="n">logscale</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">vmin</span><span class="p">)</span>
            <span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="o">&lt;</span><span class="n">vmin</span><span class="p">]</span> <span class="o">=</span> <span class="n">vmin</span>
            <span class="n">p</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">p</span><span class="p">)]</span> <span class="o">=</span> <span class="n">vmin</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span><span class="p">[</span><span class="n">p</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># or or p is nan</span>
            <span class="n">p</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">p</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">vmin</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">clear_axis</span><span class="p">:</span> <span class="c1"># clear the axes for the zoomed in version</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span> <span class="c1"># clear the previous plot</span>

        <span class="n">contour_</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">par_ax</span><span class="p">,</span><span class="n">par_ay</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">axis_type</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">axis_type</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">True_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># plot the true value of parameter ii if provided</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">True_values</span><span class="p">[</span><span class="n">x_name</span><span class="p">],</span><span class="n">True_values</span><span class="p">[</span><span class="n">y_name</span><span class="p">],</span><span class="s1">&#39;C3*&#39;</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;At least one of the true values &quot;</span><span class="o">+</span><span class="n">x_name</span><span class="o">+</span><span class="s2">&quot; or &quot;</span><span class="o">+</span><span class="n">y_name</span><span class="o">+</span><span class="s2">&quot; is not provided. We skip plotting the true values.&quot;</span><span class="p">)</span>
        
        <span class="c1"># add best value</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">par_ax</span><span class="p">[</span><span class="n">idx_best</span><span class="p">],</span><span class="n">par_ay</span><span class="p">[</span><span class="n">idy_best</span><span class="p">],</span><span class="s1">&#39;C2X&#39;</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># plot the points</span>
        <span class="k">if</span> <span class="n">show_points</span><span class="p">:</span>
            <span class="n">pred1_plot</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">iiX</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">points</span><span class="p">]</span>
            <span class="n">pred2_plot</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">iiY</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">points</span><span class="p">]</span>
            <span class="c1"># convert back to the right values  </span>
            <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">optim_type</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">rescale</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">pred1_plot</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pred1_plot</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pred1_plot</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pred1_plot</span><span class="p">))</span> <span class="o">*</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">pred1_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pred1_plot</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pred1_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pred1_plot</span><span class="p">)</span> <span class="o">*</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span>
            <span class="k">elif</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">optim_type</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
                <span class="n">pred1_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pred1_plot</span><span class="p">)</span> <span class="o">*</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ERROR. &#39;</span><span class="p">,</span><span class="n">pnames</span><span class="p">[</span><span class="n">iiX</span><span class="p">],</span><span class="s1">&#39; optim_type needs to be &#39;&#39;linear&#39;&#39; or &#39;&#39;log&#39;&#39; not &#39;</span><span class="p">,</span><span class="n">pf</span><span class="p">[</span><span class="n">iiX</span><span class="p">]</span><span class="o">.</span><span class="n">optim_type</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">optim_type</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">rescale</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">pred2_plot</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pred2_plot</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pred2_plot</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pred2_plot</span><span class="p">))</span> <span class="o">*</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">pred2_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pred2_plot</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pred2_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pred2_plot</span><span class="p">)</span> <span class="o">*</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span>

            <span class="k">elif</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">optim_type</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
                <span class="n">pred2_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pred2_plot</span><span class="p">)</span> <span class="o">*</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ERROR. &#39;</span><span class="p">,</span><span class="n">pnames</span><span class="p">[</span><span class="n">iiY</span><span class="p">],</span><span class="s1">&#39; optim_type needs to be &#39;&#39;linear&#39;&#39; or &#39;&#39;log&#39;&#39; not &#39;</span><span class="p">,</span><span class="n">pf</span><span class="p">[</span><span class="n">iiY</span><span class="p">]</span><span class="o">.</span><span class="n">optim_type</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pred1_plot</span><span class="p">,</span><span class="n">pred2_plot</span><span class="p">,</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        
        <span class="c1"># Set the axis limits and labels</span>
        <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">optim_type</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">rescale</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">lb</span><span class="p">[</span><span class="n">iiX</span><span class="p">]),</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">ub</span><span class="p">[</span><span class="n">iiX</span><span class="p">])])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">lb</span><span class="p">[</span><span class="n">iiX</span><span class="p">])</span><span class="o">*</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span><span class="p">,</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">ub</span><span class="p">[</span><span class="n">iiX</span><span class="p">])</span><span class="o">*</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">lb</span><span class="p">[</span><span class="n">iiX</span><span class="p">],</span><span class="n">ub</span><span class="p">[</span><span class="n">iiX</span><span class="p">]])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">lb</span><span class="p">[</span><span class="n">iiX</span><span class="p">]</span><span class="o">*</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span><span class="p">,</span><span class="n">ub</span><span class="p">[</span><span class="n">iiX</span><span class="p">]</span><span class="o">*</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">lb</span><span class="p">[</span><span class="n">iiX</span><span class="p">]</span><span class="o">*</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span><span class="p">,</span><span class="n">ub</span><span class="p">[</span><span class="n">iiX</span><span class="p">]</span><span class="o">*</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_X_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">labelrotation</span> <span class="o">=</span> <span class="mi">45</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">optim_type</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">rescale</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">lb</span><span class="p">[</span><span class="n">iiY</span><span class="p">]),</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">ub</span><span class="p">[</span><span class="n">iiY</span><span class="p">])])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">lb</span><span class="p">[</span><span class="n">iiY</span><span class="p">])</span><span class="o">*</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span><span class="p">,</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">ub</span><span class="p">[</span><span class="n">iiY</span><span class="p">])</span><span class="o">*</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">lb</span><span class="p">[</span><span class="n">iiY</span><span class="p">],</span><span class="n">ub</span><span class="p">[</span><span class="n">iiY</span><span class="p">]])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">lb</span><span class="p">[</span><span class="n">iiY</span><span class="p">]</span><span class="o">*</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span><span class="p">,</span><span class="n">ub</span><span class="p">[</span><span class="n">iiY</span><span class="p">]</span><span class="o">*</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">lb</span><span class="p">[</span><span class="n">iiY</span><span class="p">]</span><span class="o">*</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span><span class="p">,</span><span class="n">ub</span><span class="p">[</span><span class="n">iiY</span><span class="p">]</span><span class="o">*</span><span class="n">pf</span><span class="p">[</span><span class="n">idx_Y_main</span><span class="p">]</span><span class="o">.</span><span class="n">p0m</span><span class="p">])</span>


        <span class="k">if</span> <span class="n">xlabel_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">pnames_full</span><span class="p">[</span><span class="n">iiX</span><span class="p">],</span><span class="n">position</span> <span class="o">=</span> <span class="n">xlabel_pos</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">xlabel_pos</span> <span class="o">==</span> <span class="s1">&#39;top&#39;</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">labeltop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">labelbottom</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">labeltop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span> <span class="c1"># remove the x label ticks  </span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span> <span class="c1"># remove the x label ticks</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">labeltop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ylabel_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">pnames_full</span><span class="p">[</span><span class="n">iiY</span><span class="p">],</span><span class="n">position</span> <span class="o">=</span> <span class="n">ylabel_pos</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ylabel_pos</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">labelright</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">labelleft</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">labelright</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span> <span class="c1"># remove the x label ticks  </span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span> <span class="c1"># remove the x label ticks</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">labelright</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">not_init</span><span class="p">:</span>
            <span class="c1">## Make colorbar</span>
            <span class="c1"># Define the logarithmic space for the colorbar</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">logscale</span><span class="p">:</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="n">vmax</span><span class="p">)</span>
                <span class="n">ticks</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="o">**</span><span class="n">vmin</span><span class="p">,</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">vmin</span><span class="o">/</span><span class="mi">2</span><span class="p">)),</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
                <span class="n">ticks</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Create a scalar mappable to map the values to colors</span>
            <span class="n">sm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
            <span class="n">sm</span><span class="o">.</span><span class="n">set_array</span><span class="p">([])</span>

            <span class="c1"># Create a colorbar</span>
            <span class="k">if</span> <span class="n">logscale</span><span class="p">:</span>
                <span class="n">fmt</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">LogFormatterMathtext</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fmt</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># add colorbar</span>
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="n">ticks</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">fmt</span><span class="p">)</span> <span class="c1"># add the colorbar</span>


            <span class="c1"># Set the colorbar label on the left side</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
            <span class="c1"># add pad for the cbar label</span>
            <span class="c1"># cbar.ax.set_ylabel(&#39;P(&#39;+pnames_display[iiX]+&#39;|y)&#39;, rotation=90, va=&#39;bottom&#39;)</span>


            
            <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;P(&#39;</span><span class="o">+</span><span class="n">pnames_display</span><span class="p">[</span><span class="n">iiX</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;&amp;&#39;</span><span class="o">+</span><span class="n">pnames_display</span><span class="p">[</span><span class="n">iiY</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;|y)&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span><span class="n">labelpad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            
        <span class="k">def</span> <span class="nf">randomize_grid_posterior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">lb_main</span><span class="p">,</span> <span class="n">ub_main</span><span class="p">,</span> <span class="n">beta_scaled</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">gpr</span><span class="p">,</span> <span class="n">fscale</span><span class="p">,</span><span class="n">kwargs_posterior</span><span class="p">,</span> <span class="n">points</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">True_values</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span><span class="c1">#, logscale = False, clear_axis = True, xlabel_pos = None, ylabel_pos = None, ax = None, fig = None, **kwargs):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Obtain the posterior probability distribution p(w|y) by brute force gridding</span>
<span class="sd">            where w is the set of model parameters and y is the data</span>
<span class="sd">            For each fitparameter, return mean and standard deviation</span>


<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            params : list of fitparameter objects</span>
<span class="sd">                list of fitparameters</span>
<span class="sd">            lb_main : list of floats</span>
<span class="sd">                lower bound for the fitparameters</span>
<span class="sd">            ub_main : list of floats</span>
<span class="sd">                upper bound for the fitparameters</span>
<span class="sd">            beta_scaled : float</span>
<span class="sd">                1/minimum of the scaled surrogate function</span>
<span class="sd">            N : integer</span>
<span class="sd">                number of datasets</span>
<span class="sd">            gpr : scikit-optimize estimator</span>
<span class="sd">                trained regressor</span>
<span class="sd">            fscale : float</span>
<span class="sd">                scaling factor</span>
<span class="sd">            kwargs_posterior : dict</span>
<span class="sd">                dictionary of keyword arguments for posterior function</span>
<span class="sd">                including: </span>
<span class="sd">                    Nres : integer, optional</span>
<span class="sd">                        Sampling resolution. Number of data points per dimension, by default 30</span>
<span class="sd">                    Ninteg : integer, optional</span>
<span class="sd">                        Number of points for the marginalization over the other parameters when full_grid = False, by default 100</span>
<span class="sd">                    full_grid : boolean, optional</span>
<span class="sd">                        If True, use a full grid for the posterior, by default False</span>
<span class="sd">                    logscale : boolean, optional</span>
<span class="sd">                        display in log scale?, by default True</span>
<span class="sd">                    vmin : float, optional</span>
<span class="sd">                        lower cutoff (in terms of exp(vmin) if logscale==True), by default 1e-100</span>
<span class="sd">                    zoom : int, optional</span>
<span class="sd">                        number of time to zoom in, only used if full_grid = True, by default 0</span>
<span class="sd">                    min_prob : float, optional</span>
<span class="sd">                        minimum probability to consider when zooming in we will zoom on the parameter space with a probability higher than min_prob, by default 1e-40.</span>
<span class="sd">                    clear_axis : boolean, optional</span>
<span class="sd">                        clear the axis before plotting the zoomed in data, by default False.</span>
<span class="sd">                    True_values : dict, optional</span>
<span class="sd">                        dictionary of true values of the parameters, by default None</span>
<span class="sd">                    show_points : boolean, optional</span>
<span class="sd">                        show the explored points in the parameter space during the optimization, by default False</span>
<span class="sd">                    savefig : boolean, optional</span>
<span class="sd">                        save the figure, by default False</span>
<span class="sd">                    savefig_name : str, optional</span>
<span class="sd">                        name of the file to save the figure, by default &#39;posterior.png&#39;</span>
<span class="sd">                    savefig_dir : str, optional</span>
<span class="sd">                        directory to save the figure, by default self.res_dir</span>
<span class="sd">                    figext : str, optional</span>
<span class="sd">                        extension of the figure, by default &#39;.png&#39;</span>
<span class="sd">                    figsize : tuple, optional</span>
<span class="sd">                        size of the figure, by default (5\*nb_params,5\*nb_params)</span>
<span class="sd">                    figdpi : int, optional</span>
<span class="sd">                        dpi of the figure, by default 300</span>
<span class="sd">            points : array, optional</span>
<span class="sd">                array of explored points in the parameter space during the optimization, by default None</span>
<span class="sd">            True_values : dict, optional</span>
<span class="sd">                dictionary of true values of the parameters, by default None</span>
<span class="sd">            </span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            Contour plots for each pair of fit parameters</span>
<span class="sd">            list of float, list of float</span>
<span class="sd">            the mean and the square root of the second central moment </span>
<span class="sd">            (generalized standard deviation for arbitrary probability distribution)</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">xx</span><span class="p">,</span><span class="n">stdx</span> <span class="o">=</span> <span class="p">[],[]</span>
            <span class="c1"># get varied fitparams</span>
            <span class="n">pf</span> <span class="o">=</span> <span class="p">[</span><span class="n">pp</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">params</span> <span class="k">if</span> <span class="n">pp</span><span class="o">.</span><span class="n">relRange</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">pnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">params</span> <span class="k">if</span> <span class="n">pp</span><span class="o">.</span><span class="n">relRange</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># p0, lb_main, ub_main = self.params_r(self.targets[-1][&#39;params&#39;])</span>

            <span class="c1"># initialize figure</span>
            <span class="n">nb_params</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span>

            <span class="c1"># get kwargs</span>
            <span class="n">Nres</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Nres&#39;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">Ninteg</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Ninteg&#39;</span><span class="p">,</span><span class="mf">1e5</span><span class="p">)</span>
            <span class="n">full_grid</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;full_grid&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">logscale</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logscale&#39;</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">vmin</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vmin&#39;</span><span class="p">,</span><span class="mf">1e-100</span><span class="p">)</span>
            <span class="n">zoom</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;zoom&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">min_prob</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min_prob&#39;</span><span class="p">,</span><span class="mf">1e-40</span><span class="p">)</span>
            <span class="n">clear_axis</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;clear_axis&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">True_values</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;True_values&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">show_points</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;show_points&#39;</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">savefig</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;savefig&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">figname</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;figname&#39;</span><span class="p">,</span><span class="s1">&#39;posterior&#39;</span><span class="p">)</span>
            <span class="n">figdir</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;figdir&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">res_dir</span><span class="p">)</span>
            <span class="n">figext</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;figext&#39;</span><span class="p">,</span><span class="s1">&#39;.png&#39;</span><span class="p">)</span>
            <span class="n">figsize</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;figsize&#39;</span><span class="p">,(</span><span class="mi">5</span><span class="o">*</span><span class="n">nb_params</span><span class="p">,</span><span class="mi">5</span><span class="o">*</span><span class="n">nb_params</span><span class="p">))</span>
            <span class="n">figdpi</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;figdpi&#39;</span><span class="p">,</span><span class="mi">300</span><span class="p">)</span>
            <span class="n">show_fig</span> <span class="o">=</span> <span class="n">kwargs_posterior</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;show_fig&#39;</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># save parameters to self for later use</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Nres</span> <span class="o">=</span> <span class="n">Nres</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ninteg</span> <span class="o">=</span> <span class="n">Ninteg</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logscale</span> <span class="o">=</span> <span class="n">logscale</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vmin</span> <span class="o">=</span> <span class="n">vmin</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">min_prob</span> <span class="o">=</span> <span class="n">min_prob</span>


            <span class="k">if</span> <span class="n">show_points</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">points</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">nb_params</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">nb_params</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_params</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_params</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="n">j</span><span class="p">:</span> <span class="c1"># plot the 1D posterior on the diagonal</span>
                        <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                            <span class="n">ylabel_pos</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ylabel_pos</span> <span class="o">=</span> <span class="s1">&#39;right&#39;</span>
                        <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="n">nb_params</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="n">xlabel_pos</span> <span class="o">=</span> <span class="s1">&#39;bottom&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">xlabel_pos</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">xmin</span><span class="p">,</span><span class="n">std</span><span class="p">,</span><span class="n">lb_new</span><span class="p">,</span><span class="n">ub_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">marginal_posterior_1D</span><span class="p">(</span><span class="n">pnames</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">pf</span><span class="o">=</span><span class="n">params</span><span class="p">,</span><span class="n">lb</span><span class="o">=</span><span class="n">lb_main</span><span class="p">,</span><span class="n">ub</span><span class="o">=</span><span class="n">ub_main</span><span class="p">,</span><span class="n">beta_scaled</span><span class="o">=</span><span class="n">beta_scaled</span><span class="p">,</span><span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="n">gpr</span><span class="o">=</span><span class="n">gpr</span><span class="p">,</span><span class="n">fscale</span><span class="o">=</span><span class="n">fscale</span><span class="p">,</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">],</span><span class="n">Nres</span><span class="o">=</span><span class="n">Nres</span><span class="p">,</span><span class="n">Ninteg</span><span class="o">=</span><span class="n">Ninteg</span><span class="p">,</span><span class="n">logscale</span><span class="o">=</span><span class="n">logscale</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span><span class="n">show_points</span><span class="o">=</span><span class="n">show_points</span><span class="p">,</span><span class="n">points</span><span class="o">=</span><span class="n">points</span><span class="p">,</span><span class="n">True_values</span><span class="o">=</span><span class="n">True_values</span><span class="p">,</span><span class="n">ylabel_pos</span><span class="o">=</span><span class="n">ylabel_pos</span><span class="p">,</span><span class="n">xlabel_pos</span><span class="o">=</span><span class="n">xlabel_pos</span><span class="p">)</span>
                        <span class="n">xx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xmin</span><span class="p">)</span>
                        <span class="n">stdx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">std</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">i</span><span class="o">&gt;</span><span class="n">j</span><span class="p">:</span> <span class="c1"># plot the 2D posterior on the lower triangle</span>
                        <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                            <span class="n">ylabel_pos</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ylabel_pos</span> <span class="o">=</span> <span class="kc">None</span>

                        <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="n">nb_params</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="n">xlabel_pos</span> <span class="o">=</span> <span class="s1">&#39;bottom&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">xlabel_pos</span> <span class="o">=</span> <span class="kc">None</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">marginal_posterior_2D</span><span class="p">(</span><span class="n">pnames</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">pnames</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">pf</span><span class="o">=</span><span class="n">params</span><span class="p">,</span><span class="n">lb</span><span class="o">=</span><span class="n">lb_main</span><span class="p">,</span><span class="n">ub</span><span class="o">=</span><span class="n">ub_main</span><span class="p">,</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">beta_scaled</span><span class="o">=</span><span class="n">beta_scaled</span><span class="p">,</span><span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="n">gpr</span><span class="o">=</span><span class="n">gpr</span><span class="p">,</span><span class="n">fscale</span><span class="o">=</span><span class="n">fscale</span><span class="p">,</span><span class="n">Nres</span><span class="o">=</span><span class="n">Nres</span><span class="p">,</span><span class="n">Ninteg</span><span class="o">=</span><span class="n">Ninteg</span><span class="p">,</span><span class="n">full_grid</span><span class="o">=</span><span class="n">full_grid</span><span class="p">,</span><span class="n">logscale</span><span class="o">=</span><span class="n">logscale</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span><span class="n">zoom</span><span class="o">=</span><span class="n">zoom</span><span class="p">,</span><span class="n">min_prob</span><span class="o">=</span><span class="n">min_prob</span><span class="p">,</span><span class="n">clear_axis</span><span class="o">=</span><span class="n">clear_axis</span><span class="p">,</span><span class="n">show_points</span><span class="o">=</span><span class="n">show_points</span><span class="p">,</span><span class="n">points</span><span class="o">=</span><span class="n">points</span><span class="p">,</span><span class="n">True_values</span><span class="o">=</span><span class="n">True_values</span><span class="p">,</span><span class="n">ylabel_pos</span><span class="o">=</span><span class="n">ylabel_pos</span><span class="p">,</span><span class="n">xlabel_pos</span><span class="o">=</span><span class="n">xlabel_pos</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span> <span class="c1"># plot the 2D posterior on the upper triangle</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">savefig</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figdir</span><span class="o">+</span><span class="n">figname</span><span class="o">+</span><span class="n">figext</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="n">figdpi</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">show_fig</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">xx</span><span class="p">,</span><span class="n">stdx</span><span class="p">,</span><span class="n">lb_new</span><span class="p">,</span><span class="n">ub_new</span></div>
</div>

<span class="c1">###############################################################################</span>
<span class="c1">####################### Global Stopping Strategies ###########################</span>
<span class="c1">###############################################################################</span>
<span class="c1"># This part is taken from the ax library</span>
<span class="c1"># https://ax.dev/tutorials/gss.html</span>

<div class="viewcode-block" id="SimpleThresholdGlobalStoppingStrategy">
<a class="viewcode-back" href="../../../boar.core.html#boar.core.optimization_botorch.SimpleThresholdGlobalStoppingStrategy">[docs]</a>
<span class="k">class</span> <span class="nc">SimpleThresholdGlobalStoppingStrategy</span><span class="p">(</span><span class="n">BaseGlobalStoppingStrategy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A GSS that stops when we observe a point better than `threshold`.</span>
<span class="sd">    Taken from : https://ax.dev/tutorials/gss.html</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">min_trials</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">inactive_when_pending_trials</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">min_trials</span><span class="o">=</span><span class="n">min_trials</span><span class="p">,</span>
            <span class="n">inactive_when_pending_trials</span><span class="o">=</span><span class="n">inactive_when_pending_trials</span>
        <span class="p">)</span>
    
<div class="viewcode-block" id="SimpleThresholdGlobalStoppingStrategy.should_stop_optimization">
<a class="viewcode-back" href="../../../boar.core.html#boar.core.optimization_botorch.SimpleThresholdGlobalStoppingStrategy.should_stop_optimization">[docs]</a>
    <span class="k">def</span> <span class="nf">should_stop_optimization</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">experiment</span><span class="p">:</span> <span class="n">Experiment</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the best seen is better than `self.threshold`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">feasible_objectives</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">trial</span><span class="o">.</span><span class="n">objective_mean</span>
            <span class="k">for</span> <span class="n">trial</span> <span class="ow">in</span> <span class="n">experiment</span><span class="o">.</span><span class="n">trials_by_status</span><span class="p">[</span><span class="n">TrialStatus</span><span class="o">.</span><span class="n">COMPLETED</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">constraint_satisfaction</span><span class="p">(</span><span class="n">trial</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># Computing the interquartile for scaling the difference</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">feasible_objectives</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;There are not enough feasible arms tried yet.&quot;</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">message</span>
        
        <span class="n">minimize</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">optimization_config</span><span class="o">.</span><span class="n">objective</span><span class="o">.</span><span class="n">minimize</span>
        <span class="k">if</span> <span class="n">minimize</span><span class="p">:</span>
            <span class="n">best</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">feasible_objectives</span><span class="p">)</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">best</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">best</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">feasible_objectives</span><span class="p">)</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">best</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span>

        <span class="n">comparison</span> <span class="o">=</span> <span class="s2">&quot;less&quot;</span> <span class="k">if</span> <span class="n">minimize</span> <span class="k">else</span> <span class="s2">&quot;greater&quot;</span>
        <span class="k">if</span> <span class="n">stop</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The best objective seen is </span><span class="si">{</span><span class="n">best</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, which is </span><span class="si">{</span><span class="n">comparison</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;than the threshold of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">return</span> <span class="n">stop</span><span class="p">,</span> <span class="n">message</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Vincent M. Le Corre, Larry Lüer.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>